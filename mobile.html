<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#08090a">
    <title>DLX Density</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@800&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #08090a; --bg-tile: #1a1d21; --bg-modal: #141619;
            --c-intake: #c084fc; --c-shop: #60a5fa; --c-parts: #fb923c;
            --c-done: #4ade80; --c-ready: #22d3ee; 
            --s-down: #ef4444; --s-warn: #f59e0b; --s-ok: #22c55e;
            --radius: 6px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-body); color: #e8eaed; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        header { padding: 0.6rem 0.8rem; display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); z-index: 10; border-bottom: 1px solid #222; }
        h1 { font-size: 1rem; font-weight: 800; letter-spacing: 1px; }
        .refresh-btn { background: none; border: 1px solid #333; border-radius: 6px; color: #999; padding: 4px 10px; font-weight: 600; font-size: 0.75rem; }

        .view-container { flex: 1; position: relative; overflow: hidden; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 8px; transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); background: var(--bg-body); }
        .view.hidden { transform: translateX(100%); pointer-events: none; }
        .view.active { transform: translateX(0); }

        /* DASHBOARD (Summary View) */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .d-tile { background: var(--bg-tile); border-radius: 8px; padding: 0.8rem; display: flex; flex-direction: column; justify-content: space-between; height: 90px; border: 1px solid #2a2f38; }
        .d-tile:active { background: #22262c; }
        .d-count { font-family: 'JetBrains Mono', monospace; font-size: 2rem; font-weight: 800; line-height: 1; }
        .d-label { font-size: 0.7rem; font-weight: 700; color: #777; text-transform: uppercase; }
        
        .t-intake { border-left: 3px solid var(--c-intake); color: var(--c-intake); }
        .t-ready { border-left: 3px solid var(--c-ready); color: var(--c-ready); }
        .t-shop { border-left: 3px solid var(--c-shop); color: var(--c-shop); }
        .t-parts { border-left: 3px solid var(--c-parts); color: var(--c-parts); }
        .t-done { border-left: 3px solid var(--c-done); color: var(--c-done); }
        .t-add { background: #111; border: 1px dashed #444; align-items: center; justify-content: center; }

        /* MICRO GRID (The requested "Small Tiles") */
        .grid-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #222; }
        .back-btn { background: #2a2f38; border: none; width: 28px; height: 28px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .grid-title { font-size: 0.9rem; font-weight: 800; text-transform: uppercase; }
        
        .vehicle-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); /* 5 COLUMNS = SMALL TILES */
            gap: 4px; 
            padding-bottom: 60px; 
        }

        .v-tile {
            background: #16181b;
            border-radius: var(--radius);
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid #2a2f38;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        .v-tile:active { transform: scale(0.95); background: #222; }
        
        .v-id { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.85rem; 
            font-weight: 800; 
            color: #fff; 
            z-index: 2;
        }

        /* Status Bar (Bottom of tile) */
        .v-status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }
        .s-down .v-status-bar { background: var(--s-down); }
        .s-warn .v-status-bar { background: var(--s-warn); }
        .s-ok .v-status-bar { background: #2a2f38; }

        /* Priority Dot (Top Right) */
        .p-dot { position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; border-radius: 50%; z-index: 3; }
        .p-urgent { background: #ef4444; box-shadow: 0 0 4px #ef4444; }
        .p-high { background: #f59e0b; }
        .p-maint { background: var(--c-ready); }
        
        /* Multi-ticket Count (Top Left) */
        .m-count { 
            position: absolute; top: 2px; left: 2px; 
            font-family: 'JetBrains Mono'; font-size: 0.55rem; 
            color: #888; font-weight: 700; padding: 0 3px;
        }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; padding: 1rem; }
        .modal.open { display: block; animation: fadeIn 0.15s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: var(--bg-modal); border-radius: 12px; height: 100%; display: flex; flex-direction: column; }
        .modal-header { padding: 1rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; overflow-y: auto; padding: 1rem; }
        
        .ticket-card { background: #000; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .btn-action { background: #333; color: #fff; border: 1px solid #444; padding: 8px; width: 100%; border-radius: 6px; font-weight: 700; margin-top: 8px; }

        /* Simple Form (Overlay) */
        .edit-overlay { position: fixed; bottom: 0; left: 0; width: 100%; height: 60%; background: #1a1d21; z-index: 110; transform: translateY(100%); transition: transform 0.3s; padding: 1.5rem; border-radius: 16px 16px 0 0; border-top: 1px solid #444; display: flex; flex-direction: column; }
        .edit-overlay.show { transform: translateY(0); }
        input, select { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; margin-bottom: 12px; font-size: 1rem; }
        .btn-save { background: var(--c-shop); color: #000; padding: 14px; border: none; border-radius: 8px; font-weight: 800; width: 100%; margin-top: auto; }
        .overlay-drag-handle { width: 40px; height: 5px; background: #444; border-radius: 3px; margin: 0 auto 15px auto; }
    </style>
</head>
<body>

    <header>
        <h1>DLX MOBILE</h1>
        <button class="refresh-btn" onclick="fetchSheetData()">Sync</button>
    </header>

    <div class="view-container">
        <div id="view-dash" class="view active">
            <div class="dash-grid">
                <div class="d-tile t-add" onclick="openForm('add')">
                    <div style="font-size:1.5rem;color:#fff">+</div>
                </div>
                <div class="d-tile t-intake" onclick="openGrid('complaints')">
                    <div class="d-count" id="c-complaints">0</div><div class="d-label">Complaints</div>
                </div>
                <div class="d-tile t-ready" onclick="openGrid('ready')">
                    <div class="d-count" id="c-ready">0</div><div class="d-label">Ready</div>
                </div>
                <div class="d-tile t-shop" onclick="openGrid('progress')">
                    <div class="d-count" id="c-progress">0</div><div class="d-label">In Shop</div>
                </div>
                <div class="d-tile t-parts" onclick="openGrid('parts')">
                    <div class="d-count" id="c-parts">0</div><div class="d-label">Parts Hold</div>
                </div>
                <div class="d-tile t-done" onclick="openGrid('returned')">
                    <div class="d-count" id="c-returned">0</div><div class="d-label">Returned</div>
                </div>
            </div>
        </div>

        <div id="view-grid" class="view hidden">
            <div class="grid-header">
                <button class="back-btn" onclick="showDashboard()">←</button>
                <div class="grid-title" id="grid-title-text">TITLE</div>
            </div>
            <div class="vehicle-grid" id="grid-container"></div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-id" style="font-family:'JetBrains Mono';">ID</h2>
                <button class="back-btn" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-body" id="ticket-list"></div>
        </div>
    </div>

    <div id="editOverlay" class="edit-overlay">
        <div class="overlay-drag-handle" onclick="closeEdit()"></div>
        <h3 style="margin-bottom:15px">Move Status</h3>
        <input type="hidden" id="targetRowIndex">
        <select id="vShopStatus">
            <option value="Reported">Reported</option>
            <option value="Ready for Pickup">Ready for Pickup</option>
            <option value="Received">Received</option>
            <option value="Repair in Progress">In Progress</option>
            <option value="Awaiting part order">Parts Hold</option>
            <option value="Complete">Complete</option>
        </select>
        <button class="btn-save" onclick="saveStatus()">UPDATE STATUS</button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVv34BESHIyT_-HohJ-gUc4a2QdQdwHOzEmxFtr1WFxjwV620spd3KnjyHd8If5HSfYQ/exec"; 
        let fleetData = [];
        const COLUMN_STATUSES = { 
            complaints: ["Reported"], 
            ready:      ["Ready for Pickup"],
            parts:      ["Awaiting part order", "Assessment"],
            progress:   ["Received", "Parts Received - Waiting for Technician", "Repair in Progress"], 
            returned:   ["Complete", "Ready for Delivery"] 
        };

        async function fetchSheetData() {
            try {
                const r = await fetch(SCRIPT_URL);
                fleetData = await r.json();
                renderDashboard();
            } catch (e) { console.log("Sync Error"); }
        }

        function statusToCol(s) { 
            for (const [c, sts] of Object.entries(COLUMN_STATUSES)) { if (sts.includes(s)) return c; } 
            return 'complaints'; 
        }

        function showDashboard() {
            document.getElementById('view-grid').classList.add('hidden');
            document.getElementById('view-grid').classList.remove('active');
        }

        function openGrid(cat) {
            document.getElementById('view-grid').classList.remove('hidden');
            document.getElementById('view-grid').classList.add('active');
            const titles = { complaints: "Complaints", ready: "Ready", parts: "Parts Hold", progress: "In Shop", returned: "Completed" };
            document.getElementById('grid-title-text').innerText = titles[cat];
            renderGrid(cat);
        }

        function renderDashboard() {
            const counts = { complaints:0, ready:0, parts:0, progress:0, returned:0 };
            fleetData.forEach(v => {
                const key = statusToCol(v.shopStatus || "Reported");
                if (counts[key] !== undefined) counts[key]++;
            });
            ['complaints','ready','parts','progress','returned'].forEach(k => {
                document.getElementById('c-'+k).innerText = counts[k];
            });
        }

        function renderGrid(category) {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            
            const merged = {};
            fleetData.forEach(v => {
                const key = statusToCol(v.shopStatus || "Reported");
                if (key !== category) return;
                const id = v.id.trim().toUpperCase();
                if (!merged[id]) merged[id] = { ...v, tickets: [] };
                merged[id].tickets.push(v);
                
                if (v.priority === 'Urgent') merged[id].priority = 'Urgent';
                else if (v.priority === 'High' && merged[id].priority !== 'Urgent') merged[id].priority = 'High';
                
                if (v.status === 'Down') merged[id].status = 'Down';
                else if (v.status === 'Warning' && merged[id].status !== 'Down') merged[id].status = 'Warning';
            });

            const sorted = Object.values(merged).sort((a,b) => (a.id > b.id) ? 1 : -1);

            sorted.forEach(v => {
                let statusClass = 's-ok';
                if (v.status === 'Down') statusClass = 's-down';
                else if (v.status === 'Warning') statusClass = 's-warn';

                let dotHtml = '';
                if (v.priority === 'Urgent') dotHtml = '<div class="p-dot p-urgent"></div>';
                else if (v.priority === 'High') dotHtml = '<div class="p-dot p-high"></div>';
                else if (v.priority === 'Oil Change / Bulb Replacement') dotHtml = '<div class="p-dot p-maint"></div>';
                
                let multiCount = v.tickets.length > 1 ? `<div class="m-count">${v.tickets.length}</div>` : '';

                const tile = document.createElement('div');
                tile.className = `v-tile ${statusClass}`;
                tile.innerHTML = `
                    ${dotHtml}${multiCount}
                    <div class="v-id">${v.id}</div>
                    <div class="v-status-bar"></div>
                `;
                tile.onclick = () => openDetail(v);
                container.appendChild(tile);
            });
        }

        function openDetail(mergedVeh) {
            document.getElementById('detailModal').classList.add('open');
            document.getElementById('modal-id').innerText = mergedVeh.id;
            const list = document.getElementById('ticket-list');
            list.innerHTML = '';

            mergedVeh.tickets.forEach(t => {
                const card = document.createElement('div');
                card.className = 'ticket-card';
                card.innerHTML = `
                    <h3 style="color:#fff;font-size:0.9rem;margin-bottom:4px">${t.issue}</h3>
                    <div style="font-size:0.75rem;color:#888;margin-bottom:8px">${t.date} • ${t.shopStatus}</div>
                    <button class="btn-action" onclick="openEdit(${t.rowIndex}, '${t.shopStatus}')">MOVE STATUS</button>
                `;
                list.appendChild(card);
            });
        }

        function openEdit(ri, currentStatus) {
            document.getElementById('editOverlay').classList.add('show');
            document.getElementById('targetRowIndex').value = ri;
            document.getElementById('vShopStatus').value = currentStatus;
        }

        function closeEdit() {
            document.getElementById('editOverlay').classList.remove('show');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('open');
            closeEdit();
        }

        function saveStatus() {
            const btn = document.querySelector('.btn-save');
            btn.innerText = "UPDATING...";
            const ri = document.getElementById('targetRowIndex').value;
            const ns = document.getElementById('vShopStatus').value;
            
            // We need full object to update safely, simplified here for speed
            // In production, you'd fetch the specific row or pass full data
            const v = fleetData.find(f => f.rowIndex == ri);
            if(v) {
                const p = { 
                    action: 'update', rowIndex: ri, id: v.id, status: v.status, 
                    issue: v.issue, date: v.date, shopStatus: ns, location: v.location, 
                    priority: v.priority, notes: v.notes, homeLocation: v.homeLocation,
                    partsOrdered: v.partsOrdered, partsEta: v.partsEta
                };
                fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(p) }).then(() => {
                    closeModal();
                    btn.innerText = "UPDATE STATUS";
                    alert("Updated");
                    fetchSheetData();
                });
            }
        }
        
        function openForm(mode) {
             if(mode === 'add') {
                 const id = prompt("Vehicle ID:");
                 if(id) {
                     const issue = prompt("Issue:");
                     if(issue) {
                         const p = { action:'add', id:id, issue:issue, date: new Date().toISOString().split('T')[0], status:'Operational', shopStatus:'Reported', priority:'Normal' };
                         fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(p) }).then(() => { alert("Added!"); fetchSheetData(); });
                     }
                 }
             }
        }

        fetchSheetData();
    </script>
</body>
</html>