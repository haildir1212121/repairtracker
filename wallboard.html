<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Repair Wallboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;800&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <style>
        /* ===== CORE VARIABLES ===== */
        :root {
            --bg-app: #111111;
            --bg-header: #161616;
            --bg-card: #232323;
            --bg-card-hover: #2a2a2a;

            --text-main: #ededed;
            --text-muted: #8b8b8b;
            --border: #2c2c2c;

            --status-operational: #4ade80;
            --status-warning: #f97316;
            --status-down: #ef4444;

            --c-urgent: #ef4444;
            --c-high: #f97316;
            --c-normal: #3b82f6;
            --c-maint: #a855f7;
            --c-ready: #22d3ee;

            --radius-lg: 12px;
            --radius-md: 8px;
            --transition: 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Outfit', 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ===== HEADER ===== */
        .wallboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            gap: 2rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            transition: background 0.3s;
        }

        .status-indicator.connected {
            background: #4ade80;
            box-shadow: 0 0 8px #4ade80;
        }

        .status-indicator.loading {
            background: #f97316;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.6rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            border-color: #444;
        }

        /* ===== SETTINGS PANEL ===== */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-header);
            border-left: 1px solid var(--border);
            padding: 2rem;
            overflow-y: auto;
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .settings-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-btn:hover {
            color: var(--text-main);
        }

        .pref-section {
            margin-bottom: 2rem;
        }

        .pref-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .pref-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.6rem 0;
            cursor: pointer;
        }

        .pref-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--c-ready);
        }

        .pref-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* ===== MAIN CONTENT ===== */
        .wallboard-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .vehicle-grid {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            overflow-x: hidden;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            align-content: flex-start;
        }

        /* ===== VEHICLE CARDS ===== */
        .vehicle-card {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            transition: all 0.3s;
            min-height: 200px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .vehicle-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Status-based background colors */
        .vehicle-card.status-operational {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, var(--bg-card) 100%);
            border-color: rgba(74, 222, 128, 0.3);
        }

        .vehicle-card.status-operational:hover {
            border-color: rgba(74, 222, 128, 0.6);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }

        .vehicle-card.status-warning {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, var(--bg-card) 100%);
            border-color: rgba(249, 115, 22, 0.3);
        }

        .vehicle-card.status-warning:hover {
            border-color: rgba(249, 115, 22, 0.6);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.2);
        }

        .vehicle-card.status-down {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-card) 100%);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .vehicle-card.status-down:hover {
            border-color: rgba(239, 68, 68, 0.8);
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .card-id {
            font-size: 1.4rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            flex-grow: 1;
        }

        .card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge-urgent { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .badge-high { background: rgba(249, 115, 22, 0.2); color: #fdba74; }
        .badge-maint { background: rgba(168, 85, 247, 0.2); color: #d8b4fe; }
        .badge-normal { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }

        .badge-vehicle {
            background: rgba(96, 165, 250, 0.15);
            color: #93c5fd;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .card-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.operational { background: var(--status-operational); box-shadow: 0 0 6px var(--status-operational); }
        .status-dot.warning { background: var(--status-warning); box-shadow: 0 0 6px var(--status-warning); }
        .status-dot.down { background: var(--status-down); box-shadow: 0 0 6px var(--status-down); }

        .card-detail {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
        }

        .card-detail-label {
            font-weight: 500;
            color: #666;
        }

        .card-detail-value {
            font-weight: 600;
            color: var(--text-main);
            text-align: right;
            max-width: 50%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card-issue {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-sm);
            margin-top: auto;
            border-left: 3px solid var(--c-high);
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 0.8rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .days-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .days-badge.warn {
            background: rgba(249, 115, 22, 0.2);
            color: #fdba74;
        }

        .days-badge.critical {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            gap: 1rem;
        }

        .empty-state-icon {
            font-size: 3rem;
            opacity: 0.3;
        }

        /* ===== FULLSCREEN MODE ===== */
        body.fullscreen {
            overflow: hidden;
        }

        body.fullscreen .wallboard-header {
            display: none;
        }

        body.fullscreen .vehicle-grid {
            padding: 2rem;
        }

        .fullscreen-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 500;
        }

        body:not(.fullscreen) .fullscreen-indicator:hover {
            opacity: 1;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text-main);
            color: #000;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            z-index: 2000;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards;
        }

        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .vehicle-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .wallboard-header {
                padding: 1rem;
                gap: 1rem;
            }

            .header-title {
                font-size: 1.4rem;
            }

            .vehicle-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                padding: 1rem;
                gap: 1rem;
            }

            .settings-panel {
                width: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="wallboard-header">
        <div class="header-left">
            <h1 class="header-title">FLEET WALLBOARD</h1>
            <div class="connection-status">
                <div class="status-indicator loading" id="statusIndicator"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
        <div class="header-controls">
            <button class="btn-icon" onclick="toggleSettings()" title="Display Settings">
                <span>‚öôÔ∏è</span> Settings
            </button>
            <button class="btn-icon" onclick="toggleTheme()" title="Toggle Theme">
                <span id="themeIcon">üåô</span>
            </button>
            <button class="btn-icon" onclick="toggleFullscreen()" title="Press F to toggle">
                <span>üñ•Ô∏è</span> Fullscreen
            </button>
        </div>
    </header>

    <!-- SETTINGS PANEL -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>Display Settings</h2>
            <button class="close-btn" onclick="toggleSettings()">‚úï</button>
        </div>

        <div class="pref-section">
            <div class="pref-title">Vehicle Fields</div>
            <div class="pref-item">
                <input type="checkbox" id="pref-issue" checked onchange="savePreferences()">
                <label for="pref-issue">Current Issue</label>
            </div>
            <div class="pref-item">
                <input type="checkbox" id="pref-location" checked onchange="savePreferences()">
                <label for="pref-location">Location</label>
            </div>
            <div class="pref-item">
                <input type="checkbox" id="pref-technician" onchange="savePreferences()">
                <label for="pref-technician">Assigned Technician</label>
            </div>
            <div class="pref-item">
                <input type="checkbox" id="pref-parts" checked onchange="savePreferences()">
                <label for="pref-parts">Parts Status</label>
            </div>
            <div class="pref-item">
                <input type="checkbox" id="pref-days" checked onchange="savePreferences()">
                <label for="pref-days">Days in Shop</label>
            </div>
            <div class="pref-item">
                <input type="checkbox" id="pref-home-location" onchange="savePreferences()">
                <label for="pref-home-location">Home Location</label>
            </div>
        </div>

        <div class="pref-section">
            <div class="pref-title">Display Filters</div>
            <div class="pref-item">
                <input type="checkbox" id="filter-operational" checked onchange="savePreferences()">
                <label for="filter-operational">Operational Vehicles</label>
            </div>
            <div class="pref-item">
                <input type="checkbox" id="filter-warning" checked onchange="savePreferences()">
                <label for="filter-warning">Warning Status</label>
            </div>
            <div class="pref-item">
                <input type="checkbox" id="filter-down" checked onchange="savePreferences()">
                <label for="filter-down">Down for Repair</label>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="wallboard-content">
        <div class="vehicle-grid" id="vehicleGrid">
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <p>Loading fleet data...</p>
            </div>
        </div>
    </main>

    <!-- FULLSCREEN INDICATOR -->
    <div class="fullscreen-indicator">
        Press F to toggle fullscreen
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCnH_ILuDyJB1mC0iBlrfYIAFVumD74yo4",
            authDomain: "dlx-dmt-tracker.firebaseapp.com",
            projectId: "dlx-dmt-tracker",
            storageBucket: "dlx-dmt-tracker.firebasestorage.app",
            messagingSenderId: "958627003202",
            appId: "1:958627003202:web:07ea8476831ef49e4ea6db"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ===== STATE =====
        let fleetData = [];
        let unsubscribe = null;
        let isConnected = false;

        let displayPrefs = {
            fields: {
                issue: true,
                location: true,
                technician: false,
                parts: true,
                days: true,
                homeLocation: false
            },
            filters: {
                operational: true,
                warning: true,
                down: true
            }
        };

        let currentTheme = localStorage.getItem('wallboard-theme') || 'dark';

        // ===== INITIALIZATION =====
        async function initializeWallboard() {
            // Apply saved theme
            applyTheme();

            // Load preferences
            loadPreferences();

            // Check auth
            auth.onAuthStateChanged(user => {
                if (user) {
                    startRealtimeListener();
                } else {
                    // Redirect to beta.html for login
                    window.location.href = 'beta.html';
                }
            });
        }

        // ===== REALTIME FIREBASE LISTENER =====
        function startRealtimeListener() {
            if (unsubscribe) unsubscribe();

            setStatus('loading', 'Connecting to data...');

            unsubscribe = db.collection('vehicles')
                .onSnapshot(
                    snapshot => {
                        fleetData = snapshot.docs.map(doc => ({
                            docId: doc.id,
                            ...doc.data()
                        }));

                        renderVehicleGrid();
                        setStatus('connected', 'Live');
                    },
                    error => {
                        console.error('Firebase error:', error);
                        setStatus('error', 'Connection Error');
                        showToast('‚ùå Connection lost - retrying...');
                    }
                );
        }

        // ===== RENDERING =====
        function renderVehicleGrid() {
            const grid = document.getElementById('vehicleGrid');
            const vehicles = getFilteredVehicles();

            if (vehicles.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No vehicles to display</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = vehicles.map(v => createVehicleCardHTML(v)).join('');
        }

        function createVehicleCardHTML(vehicle) {
            const status = vehicle.status || 'Operational';
            const priority = vehicle.priority || 'Normal';
            const daysInShop = calculateDaysInShop(vehicle.date);
            const partsStatus = getPartsStatus(vehicle);

            const statusClass = `status-${status.toLowerCase()}`;
            const priorityBadgeClass = `badge-${priority.toLowerCase().replace(/\s+/g, '-')}`;

            let html = `
                <div class="vehicle-card ${statusClass}">
                    <div class="card-header">
                        <div class="card-id">${vehicle.id || 'N/A'}</div>
                        <div class="card-badges">
                            ${priority && priority !== 'Normal' ? `<span class="badge ${priorityBadgeClass}">${priority}</span>` : ''}
                            ${vehicle.vehicleType ? `<span class="badge badge-vehicle">${vehicle.vehicleType}</span>` : ''}
                        </div>
                    </div>

                    <div class="card-status">
                        <div class="status-dot ${getStatusDot(status)}"></div>
                        <span>${status}</span>
                    </div>
            `;

            // Shop Status
            if (vehicle.shopStatus) {
                html += `<div class="card-detail">
                    <span class="card-detail-label">Status:</span>
                    <span class="card-detail-value">${vehicle.shopStatus}</span>
                </div>`;
            }

            // Current Issue
            if (displayPrefs.fields.issue && vehicle.issue) {
                html += `<div class="card-issue">${vehicle.issue}</div>`;
            }

            // Location
            if (displayPrefs.fields.location && vehicle.location) {
                html += `<div class="card-detail">
                    <span class="card-detail-label">Location:</span>
                    <span class="card-detail-value">${vehicle.location}</span>
                </div>`;
            }

            // Home Location
            if (displayPrefs.fields.homeLocation && vehicle.homeLocation) {
                html += `<div class="card-detail">
                    <span class="card-detail-label">Home:</span>
                    <span class="card-detail-value">${vehicle.homeLocation}</span>
                </div>`;
            }

            // Parts Status
            if (displayPrefs.fields.parts && partsStatus) {
                html += `<div class="card-detail">
                    <span class="card-detail-label">Parts:</span>
                    <span class="card-detail-value">${partsStatus}</span>
                </div>`;
            }

            // Days in Shop
            if (displayPrefs.fields.days && daysInShop !== null) {
                const daysClass = daysInShop >= 14 ? 'critical' : daysInShop >= 7 ? 'warn' : '';
                html += `<div class="card-footer">
                    <span class="days-badge ${daysClass}">${daysInShop} days in shop</span>
                </div>`;
            }

            html += `</div>`;
            return html;
        }

        // ===== HELPER FUNCTIONS =====
        function getFilteredVehicles() {
            return fleetData.filter(v => {
                // Apply status filters
                const status = (v.status || 'Operational').toLowerCase();

                if (status === 'operational' && !displayPrefs.filters.operational) return false;
                if (status === 'warning' && !displayPrefs.filters.warning) return false;
                if (status === 'down' && !displayPrefs.filters.down) return false;

                return true;
            }).sort((a, b) => {
                // Sort by priority, then by days in shop
                const priorityOrder = { 'Urgent': 0, 'High': 1, 'Maint': 2, 'Normal': 3 };
                const aPriority = priorityOrder[a.priority] ?? 999;
                const bPriority = priorityOrder[b.priority] ?? 999;

                if (aPriority !== bPriority) return aPriority - bPriority;

                const aDays = calculateDaysInShop(a.date) ?? -1;
                const bDays = calculateDaysInShop(b.date) ?? -1;
                return bDays - aDays;
            });
        }

        function calculateDaysInShop(dateStr) {
            if (!dateStr) return null;
            try {
                const start = new Date(dateStr);
                const now = new Date();
                const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));
                return Math.max(0, days);
            } catch (e) {
                return null;
            }
        }

        function getStatusDot(status) {
            const s = (status || '').toLowerCase();
            if (s === 'down') return 'down';
            if (s === 'warning') return 'warning';
            return 'operational';
        }

        function getPartsStatus(vehicle) {
            if (vehicle.partsOrdered && vehicle.partsEta) {
                return `On order (${vehicle.partsEta})`;
            } else if (vehicle.partsOrdered) {
                return 'On order';
            } else if (vehicle.shopStatus && vehicle.shopStatus.includes('Parts')) {
                return 'Parts status pending';
            }
            return null;
        }

        // ===== UI CONTROLS =====
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('wallboard-theme', currentTheme);
            applyTheme();
        }

        function applyTheme() {
            const isDark = currentTheme === 'dark';
            document.documentElement.style.colorScheme = currentTheme;
            document.getElementById('themeIcon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';

            if (isDark) {
                document.body.style.setProperty('--bg-app', '#111111');
                document.body.style.setProperty('--bg-header', '#161616');
                document.body.style.setProperty('--bg-card', '#232323');
                document.body.style.setProperty('--text-main', '#ededed');
                document.body.style.setProperty('--text-muted', '#8b8b8b');
                document.body.style.setProperty('--border', '#2c2c2c');
            } else {
                document.body.style.setProperty('--bg-app', '#f5f5f5');
                document.body.style.setProperty('--bg-header', '#ffffff');
                document.body.style.setProperty('--bg-card', '#ffffff');
                document.body.style.setProperty('--text-main', '#1a1a1a');
                document.body.style.setProperty('--text-muted', '#666666');
                document.body.style.setProperty('--border', '#e0e0e0');
            }
        }

        function toggleFullscreen() {
            document.body.classList.toggle('fullscreen');
            const elem = document.documentElement;
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(() => {
                    // Fullscreen API not available, just toggle CSS class
                });
            } else {
                document.exitFullscreen();
            }
        }

        // ===== PREFERENCES =====
        function savePreferences() {
            displayPrefs.fields.issue = document.getElementById('pref-issue').checked;
            displayPrefs.fields.location = document.getElementById('pref-location').checked;
            displayPrefs.fields.technician = document.getElementById('pref-technician').checked;
            displayPrefs.fields.parts = document.getElementById('pref-parts').checked;
            displayPrefs.fields.days = document.getElementById('pref-days').checked;
            displayPrefs.fields.homeLocation = document.getElementById('pref-home-location').checked;

            displayPrefs.filters.operational = document.getElementById('filter-operational').checked;
            displayPrefs.filters.warning = document.getElementById('filter-warning').checked;
            displayPrefs.filters.down = document.getElementById('filter-down').checked;

            localStorage.setItem('wallboard-prefs', JSON.stringify(displayPrefs));
            renderVehicleGrid();
        }

        function loadPreferences() {
            const saved = localStorage.getItem('wallboard-prefs');
            if (saved) {
                try {
                    displayPrefs = JSON.parse(saved);
                } catch (e) {}
            }

            // Apply to UI
            document.getElementById('pref-issue').checked = displayPrefs.fields.issue;
            document.getElementById('pref-location').checked = displayPrefs.fields.location;
            document.getElementById('pref-technician').checked = displayPrefs.fields.technician;
            document.getElementById('pref-parts').checked = displayPrefs.fields.parts;
            document.getElementById('pref-days').checked = displayPrefs.fields.days;
            document.getElementById('pref-home-location').checked = displayPrefs.fields.homeLocation;

            document.getElementById('filter-operational').checked = displayPrefs.filters.operational;
            document.getElementById('filter-warning').checked = displayPrefs.filters.warning;
            document.getElementById('filter-down').checked = displayPrefs.filters.down;
        }

        // ===== STATUS & NOTIFICATIONS =====
        function setStatus(state, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            indicator.className = `status-indicator ${state}`;
            statusText.textContent = text;

            isConnected = state === 'connected';
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', e => {
            if (e.key === 'f' || e.key === 'F') {
                if (e.ctrlKey || e.metaKey) return; // Don't interfere with browser shortcuts
                toggleFullscreen();
            }
            if (e.key === 'Escape') {
                if (document.getElementById('settingsPanel').classList.contains('open')) {
                    toggleSettings();
                }
            }
        });

        // ===== STARTUP =====
        document.addEventListener('DOMContentLoaded', initializeWallboard);

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) unsubscribe();
        });
    </script>
</body>
</html>
