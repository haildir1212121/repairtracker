<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair Terminal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;800&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ===== CORE VARIABLES ===== */
        :root {
            --bg-app: #111111;
            --bg-sidebar: #161616;
            --bg-board: #161616;
            --bg-card: #232323;
            --bg-card-hover: #2a2a2a;
            
            --text-main: #ededed;
            --text-muted: #8b8b8b;
            --border: #2c2c2c;
            --border-hover: #3d3d3d;
            
            --accent: #4ade80;
            --c-urgent: #ef4444; 
            --c-high: #f97316;   
            --c-normal: #3b82f6; 
            --c-maint: #a855f7;  
            
            --c-intake: #c084fc; 
            --c-shop: #60a5fa; 
            --c-parts: #fb923c; 
            --c-done: #4ade80; 
            --c-ready: #22d3ee;
            --c-road: #a78bfa;

            --radius-lg: 12px;
            --radius-md: 8px;
            --radius-sm: 6px;
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.6);
            --transition: 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', 'Outfit', sans-serif; background-color: var(--bg-app); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* Global Drag State to prevent flickering */
        body.is-dragging * { pointer-events: none; }
        body.is-dragging .kanban-column { pointer-events: auto; }

        /* ===== LAYOUT & SIDEBAR ===== */
        .main-content { display: none; flex-direction: row; height: 100vh; width: 100vw; }
        .main-content.active { display: flex; }

        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem 0; flex-shrink: 0; }
        .sidebar-header { display: flex; align-items: center; padding: 0 1.5rem; gap: 0.8rem; margin-bottom: 1.5rem; }
        .logo-icon { background: var(--accent); color: #000; font-weight: 900; padding: 0.3rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-family: 'Outfit', sans-serif;}
        .sidebar h2 { font-size: 0.9rem; font-weight: 700; font-family: 'Outfit', sans-serif; letter-spacing: 1px; flex-grow: 1; }
        
        .sidebar-search { margin: 0 1.5rem 1.5rem; background: #000; border: 1px solid var(--border); border-radius: var(--radius-sm); display: flex; align-items: center; padding: 0.5rem 0.8rem; }
        .sidebar-search input { background: transparent; border: none; color: var(--text-main); width: 100%; margin-left: 0.5rem; font-size: 0.85rem; font-family: 'Inter', sans-serif;}
        .sidebar-search input:focus { outline: none; }

        .sidebar-nav { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.2rem;}
        .nav-item { display: flex; align-items: center; padding: 0.6rem 1.5rem; color: var(--text-muted); text-decoration: none; font-size: 0.85rem; font-weight: 500; gap: 0.8rem; transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer;}
        .nav-item:hover { background: rgba(255,255,255,0.03); color: var(--text-main); }
        .nav-item.active { background: rgba(255,255,255,0.05); color: var(--text-main); border-left-color: var(--text-main); }
        .nav-item.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        
        .nav-submenu { display: flex; flex-direction: column; gap: 2px; }
        .submenu-item { padding: 0.5rem 1.5rem 0.5rem 2.8rem; font-size: 0.8rem; color: var(--text-muted); cursor: pointer; transition: color 0.2s; text-decoration: none; display: block; }
        .submenu-item:hover { color: var(--text-main); background: rgba(255,255,255,0.02); }
        .submenu-item.active { color: var(--accent); font-weight: 600; }
        .submenu-label { padding: 0 1.5rem; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 0.7rem; text-transform: uppercase; color: #555; font-weight: 700; letter-spacing: 0.5px; }

        .sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); margin-top: auto;}
        .user-profile { background: transparent; border: none; display: flex; align-items: center; gap: 0.8rem; color: var(--text-muted); cursor: pointer; width: 100%; transition: color 0.2s;}
        .user-profile:hover { color: var(--text-main); }
        .avatar { width: 24px; height: 24px; background: #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #fff; font-weight: 600;}

        /* ===== VIEWS & CRISP FILTERS ===== */
        .view-area { display: none; flex-direction: column; flex-grow: 1; overflow: hidden; background: var(--bg-board); }
        .view-area.active { display: flex; }

        .board-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); flex-shrink: 0;}
        .board-header h1 { font-family: 'Outfit', sans-serif; font-size: 1.2rem; font-weight: 600; color: var(--text-main); }
        
        .board-filters { display: flex; gap: 0.6rem; align-items: center; }
        .filter-btn { 
            background: #111; 
            border: 1px solid var(--border); 
            color: var(--text-muted); 
            font-size: 0.75rem; 
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 0.4rem; 
            padding: 0.5rem 0.8rem; 
            border-radius: 6px; 
            transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filter-btn:hover:not(:disabled) { 
            color: var(--text-main); 
            border-color: #555;
            background: #1a1a1a;
            transform: translateY(-1px);
        }
        .filter-btn.active { 
            background: var(--c-shop); 
            color: #000; 
            border-color: var(--c-shop); 
            box-shadow: 0 0 12px rgba(96,165,250,0.3);
        }
        .filter-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }

        /* ===== KANBAN ===== */
        .kanban-board { flex: 1; display: flex; gap: 1.2rem; overflow-x: auto; overflow-y: hidden; padding: 1.5rem 2rem; }
        .kanban-column { display: flex; flex-direction: column; height: 100%; min-width: 320px; width: 320px; flex-shrink: 0; transition: background 0.2s, box-shadow 0.2s; border-radius: var(--radius-lg); border: 2px solid transparent;}
        
        .kanban-column.drag-over-column { background: rgba(255,255,255,0.02); border-color: var(--border-hover); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        
        .column-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.5rem 1rem 0.5rem; flex-shrink: 0; pointer-events: none; }
        .col-header-left { display: flex; align-items: center; gap: 0.6rem; font-size: 0.9rem; font-weight: 600; color: var(--text-main); font-family: 'Outfit', sans-serif;}
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; box-shadow: 0 0 8px currentColor; }
        .column-count { color: #666; font-size: 0.85rem; font-weight: 500; margin-left: 0.2rem;}
        
        .column-content { flex: 1; overflow-y: auto; padding: 0 0.5rem 1rem 0.5rem; scrollbar-width: none; }
        .column-content::-webkit-scrollbar { display: none; }

        /* ===== SLEEK VEHICLE CARDS (Click to Collapse) ===== */
        .vehicle-card { background: var(--bg-card); border: 1px solid transparent; border-left: 3px solid transparent; border-radius: var(--radius-md); padding: 1rem; margin-bottom: 0.8rem; display: flex; flex-direction: column; transition: all var(--transition); cursor: pointer; overflow: hidden; }
        .vehicle-card:hover { background: var(--bg-card-hover); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: #333;}
        .vehicle-card.dragging { opacity: 0.4; border: 1px dashed #666; transform: scale(0.95); }

        .prio-Urgent { border-left-color: var(--c-urgent); box-shadow: inset 16px 0 20px -16px rgba(239, 68, 68, 0.2); }
        .prio-High { border-left-color: var(--c-high); }
        .prio-Normal { border-left-color: var(--border); }
        .prio-Maint { border-left-color: var(--c-maint); }

        .vehicle-card.inspect-warn { border-color: rgba(251, 146, 60, 0.6); box-shadow: 0 4px 15px rgba(251, 146, 60, 0.15); }
        .vehicle-card.inspect-warn:hover { border-color: rgba(251, 146, 60, 1); box-shadow: 0 6px 20px rgba(251, 146, 60, 0.25); }
        .vehicle-card.inspect-crit { border-color: rgba(239, 68, 68, 0.8); box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3); }
        .vehicle-card.inspect-crit:hover { border-color: rgba(239, 68, 68, 1); box-shadow: 0 6px 25px rgba(239, 68, 68, 0.4); }

        .card-header-main { font-size: 1.15rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 0.5rem; pointer-events: none;}
        .card-req-by { font-size: .95rem; font-weight: 600; color:var(--text-main);  display: flex; justify-content: space-between; align-items: center;  flex: 1;}
        .card-avatar { width: 22px; height: 22px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: #ddd; font-weight: 700; border: 1px solid #444;}
        
        .collapse-indicator { display: flex; align-items: center; justify-content: center; opacity: 1; pointer-events: auto; padding: 0.2rem; border-radius: 4px; transition: background 0.2s;}
        .collapse-indicator:hover { background: rgba(255,255,255,0.08); }
        .collapse-indicator svg { width: 18px; height: 18px; color: var(--text-main); transition: transform var(--transition); transform: rotate(0deg); }
        .vehicle-card.collapsed .collapse-indicator svg { transform: rotate(-90deg); color: var(--text-muted); }

        .card-body-wrapper { display: grid; grid-template-rows: 1fr; transition: grid-template-rows var(--transition); pointer-events: none;}
        .vehicle-card.collapsed .card-body-wrapper { grid-template-rows: 0fr; }

        .card-body { overflow: hidden; display: flex; flex-direction: column; gap: 0.8rem; opacity: 1; padding-top: 0.8rem; transition: opacity 0.2s ease, padding-top var(--transition); }
        .vehicle-card.collapsed .card-body { opacity: 0; padding-top: 0; }

        .card-title { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); line-height: 1.4; }
        .card-footer-row { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .card-meta-tag { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 4px; background: rgba(255,255,255,0.03); color: var(--text-muted); }
        
        .card-progress-container { display: flex; gap: 2px; height: 3px; width: 100%; margin-top: auto; opacity: 0.6; }
        .progress-seg { flex: 1; background: #333; border-radius: 2px; }
        .progress-seg.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .progress-seg.active-warn { background: var(--c-parts); }

        /* ===== DATABASE / USERS TABLE ===== */
        .db-container { padding: 1.5rem 2rem; overflow-y: auto; flex: 1; }
        .db-table { width: 100%; border-collapse: collapse; text-align: left; }
        .db-table th { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; background: var(--bg-board); z-index: 10; }
        .db-table td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); font-size: 0.85rem; }
        .db-table tr { cursor: pointer; transition: background 0.2s; }
        .db-table tr:hover { background: rgba(255,255,255,0.02); }
        .db-badge { padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.05); }
        
        .role-select { background: #111; color: var(--text-main); border: 1px solid var(--border); padding: 0.3rem; border-radius: 4px; font-size: 0.8rem; }

        /* ===== MODALS & FORMS ===== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-sidebar); padding: 2rem; border-radius: var(--radius-lg); width: 90%; max-width: 550px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
        .modal-content::-webkit-scrollbar { width: 6px; } .modal-content::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .modal-content h2 { font-family: 'Outfit', sans-serif; font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--text-main); }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;}
        .form-group { margin-bottom: 1rem; }
        label { display: block; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.4rem; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 0.8rem; background-color: #000; border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm); font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        input:focus, select:focus, textarea:focus { border-color: var(--c-shop); outline: none; }
        input::-webkit-calendar-picker-indicator { display: none !important; }
        input:disabled, select:disabled, textarea:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-primary { background: var(--text-main); color: #000; padding: 0.8rem 1.5rem; border: none; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .btn-primary:hover:not(:disabled) { background: #fff; transform: translateY(-1px); }
        .btn-outline { background: transparent; color: var(--text-main); padding: 0.8rem 1.5rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-weight: 500; cursor: pointer; transition: background 0.2s; }
        .btn-outline:hover { background: rgba(255,255,255,0.05); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.8rem 1.5rem; border-radius: var(--radius-sm); cursor: pointer; transition: background 0.2s; }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

        .history-section { margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1.5rem; }
        .history-title { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; display: flex; justify-content: space-between; font-weight: 600; }
        .history-list { max-height: 120px; overflow-y: auto; background: #000; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.8rem; font-size: 0.8rem; }
        .history-item { display: flex; gap: 0.8rem; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .history-item:last-child { border-bottom: none; }

        /* Login & Toasts */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-container { background: var(--bg-card); border: 1px solid var(--border); padding: 3rem; border-radius: var(--radius-lg); width: 100%; max-width: 400px; text-align: center; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--text-main); color: #000; padding: 0.8rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.85rem; box-shadow: var(--shadow-lg); z-index: 200; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards; }
        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }
    </style>
</head>
<body>

    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <h2 style="font-family:'Outfit'; margin-bottom:0.5rem;">REPAIR TERMINAL</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem; font-size:0.9rem;">Authorized Access Only</p>
            <div id="loginError" style="color:#f87171; font-size:0.8rem; margin-bottom:1rem;"></div>
            
            <div id="loginFormDiv" style="display:flex; flex-direction:column; gap:1rem;">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button class="btn-primary" onclick="handleLogin()">Enter Terminal</button>
                <button class="btn-outline" style="border:none; padding:0; font-size:0.8rem; color:var(--text-muted);" onclick="toggleLoginSignup()">Need an account? Request Access</button>
            </div>

            <div id="signupFormDiv" style="display:none; flex-direction:column; gap:1rem;">
                <input type="email" id="signupEmail" placeholder="Email address">
                <input type="password" id="signupPassword" placeholder="Create Password (min 6 chars)">
                <input type="password" id="signupPasswordConfirm" placeholder="Confirm Password">
                <button class="btn-primary" onclick="handleSignup()">Create Account</button>
                <button class="btn-outline" style="border:none; padding:0; font-size:0.8rem; color:var(--text-muted);" onclick="toggleLoginSignup()">Already have access? Sign In</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">RT</div>
                <h2>REPAIR TERMINAL</h2>
            </div>
            
            <div class="sidebar-search">
                <span style="opacity: 0.5;">üîç</span>
                <input type="text" id="searchInput" placeholder="Search..." onkeyup="renderCurrentView()">
            </div>

            <nav class="sidebar-nav">
                <a class="nav-item active" id="nav-workboard" onclick="switchView('workboard')">
                    <span class="icon">üìã</span> Workboard
                </a>
                <a class="nav-item" id="nav-database" onclick="switchView('database')">
                    <span class="icon">üóÑÔ∏è</span> Vehicle Database
                </a>
                <a class="nav-item" id="nav-add-unit" onclick="openModal('add')">
                    <span class="icon">‚ûï</span> Add Unit
                </a>

                <div class="nav-section">
                    <div class="submenu-label">HOME LOCATIONS</div>
                    <div id="locationSubmenu" class="nav-submenu">
                        </div>
                </div>

                <div class="nav-section">
                    <div class="submenu-label">SYSTEM</div>
                    <a class="nav-item" id="nav-users" onclick="switchView('users')" style="display:none;">
                        <span class="icon">üë•</span> User Management
                    </a>
                    <a class="nav-item" onclick="handleLogout()"><span class="icon">üö™</span> Logout</a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <button class="user-profile">
                    <div class="avatar" id="userAvatar">U</div>
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span id="displayUserEmail" style="font-size:0.8rem; font-weight:600;">User</span>
                        <span id="displayUserRole" style="font-size:0.6rem; text-transform:uppercase; color:var(--accent);">Role</span>
                    </div>
                </button>
            </div>
        </aside>

        <main class="view-area active" id="view-workboard">
            <header class="board-header">
                <h1 id="boardTitle">Active Workboard</h1>
                <div class="board-filters">
                    <button class="filter-btn" id="btn-collapse-all" onclick="toggleGlobalCollapse()">‚äü Collapse All</button>
                    <button class="filter-btn" id="btn-sort-date" onclick="setSort('date')">üóì Date</button>
                    <button class="filter-btn active" id="btn-sort-priority" onclick="setSort('priority')">‚ö† Priority</button>
                    <button class="filter-btn" id="btn-sort-id" onclick="setSort('id')">üî¢ A-Z</button>
                </div>
            </header>

            <div class="kanban-board" id="kanbanBoard">
                <div class="kanban-column">
                    <div class="column-header"><div class="col-header-left"><span class="status-dot" style="color: var(--c-road);"></span><span>On the Road</span><span class="column-count" id="count-road">0</span></div></div>
                    <div class="column-content" id="col-road" data-col="on_the_road"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header"><div class="col-header-left"><span class="status-dot" style="color: var(--c-intake);"></span><span>Repair Complaints</span><span class="column-count" id="count-complaints">0</span></div></div>
                    <div class="column-content" id="col-complaints" data-col="complaints"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header"><div class="col-header-left"><span class="status-dot" style="color: var(--c-ready);"></span><span>Ready for Pickup</span><span class="column-count" id="count-ready">0</span></div></div>
                    <div class="column-content" id="col-ready" data-col="ready"></div>
                </div>
                <div class="kanban-column" style="min-width: 360px;">
                    <div class="column-header"><div class="col-header-left"><span class="status-dot" style="color: var(--c-shop);"></span><span>In Progress / Parts</span><span class="column-count" id="count-progress">0</span></div></div>
                    <div class="column-content" id="col-progress" data-col="progress"></div>
                </div>
            </div>
        </main>

        <main class="view-area" id="view-database">
            <header class="board-header">
                <h1>Fleet Database</h1>
                <div class="board-filters">
                    <button class="filter-btn active">All Vehicles</button>
                    <button class="filter-btn" id="fleetioSyncBtn" onclick="syncFleetioMileage()" style="color: var(--text-main); border-color: var(--c-shop);">
                        üîÑ Sync Fleetio
                    </button>
                </div>
            </header>
            <div class="db-container">
                <table class="db-table">
                    <thead>
                        <tr>
                            <th>Unit ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Mileage</th>
                            <th>Last Oil Change</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dbTableBody">
                        </tbody>
                </table>
            </div>
        </main>

        <main class="view-area" id="view-users">
            <header class="board-header">
                <h1>User Management</h1>
                <div class="board-filters">
                    <button class="filter-btn" style="border-color: var(--accent); color: var(--text-main);" onclick="openUserModal()">+ Create New User</button>
                </div>
            </header>
            <div class="db-container">
                <table class="db-table">
                    <thead>
                        <tr>
                            <th>Email Address</th>
                            <th>User UID</th>
                            <th>Assigned Role</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="entryModal" class="modal-overlay" onclick="if(event.target===this)closeModal('entryModal')">
        <div class="modal-content">
            <h2 id="modalTitle">UNIT DETAILS</h2>
            <form id="vehicleForm" onsubmit="saveVehicle(event)">
                <input type="hidden" id="mode" value="add">
                <input type="hidden" id="targetDocId">
                <input type="hidden" id="vHistory">
                
                <div class="form-group" style="background: rgba(255,255,255,0.03); padding: 0.8rem; border-radius: 6px;">
                    <label style="color: var(--text-main);">Who are you? (For Logs)</label>
                    <input type="text" id="currentUser" placeholder="Enter your name..." required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Vehicle ID</label>
                        <input type="text" id="vID" list="syncedVehiclesList" autocomplete="off" required>
                        <datalist id="syncedVehiclesList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Vehicle Type</label>
                        <select id="vType">
                            <option value="">Select...</option><option value="Van">Van</option><option value="Prius">Prius</option><option value="Scion">Scion</option><option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="vPriority">
                            <option value="Urgent">üî¥ Urgent</option><option value="High">‚ö† High</option><option value="Oil Change / Bulb Replacement">üîß Maintenance</option><option value="Normal" selected>Normal</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Condition</label><select id="vStatus"><option value="Operational">Operational</option><option value="Warning">Warning</option><option value="Down">Down</option></select></div>
                </div>

                <div class="form-group"><label>Issue Description</label><input type="text" id="vIssue" required></div>
                <div class="form-group"><label>Notes / Updates</label><textarea id="vNotes" rows="3"></textarea></div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Shop Status</label>
                        <select id="vShopStatus" onchange="togglePartsFields()">
                            <option value="Reported">Reported</option><option value="Ready for Pickup">Ready for Pickup</option><option value="Received">Received</option><option value="Assessment">Assessment</option><option value="Awaiting part order">Awaiting part order</option><option value="Parts Received">Parts Received</option><option value="Repair in Progress">Repair in Progress</option><option value="Awaiting delivery">Awaiting delivery</option><option value="Complete">Complete (Remove from Board)</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Current Location</label><select id="vLocation"><option value="Dispatch Lot">Dispatch Lot</option><option value="On the road">On the road</option><option value="Pam (Ridesource, DMV)">Pam (Ridesource, DMV)</option><option value="Shop">Shop</option><option value="Paint">Paint</option><option value="Glass">Glass</option></select></div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer; color: var(--text-main);">
                        <input type="checkbox" id="vOnTheRoad" style="width: auto; margin: 0; accent-color: var(--text-main);">
                        <span>Flag as "On the Road"</span>
                    </label>
                </div>

                <div class="form-row">
                    <div class="form-group"><label>Home Location</label><input type="text" id="vHomeLocation" placeholder="e.g. Eugene"></div>
                    <div class="form-group"><label>Requested By</label><input type="text" id="vRequestedBy"></div>
                </div>
                
                <div id="partsSection" style="display: none; background: rgba(251,146,60,0.05); border: 1px dashed rgba(251,146,60,0.3); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.2rem;">
                    <div class="form-row">
                        <div class="form-group" style="margin:0;"><label>Parts Ordered</label><input type="date" id="vPartsOrdered"></div>
                        <div class="form-group" style="margin:0;"><label>ETA</label><input type="date" id="vPartsEta"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group"><label>Date In</label><input type="date" id="vDate" required></div>
                    <div class="form-group"><label>Inspection Date</label><input type="date" id="vInspectionDate"></div>
                </div>

                <div class="history-section" id="historySection">
                    <div class="history-title"><span>Activity Log</span> <span id="lastUpdatedBy" style="color:var(--text-main); font-weight: normal;"></span></div>
                    <div class="history-list" id="historyList"></div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                    <button type="button" class="btn-danger" id="deleteBtn" onclick="deleteCurrent()" style="margin-right:auto;">Delete</button>
                    <button type="button" class="btn-outline" onclick="closeModal('entryModal')">Cancel</button>
                    <button type="submit" class="btn-primary" id="saveBtn">Save Ticket</button>
                </div>
            </form>
        </div>
    </div>

    <div id="dbModal" class="modal-overlay" onclick="if(event.target===this)closeModal('dbModal')">
        <div class="modal-content">
            <h2>DATABASE RECORD</h2>
            <form onsubmit="saveDbRecord(event)">
                <input type="hidden" id="dbTargetDocId">
                
                <div class="form-row">
                    <div class="form-group"><label>Vehicle ID</label><input type="text" id="dbID" required></div>
                    <div class="form-group"><label>Current Mileage</label><input type="number" id="dbMileage" placeholder="e.g. 150000"></div>
                </div>

                <div class="form-group"><label>Last Oil Change (Date)</label><input type="date" id="dbOilChange"></div>
                <div class="form-group"><label>Accident History</label><textarea id="dbAccident" rows="3" placeholder="Log any major collisions or body damage..."></textarea></div>
                <div class="form-group"><label>Major Repair History</label><textarea id="dbRepairs" rows="4" placeholder="Engine replacements, transmission rebuilds, etc..."></textarea></div>

                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                    <button type="button" class="btn-outline" onclick="startRepairFromDb()" id="startRepairBtn" style="margin-right:auto; color: #60a5fa; border-color: rgba(96,165,250,0.4);">üìã Create Repair Ticket</button>
                    <button type="button" class="btn-outline" onclick="closeModal('dbModal')">Cancel</button>
                    <button type="submit" class="btn-primary" id="dbSaveBtn">Save Record</button>
                </div>
            </form>
        </div>
    </div>

    <div id="syncLogModal" class="modal-overlay" onclick="if(event.target===this)closeModal('syncLogModal')">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="color: var(--c-shop);">FLEETIO SYNC LOGBOOK</h2>
            <div id="syncLogStats" style="display:flex; flex-wrap:wrap; gap:1.5rem; margin-bottom: 1rem; padding: 1rem; background: #000; border-radius: var(--radius-sm); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; border: 1px solid var(--border);"></div>
            <div id="syncLogDetails" style="max-height: 400px; overflow-y: auto; background: #111; padding: 1rem; border-radius: var(--radius-sm); border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; white-space: pre-wrap; color: #ccc; line-height: 1.6;"></div>
            <div style="display:flex; justify-content:flex-end; margin-top:1.5rem;">
                <button type="button" class="btn-primary" onclick="closeModal('syncLogModal')">Close Logbook</button>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal-overlay" onclick="if(event.target===this)closeModal('userModal')">
        <div class="modal-content" style="max-width: 400px;">
            <h2>CREATE NEW USER</h2>
            <form onsubmit="createNewUser(event)">
                <div class="form-group"><label>Email Address</label><input type="email" id="newAccEmail" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="newAccPassword" required minlength="6"></div>
                <div class="form-group">
                    <label>Assign Role</label>
                    <select id="newAccRole">
                        <option value="viewer">Viewer (Read-Only)</option>
                        <option value="standard">Standard (Edit, No Delete)</option>
                        <option value="admin">Admin (Full Access)</option>
                    </select>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                    <button type="button" class="btn-outline" onclick="closeModal('userModal')">Cancel</button>
                    <button type="submit" class="btn-primary" id="createUserBtn">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- FLEETIO CONFIG ---
        const FLEETIO_API_KEY = 'fa387224226d63ffa24676b5576793283d70fef4';
        const FLEETIO_ACCOUNT_TOKEN = '82be379dc8';

        const firebaseConfig = {
            apiKey: "AIzaSyCnH_ILuDyJB1mC0iBlrfYIAFVumD74yo4",
            authDomain: "dlx-dmt-tracker.firebaseapp.com",
            projectId: "dlx-dmt-tracker",
            storageBucket: "dlx-dmt-tracker.firebasestorage.app",
            messagingSenderId: "958627003202",
            appId: "1:958627003202:web:07ea8476831ef49e4ea6db"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");

        // --- STATE & ROLES ---
        let fleetData = [];
        let systemUsers = [];
        let locationFilter = null;
        let activeSort = 'priority';
        let currentView = 'workboard';
        let collapsedCards = new Set(); 
        let allCollapsed = false;
        
        let currentUserRole = 'viewer';
        let currentUserId = null;

        // --- MAPPING ---
        const STATUS_MAP = {
            "Reported": "complaints", "Ready for Pickup": "ready",
            "Received": "progress", "Assessment": "progress", "Awaiting part order": "progress",
            "Parts Received": "progress", "Repair in Progress": "progress", "Awaiting delivery": "progress",
            "Parts Received - Waiting for Technician": "progress"
        };

        const PROGRESS_LEVELS = {
            "Reported": 1, "Ready for Pickup": 2, "Received": 3, "Assessment": 3, "Awaiting part order": 3,
            "Parts Received": 4, "Repair in Progress": 4, "Awaiting delivery": 4, "Complete": 5
        };

        // --- AUTH & ROLES ---
        function toggleLoginSignup() {
            const login = document.getElementById('loginFormDiv'), signup = document.getElementById('signupFormDiv');
            login.style.display = login.style.display === 'none' ? 'flex' : 'none';
            signup.style.display = signup.style.display === 'none' ? 'flex' : 'none';
            document.getElementById('loginError').innerText = '';
        }

        function handleLogin() {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(e, p).catch(e => document.getElementById('loginError').innerText = e.message);
        }

        function handleSignup() {
            const e = document.getElementById('signupEmail').value, p = document.getElementById('signupPassword').value, c = document.getElementById('signupPasswordConfirm').value;
            if (!e || !p || !c) return document.getElementById('loginError').innerText = 'All fields required';
            if (p !== c) return document.getElementById('loginError').innerText = 'Passwords do not match';
            
            auth.createUserWithEmailAndPassword(e, p).then(async cred => {
                const userSnap = await db.collection('users').limit(1).get();
                const assignedRole = userSnap.empty ? 'admin' : 'viewer';
                await db.collection('users').doc(cred.user.uid).set({ email: e, role: assignedRole });
            }).catch(err => document.getElementById('loginError').innerText = err.message);
        }

        function handleLogout() { auth.signOut().then(() => location.reload()); }

        auth.onAuthStateChanged(async user => { 
            if(user) {
                currentUserId = user.uid;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').classList.add('active');
                document.getElementById('displayUserEmail').innerText = user.email.split('@')[0];
                document.getElementById('userAvatar').innerText = user.email.charAt(0).toUpperCase();
                
                const roleDoc = await db.collection('users').doc(user.uid).get();
                if(roleDoc.exists) currentUserRole = roleDoc.data().role || 'viewer';
                document.getElementById('displayUserRole').innerText = currentUserRole;

                applyRoleRestrictions();
                loadData();
                setupDragAndDrop();
            } else { 
                document.getElementById('loginOverlay').style.display = 'flex'; 
            } 
        });

        function applyRoleRestrictions() {
            if (currentUserRole === 'viewer') {
                document.getElementById('nav-add-unit').style.display = 'none';
                document.getElementById('fleetioSyncBtn').style.display = 'none';
            } else {
                document.getElementById('nav-add-unit').style.display = 'flex';
                document.getElementById('fleetioSyncBtn').style.display = 'flex';
            }

            if (currentUserRole === 'admin') {
                document.getElementById('nav-users').style.display = 'flex';
                loadUsersData(); 
            } else {
                document.getElementById('nav-users').style.display = 'none';
            }
        }

        // --- DATA ---
        function loadData() {
            db.collection('vehicles').onSnapshot(snap => {
                fleetData = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
                renderSidebarLocations();
                updateDatalist();
                renderCurrentView();
            });
        }

        function updateDatalist() {
            const dl = document.getElementById('syncedVehiclesList');
            dl.innerHTML = '';
            const ids = [...new Set(fleetData.map(v => v.id).filter(id => id))].sort();
            ids.forEach(id => { const opt = document.createElement('option'); opt.value = id; dl.appendChild(opt); });
        }

        document.getElementById('vID').addEventListener('input', function(e) {
            if(document.getElementById('mode').value === 'add') {
                const existing = fleetData.find(v => (v.id||'').toLowerCase() === e.target.value.toLowerCase());
                if(existing) {
                    if(existing.vehicleType) document.getElementById('vType').value = existing.vehicleType;
                    if(existing.homeLocation) document.getElementById('vHomeLocation').value = existing.homeLocation;
                }
            }
        });

        // --- USER MANAGEMENT ---
        function loadUsersData() {
            if(currentUserRole !== 'admin') return;
            db.collection('users').onSnapshot(snap => {
                systemUsers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
                if(currentView === 'users') renderUsersTable();
            });
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = systemUsers.map(u => `
                <tr>
                    <td>${u.email}</td>
                    <td style="font-family:'JetBrains Mono'; font-size:0.7rem; color:#666;">${u.uid}</td>
                    <td>
                        <select class="role-select" onchange="updateUserRole('${u.uid}', this.value)" ${u.uid === currentUserId ? 'disabled' : ''}>
                            <option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                            <option value="standard" ${u.role === 'standard' ? 'selected' : ''}>Standard</option>
                            <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function updateUserRole(uid, newRole) {
            db.collection('users').doc(uid).update({ role: newRole }).then(() => showToast("‚úì User role updated")).catch(() => showToast("‚ùå Failed to update role"));
        }

        function openUserModal() {
            document.getElementById('newAccEmail').value = '';
            document.getElementById('newAccPassword').value = '';
            document.getElementById('newAccRole').value = 'viewer';
            document.getElementById('userModal').style.display = 'flex';
        }

        function createNewUser(e) {
            e.preventDefault();
            const email = document.getElementById('newAccEmail').value, pass = document.getElementById('newAccPassword').value, role = document.getElementById('newAccRole').value, btn = document.getElementById('createUserBtn');
            btn.innerText = "Creating..."; btn.disabled = true;
            secondaryApp.auth().createUserWithEmailAndPassword(email, pass).then(cred => {
                db.collection('users').doc(cred.user.uid).set({ email, role }).then(() => {
                    btn.innerText = "Create User"; btn.disabled = false;
                    closeModal('userModal'); showToast("‚úì Account Created");
                    secondaryApp.auth().signOut(); 
                });
            }).catch(err => { btn.innerText = "Create User"; btn.disabled = false; alert(err.message); });
        }

        // --- FLEETIO SYNC ---
        async function syncFleetioMileage() {
            if (!FLEETIO_API_KEY || FLEETIO_API_KEY === 'YOUR_FLEETIO_API_KEY_HERE') return alert("Please add your Fleetio API Key.");
            const btn = document.getElementById('fleetioSyncBtn');
            btn.innerHTML = "‚è≥ Syncing..."; btn.disabled = true;
            let logbook = [];

            try {
                const response = await fetch('https://secure.fleetio.com/api/v1/vehicles?per_page=100', {
                    method: 'GET', headers: { 'Authorization': `Token token="${FLEETIO_API_KEY}"`, 'Account-Token': FLEETIO_ACCOUNT_TOKEN, 'Content-Type': 'application/json', 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error(`Fleetio API Error: ${response.status}`);
                
                const fleetioResponse = await response.json();
                let fleetioVehicles = Array.isArray(fleetioResponse) ? fleetioResponse : (fleetioResponse.records || fleetioResponse.data || []);
                let updateCount = 0, skipCount = 0, createdCount = 0, noMeterCount = 0, updatePromises = [];

                logbook.push(`üì° Fetched ${fleetioVehicles.length} vehicles from Fleetio API.\n`);

                fleetioVehicles.forEach(fVehicle => {
                    const cleanFleetioName = (fVehicle.name || '').replace(/[^0-9]/g, '');
                    const finalDocId = cleanFleetioName !== '' ? cleanFleetioName : fVehicle.name.trim();
                    
                    const localVehicle = fleetData.find(v => {
                        const cleanLocalId = (v.id || '').replace(/[^0-9]/g, '');
                        return (cleanLocalId === cleanFleetioName && cleanLocalId !== '') || v.docId === finalDocId;
                    });

                    if (localVehicle) {
                        if (fVehicle.primary_meter_value) {
                            const updatedMileage = Math.round(parseFloat(fVehicle.primary_meter_value));
                            if ((parseInt(localVehicle.mileage) || 0) !== updatedMileage) {
                                updateCount++;
                                logbook.push(`‚úÖ UPDATED: ${localVehicle.id} | ${localVehicle.mileage || 0} -> ${updatedMileage}`);
                                updatePromises.push(db.collection('vehicles').doc(localVehicle.docId).update({ mileage: updatedMileage }));
                            } else { skipCount++; logbook.push(`‚è≠Ô∏è SKIPPED: ${localVehicle.id} | Mileage identical (${updatedMileage})`); }
                        } else { noMeterCount++; logbook.push(`‚ö†Ô∏è NO METER: Found ${localVehicle.id}, but no mileage data.`); }
                    } else {
                        const newMileage = fVehicle.primary_meter_value ? Math.round(parseFloat(fVehicle.primary_meter_value)) : 0;
                        createdCount++;
                        logbook.push(`‚ú® CREATED: ${fVehicle.name} added as Doc ID "${finalDocId}" (Mileage: ${newMileage})`);
                        updatePromises.push(db.collection('vehicles').doc(finalDocId).set({
                            id: finalDocId, mileage: newMileage, shopStatus: 'Database Only', onTheRoad: false, priority: 'Normal', status: 'Operational', homeLocation: '', vehicleType: '', date: new Date().toISOString().split('T')[0], lastUpdated: new Date().toISOString(), history: JSON.stringify([createLogEntry('System', 'Imported from Fleetio')])
                        }));
                    }
                });

                await Promise.all(updatePromises);
                showSyncLogbook(updateCount, skipCount, createdCount, noMeterCount, logbook);
                showToast(`‚úì Synced ${updateCount}, Created ${createdCount}`);
            } catch (error) { showToast("‚ùå Failed to sync. Check console."); } 
            finally { btn.innerHTML = "üîÑ Sync Fleetio"; btn.disabled = false; }
        }

        function showSyncLogbook(updated, skipped, created, noMeter, logLines) {
            document.getElementById('syncLogStats').innerHTML = `<div style="color: var(--accent);">‚úÖ Updated: ${updated}</div><div style="color: #60a5fa;">‚ú® Created: ${created}</div><div style="color: var(--text-muted);">‚è≠Ô∏è Skipped: ${skipped}</div><div style="color: var(--c-parts);">‚ö†Ô∏è No Meter: ${noMeter}</div>`;
            document.getElementById('syncLogDetails').innerHTML = logLines.join('\n');
            document.getElementById('syncLogModal').style.display = 'flex';
        }

        // --- VIEWS & RENDER ---
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-area').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            document.getElementById(`nav-${view}`).classList.add('active');
            if(view === 'users') renderUsersTable();
            else renderCurrentView();
        }

        function renderCurrentView() {
            if (currentView === 'workboard') renderBoard();
            else if (currentView === 'database') renderDatabase();
        }

        function setFilter(loc) { locationFilter = loc; document.getElementById('boardTitle').innerText = loc ? `${loc} Units` : "Active Workboard"; renderSidebarLocations(); renderCurrentView(); }
        
        function setSort(type) { 
            activeSort = type; 
            document.querySelectorAll('.filter-btn[id^="btn-sort-"]').forEach(btn => btn.classList.remove('active'));
            const targetBtn = document.getElementById('btn-sort-' + type);
            if(targetBtn) targetBtn.classList.add('active');
            renderCurrentView(); 
        }

        function formatDate(s) { if (!s) return ''; const p = s.split('-'); return p.length===3 ? `${p[1]}/${p[2]}/${p[0]}` : s; }

        function toggleCard(docId, btn) {
            const card = btn.closest('.vehicle-card');
            if (collapsedCards.has(docId)) { 
                collapsedCards.delete(docId); 
                card.classList.remove('collapsed'); 
            } else { 
                collapsedCards.add(docId); 
                card.classList.add('collapsed'); 
            }
        }

        function toggleGlobalCollapse() {
            allCollapsed = !allCollapsed;
            const btn = document.getElementById('btn-collapse-all');
            btn.innerHTML = allCollapsed ? '‚äû Expand All' : '‚äü Collapse All';
            
            document.querySelectorAll('.vehicle-card').forEach(card => {
                const docId = card.dataset.docId;
                if (!docId) return;

                if (allCollapsed) {
                    collapsedCards.add(docId);
                    card.classList.add('collapsed');
                } else {
                    collapsedCards.delete(docId);
                    card.classList.remove('collapsed');
                }
            });
        }

        function renderBoard() {
            ['road', 'complaints', 'ready', 'progress'].forEach(c => { document.getElementById(`col-${c}`).innerHTML = ''; document.getElementById(`count-${c}`).innerText = '0'; });
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const groups = { road: [], complaints: [], ready: [], progress: [] };
            
            fleetData.forEach(v => {
                if (locationFilter && v.homeLocation !== locationFilter) return;
                if (search && !JSON.stringify(v).toLowerCase().includes(search)) return;

                let colId = null;
                if (v.onTheRoad) colId = 'road';
                else if (v.shopStatus === 'Database Only' || v.shopStatus === 'Complete') colId = null; 
                else if (STATUS_MAP[v.shopStatus]) colId = STATUS_MAP[v.shopStatus];
                else if (!v.shopStatus) colId = 'complaints';
                
                if (colId && groups[colId]) groups[colId].push(v);
            });

            Object.keys(groups).forEach(colId => {
                groups[colId].sort((a, b) => {
                    if (colId === 'road') {
                        const dA = a.inspectionDate ? new Date(a.inspectionDate).getTime() : 9999999999999;
                        const dB = b.inspectionDate ? new Date(b.inspectionDate).getTime() : 9999999999999;
                        return dA - dB;
                    } 
                    else {
                        if (activeSort === 'id') {
                            return (a.id || '').localeCompare(b.id || '', undefined, {numeric: true, sensitivity: 'base'});
                        }
                        const getPrio = (p) => p === 'Urgent' ? 0 : p === 'High' ? 1 : p === 'Oil Change / Bulb Replacement' ? 2 : 3;
                        if(activeSort === 'priority') { 
                            const pa = getPrio(a.priority), pb = getPrio(b.priority); 
                            if(pa !== pb) return pa - pb; 
                        }
                        return (b.lastUpdated || '').localeCompare(a.lastUpdated || '');
                    }
                });
            });

            const CHEV_ICON = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;

            Object.keys(groups).forEach(colId => {
                groups[colId].forEach(v => {
                    const isCollapsed = collapsedCards.has(v.docId) ? 'collapsed' : '';
                    const prioClass = v.priority === 'Urgent' ? 'prio-Urgent' : v.priority === 'High' ? 'prio-High' : v.priority === 'Oil Change / Bulb Replacement' ? 'prio-Maint' : 'prio-Normal';
                    
                    let inspectClass = '';
                    let inspectTag = '';
                    
                    if (colId === 'road' && v.inspectionDate) {
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        const insDate = new Date(v.inspectionDate);
                        const diffTime = insDate.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays <= 7) {
                            inspectClass = 'inspect-crit';
                            inspectTag = `<span class="card-meta-tag tag-danger">üîç Insp: ${formatDate(v.inspectionDate)} (${diffDays < 0 ? Math.abs(diffDays) + 'd past due' : diffDays + 'd left'})</span>`;
                        } else if (diffDays <= 30) {
                            inspectClass = 'inspect-warn';
                            inspectTag = `<span class="card-meta-tag tag-warn">üîç Insp: ${formatDate(v.inspectionDate)} (${diffDays}d left)</span>`;
                        } else {
                            inspectTag = `<span class="card-meta-tag">üîç Insp: ${formatDate(v.inspectionDate)}</span>`;
                        }
                    }

                    const card = document.createElement('div');
                    card.className = `vehicle-card ${prioClass} ${inspectClass} ${isCollapsed}`;
                    card.draggable = currentUserRole !== 'viewer';
                    card.dataset.docId = v.docId; // For global collapse targeting
                    
                    let isDragging = false;
                    card.ondragstart = (e) => { 
                        isDragging = true;
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', v.docId); 
                        setTimeout(() => card.classList.add('dragging'), 0); 
                    };
                    card.ondragend = () => { 
                        card.classList.remove('dragging'); 
                        setTimeout(() => isDragging = false, 50); 
                    };

                    card.onclick = (e) => {
                        if(isDragging) return;
                        if(e.target.closest('.collapse-indicator')) {
                            toggleCard(v.docId, e.target.closest('.collapse-indicator'));
                        } else {
                            openModal('edit', v.docId);
                        }
                    };

                    const pLevel = PROGRESS_LEVELS[v.shopStatus] || 1;
                    let segs = '';
                    for(let i=1; i<=5; i++) {
                        let activeClass = (i <= pLevel) ? 'active' : '';
                        if(i <= pLevel && v.priority === 'Urgent') activeClass = 'active-warn';
                        segs += `<div class="progress-seg ${activeClass}"></div>`;
                    }

                    const avatar = v.requestedBy ? v.requestedBy.charAt(0).toUpperCase() : 'U';
                    const mileageTag = v.mileage ? `<span class="card-meta-tag">üõ£Ô∏è ${Number(v.mileage).toLocaleString()} mi</span>` : '';
                    
                    card.innerHTML = `
                        <div class="card-header-main">
                            <div class="card-req-by"><span>${v.id} ‚Ä¢ ${v.vehicleType || 'Unit'}</span><div class="card-avatar">${avatar}</div></div>
                            <div class="collapse-indicator">${CHEV_ICON}</div>
                        </div>
                        <div class="card-body-wrapper">
                            <div class="card-body">
                                <div class="card-title">${v.issue || 'No issue provided'}</div>
                                <div class="card-footer-row">
                                    <span class="card-meta-tag">üè† ${v.homeLocation || 'N/A'}</span>
                                    <span class="card-meta-tag">${v.shopStatus || 'Reported'}</span>
                                    ${mileageTag}
                                    ${inspectTag}
                                </div>
                                <div class="card-progress-container">${segs}</div>
                            </div>
                        </div>
                    `;
                    document.getElementById(`col-${colId}`).appendChild(card);
                });
                
                if (document.getElementById(`count-${colId}`)) {
                    document.getElementById(`count-${colId}`).innerText = groups[colId].length;
                }
            });
        }

        // --- NEW SECURE DRAG ENGINE ---
        function setupDragAndDrop() {
            document.querySelectorAll('.kanban-column').forEach(col => {
                const content = col.querySelector('.column-content');
                if(!content) return;
                
                col.addEventListener('dragover', e => {
                    e.preventDefault(); 
                    if (currentUserRole !== 'viewer') {
                        e.dataTransfer.dropEffect = 'move';
                        col.classList.add('drag-over-column');
                    }
                });
                
                col.addEventListener('dragleave', e => {
                    if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over-column');
                });
                
                col.addEventListener('drop', e => {
                    e.preventDefault();
                    col.classList.remove('drag-over-column');
                    if (currentUserRole === 'viewer') return;
                    
                    const docId = e.dataTransfer.getData('text/plain');
                    if (!docId) return;
                    
                    const colType = content.getAttribute('data-col');
                    let changes = { onTheRoad: false };
                    
                    if (colType === 'on_the_road') changes.onTheRoad = true;
                    else if (colType === 'complaints') changes.shopStatus = "Reported";
                    else if (colType === 'ready') changes.shopStatus = "Ready for Pickup";
                    else if (colType === 'progress') changes.shopStatus = "Repair in Progress"; 
                    
                    db.collection('vehicles').doc(docId).update(changes)
                      .then(() => showToast("‚úì Status Updated"))
                      .catch(() => showToast("‚ùå Failed to move unit"));
                });
            });
        }

        function renderDatabase() {
            const tbody = document.getElementById('dbTableBody');
            tbody.innerHTML = '';
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sortedDB = [...fleetData].sort((a,b) => (a.id || '').localeCompare(b.id || '', undefined, {numeric: true, sensitivity: 'base'}));

            sortedDB.forEach(v => {
                if (locationFilter && v.homeLocation !== locationFilter) return;
                if (search && !JSON.stringify(v).toLowerCase().includes(search)) return;

                const tr = document.createElement('tr');
                tr.onclick = () => openDbModal(v.docId);
                let dispStatus = v.onTheRoad ? 'On the road' : (v.shopStatus === 'Database Only' ? 'Inactive / Synced' : v.shopStatus);

                tr.innerHTML = `<td><strong>${v.id || 'N/A'}</strong></td><td><span class="db-badge">${v.vehicleType || 'Unknown'}</span></td><td>${v.homeLocation || '‚Äî'}</td><td style="font-family: 'JetBrains Mono';">${v.mileage ? v.mileage.toLocaleString() : '‚Äî'}</td><td>${formatDate(v.lastOilChange) || '‚Äî'}</td><td><span style="color:var(--text-muted);">${dispStatus || '‚Äî'}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        // --- MODALS ---
        function togglePartsFields() { document.getElementById('partsSection').style.display = (document.getElementById('vShopStatus').value === "Awaiting part order") ? "block" : "none"; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function getUsername() { return document.getElementById('currentUser') ? document.getElementById('currentUser').value.trim() || "User" : "User"; }
        function createLogEntry(action, desc) { return { ts: Date.now(), user: getUsername(), action, desc }; }
        function parseHistory(j) { try { return j ? JSON.parse(j) : []; } catch(e) { return []; } }
        function renderHistoryLog(arr) {
            const list = document.getElementById('historyList');
            if(!arr || !arr.length) return list.innerHTML = '<div style="color:#555;text-align:center;">No history</div>';
            list.innerHTML = [...arr].sort((a,b)=>b.ts-a.ts).map(h => `<div class="history-item"><div class="h-time">${new Date(h.ts).toLocaleDateString()} ${new Date(h.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="h-user">${h.user}:</div><div>${h.desc}</div></div>`).join('');
        }

        function applyModalLocks(isViewer) {
            const form = document.getElementById('vehicleForm');
            form.querySelectorAll('input, select, textarea').forEach(el => el.disabled = isViewer);
            document.getElementById('saveBtn').style.display = isViewer ? 'none' : 'block';
            document.getElementById('deleteBtn').style.display = (currentUserRole === 'admin') ? 'block' : 'none';
        }

        function openModal(mode, id) {
            if (mode === 'add' && currentUserRole === 'viewer') return;

            document.getElementById('entryModal').style.display = 'flex';
            document.getElementById('mode').value = mode;
            
            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = "ADD NEW UNIT";
                document.getElementById('vehicleForm').reset();
                document.getElementById('vID').readOnly = false;
                document.getElementById('vDate').valueAsDate = new Date();
                document.getElementById('vPriority').value = 'Normal';
                document.getElementById('vStatus').value = 'Operational';
                document.getElementById('vShopStatus').value = 'Reported';
                document.getElementById('vLocation').value = 'Dispatch Lot';
                document.getElementById('historyList').innerHTML = '<div style="color:#555;text-align:center;">New ticket - no history</div>';
                document.getElementById('lastUpdatedBy').textContent = '';
                applyModalLocks(false);
                document.getElementById('deleteBtn').style.display = 'none'; 
                togglePartsFields();
            } else {
                document.getElementById('modalTitle').innerText = currentUserRole === 'viewer' ? "VIEW UNIT" : "EDIT UNIT";
                const v = fleetData.find(v => v.docId === id);
                if (v) {
                    document.getElementById('targetDocId').value = id;
                    document.getElementById('vID').value = v.id || '';
                    document.getElementById('vType').value = v.vehicleType || '';
                    document.getElementById('vPriority').value = v.priority || 'Normal';
                    document.getElementById('vStatus').value = v.status || 'Operational';
                    document.getElementById('vIssue').value = v.issue || '';
                    document.getElementById('vShopStatus').value = v.shopStatus || 'Reported';
                    document.getElementById('vLocation').value = v.location || 'Dispatch Lot';
                    document.getElementById('vOnTheRoad').checked = v.onTheRoad === true;
                    document.getElementById('vHomeLocation').value = v.homeLocation || '';
                    document.getElementById('vRequestedBy').value = v.requestedBy || '';
                    document.getElementById('vNotes').value = v.notes || '';
                    document.getElementById('vPartsOrdered').value = v.partsOrdered || '';
                    document.getElementById('vPartsEta').value = v.partsEta || '';
                    document.getElementById('vDate').value = v.date || '';
                    document.getElementById('vInspectionDate').value = v.inspectionDate || '';
                    document.getElementById('vHistory').value = v.history || '';

                    const hist = parseHistory(v.history);
                    renderHistoryLog(hist);
                    document.getElementById('lastUpdatedBy').textContent = hist.length ? `(Last: ${hist[hist.length-1].user})` : '';
                    
                    applyModalLocks(currentUserRole === 'viewer');
                    togglePartsFields();
                }
            }
        }

        function saveVehicle(e) {
            e.preventDefault();
            if(currentUserRole === 'viewer') return;

            const mode = document.getElementById('mode').value, docId = document.getElementById('targetDocId').value, btn = document.getElementById('saveBtn');
            const data = {
                id: document.getElementById('vID').value.trim(), vehicleType: document.getElementById('vType').value,
                priority: document.getElementById('vPriority').value, status: document.getElementById('vStatus').value,
                issue: document.getElementById('vIssue').value, shopStatus: document.getElementById('vShopStatus').value,
                location: document.getElementById('vLocation').value, onTheRoad: document.getElementById('vOnTheRoad').checked,
                homeLocation: document.getElementById('vHomeLocation').value, requestedBy: document.getElementById('vRequestedBy').value,
                notes: document.getElementById('vNotes').value, partsOrdered: document.getElementById('vPartsOrdered').value,
                partsEta: document.getElementById('vPartsEta').value, date: document.getElementById('vDate').value,
                inspectionDate: document.getElementById('vInspectionDate').value, lastUpdated: new Date().toISOString()
            };

            let histArr = parseHistory(document.getElementById('vHistory').value);
            let request;

            if (mode === 'add') {
                const existing = fleetData.find(v => (v.id||'').toLowerCase() === data.id.toLowerCase() || v.docId === data.id);
                if (existing) {
                    histArr = parseHistory(existing.history);
                    histArr.push(createLogEntry('Ticket Created', 'Moved vehicle to active workboard'));
                    data.history = JSON.stringify(histArr);
                    request = db.collection('vehicles').doc(existing.docId).update(data);
                } else {
                    histArr.push(createLogEntry('Created', 'Ticket generated'));
                    data.history = JSON.stringify(histArr);
                    request = db.collection('vehicles').doc(data.id).set(data);
                }
            } else {
                const old = fleetData.find(v => v.docId === docId);
                if(old) {
                    if(old.shopStatus !== data.shopStatus) histArr.push(createLogEntry('Status', `Moved to ${data.shopStatus}`));
                    if(old.priority !== data.priority) histArr.push(createLogEntry('Priority', `Changed to ${data.priority}`));
                    if(old.notes !== data.notes && data.notes.length > (old.notes||'').length) histArr.push(createLogEntry('Note', 'Note added/updated'));
                }
                
                if (data.id !== docId) {
                    histArr.push(createLogEntry('ID Changed', `Changed ID from ${docId} to ${data.id}`));
                    data.history = JSON.stringify(histArr);
                    const newData = { ...(old || {}), ...data };
                    delete newData.docId;
                    request = db.collection('vehicles').doc(data.id).set(newData).then(() => db.collection('vehicles').doc(docId).delete());
                } else {
                    data.history = JSON.stringify(histArr);
                    request = db.collection('vehicles').doc(docId).update(data);
                }
            }

            btn.innerText = "Saving‚Ä¶"; btn.disabled = true; 
            request.then(() => { btn.innerText = "Save Ticket"; btn.disabled = false; closeModal('entryModal'); showToast("‚úì Saved successfully"); })
                   .catch(() => { btn.innerText = "Save Ticket"; btn.disabled = false; showToast("‚ùå Error saving"); });
        }

        function deleteCurrent() { 
            if(currentUserRole !== 'admin') return;
            if(confirm('Delete this unit?')) { db.collection('vehicles').doc(document.getElementById('targetDocId').value).delete(); closeModal('entryModal'); } 
        }

        function openDbModal(id) {
            document.getElementById('dbModal').style.display = 'flex';
            const v = fleetData.find(v => v.docId === id);
            
            const isViewer = currentUserRole === 'viewer';
            const form = document.querySelector('#dbModal form');
            form.querySelectorAll('input, textarea').forEach(el => el.disabled = isViewer);
            document.getElementById('dbSaveBtn').style.display = isViewer ? 'none' : 'block';
            document.getElementById('startRepairBtn').style.display = isViewer ? 'none' : 'block';

            if(v) {
                document.getElementById('dbTargetDocId').value = id;
                document.getElementById('dbID').value = v.id || '';
                document.getElementById('dbMileage').value = v.mileage || '';
                document.getElementById('dbOilChange').value = v.lastOilChange || '';
                document.getElementById('dbAccident').value = v.accidentHistory || '';
                document.getElementById('dbRepairs').value = v.longTermRepairs || '';
            }
        }

        function startRepairFromDb() {
            const docId = document.getElementById('dbTargetDocId').value;
            closeModal('dbModal');
            openModal('edit', docId);
            
            const statusSelect = document.getElementById('vShopStatus');
            if (statusSelect.value === 'Database Only' || statusSelect.value === 'Complete') {
                statusSelect.value = 'Reported';
            }
            
            document.getElementById('vIssue').value = '';
            document.getElementById('vNotes').value = '';
            document.getElementById('vDate').valueAsDate = new Date();
            document.getElementById('vPartsOrdered').value = '';
            document.getElementById('vPartsEta').value = '';
            
            showToast("Ready to create ticket. Fill in the issue and save.");
            setTimeout(() => document.getElementById('vIssue').focus(), 100);
        }

        function saveDbRecord(e) {
            e.preventDefault();
            if (currentUserRole === 'viewer') return;
            const docId = document.getElementById('dbTargetDocId').value, btn = document.getElementById('dbSaveBtn'), newId = document.getElementById('dbID').value.trim();
            const data = { id: newId, mileage: document.getElementById('dbMileage').value, lastOilChange: document.getElementById('dbOilChange').value, accidentHistory: document.getElementById('dbAccident').value, longTermRepairs: document.getElementById('dbRepairs').value };
            
            btn.innerText = "Saving..."; btn.disabled = true;
            let request = (newId !== docId) ? db.collection('vehicles').doc(newId).set({ ...(fleetData.find(v => v.docId === docId) || {}), ...data }).then(() => db.collection('vehicles').doc(docId).delete()) : db.collection('vehicles').doc(docId).update(data);
            
            request.then(() => { btn.innerText = "Save Record"; btn.disabled = false; closeModal('dbModal'); showToast("‚úì Database Record Updated"); })
                   .catch(() => { btn.innerText = "Save Record"; btn.disabled = false; showToast("‚ùå Error updating record"); });
        }

        // --- UTILS ---
        function showToast(msg) { 
            document.querySelectorAll('.toast').forEach(e => e.remove()); 
            const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; 
            document.body.appendChild(t); setTimeout(() => t.remove(), 3000); 
        }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal('entryModal'); closeModal('dbModal'); closeModal('syncLogModal'); closeModal('userModal'); } });
    </script>
</body>
</html>