<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair Terminal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;800&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ===== CORE VARIABLES ===== */
        :root {
            --bg-app: #111111;
            --bg-sidebar: #161616;
            --bg-board: #161616;
            --bg-card: #232323;
            --bg-card-hover: #2a2a2a;
            
            --text-main: #ededed;
            --text-muted: #8b8b8b;
            --border: #2c2c2c;
            --border-hover: #3d3d3d;
            
            --accent: #4ade80;
            --c-urgent: #ef4444; 
            --c-high: #f97316;   
            --c-normal: #3b82f6; 
            --c-maint: #a855f7;  
            
            --c-intake: #c084fc; 
            --c-shop: #60a5fa; 
            --c-parts: #fb923c; 
            --c-done: #4ade80; 
            --c-ready: #22d3ee;
            --c-road: #a78bfa;

            --radius-lg: 12px;
            --radius-md: 8px;
            --radius-sm: 6px;
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.6);
            --transition: 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', 'Outfit', sans-serif; background-color: var(--bg-app); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* Global Drag State */
        body.is-dragging * { pointer-events: none; }
        body.is-dragging .kanban-column { pointer-events: auto; }

        /* ===== LAYOUT & SIDEBAR ===== */
        .main-content { display: none; flex-direction: row; height: 100vh; width: 100vw; }
        .main-content.active { display: flex; }

        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem 0; flex-shrink: 0; }
        .sidebar-header { display: flex; align-items: center; padding: 0 1.5rem; gap: 0.8rem; margin-bottom: 1.5rem; }
        .logo-icon { background: var(--accent); color: #000; font-weight: 900; padding: 0.3rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-family: 'Outfit', sans-serif;}
        .sidebar h2 { font-size: 0.9rem; font-weight: 700; font-family: 'Outfit', sans-serif; letter-spacing: 1px; flex-grow: 1; }
        
        .sidebar-search { margin: 0 1.5rem 1.5rem; background: #000; border: 1px solid var(--border); border-radius: var(--radius-sm); display: flex; align-items: center; padding: 0.5rem 0.8rem; }
        .sidebar-search input { background: transparent; border: none; color: var(--text-main); width: 100%; margin-left: 0.5rem; font-size: 0.85rem; font-family: 'Inter', sans-serif;}
        .sidebar-search input:focus { outline: none; }

        .sidebar-nav { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.2rem;}
        .nav-item { display: flex; align-items: center; padding: 0.6rem 1.5rem; color: var(--text-muted); text-decoration: none; font-size: 0.85rem; font-weight: 500; gap: 0.8rem; transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer;}
        .nav-item:hover { background: rgba(255,255,255,0.03); color: var(--text-main); }
        .nav-item.active { background: rgba(255,255,255,0.05); color: var(--text-main); border-left-color: var(--text-main); }
        .nav-item.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        
        .nav-submenu { display: flex; flex-direction: column; gap: 2px; }
        .submenu-item { padding: 0.5rem 1.5rem 0.5rem 2.8rem; font-size: 0.8rem; color: var(--text-muted); cursor: pointer; transition: color 0.2s; text-decoration: none; display: block; }
        .submenu-item:hover { color: var(--text-main); background: rgba(255,255,255,0.02); }
        .submenu-item.active { color: var(--accent); font-weight: 600; }
        .submenu-label { padding: 0 1.5rem; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 0.7rem; text-transform: uppercase; color: #555; font-weight: 700; letter-spacing: 0.5px; }

        .sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); margin-top: auto;}
        .user-profile { background: transparent; border: none; display: flex; align-items: center; gap: 0.8rem; color: var(--text-muted); cursor: pointer; width: 100%; transition: color 0.2s;}
        .user-profile:hover { color: var(--text-main); }
        .avatar { width: 24px; height: 24px; background: #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #fff; font-weight: 600;}

        /* ===== VIEWS & CRISP FILTERS ===== */
        .view-area { display: none; flex-direction: column; flex-grow: 1; overflow: hidden; background: var(--bg-board); position: relative;}
        .view-area.active { display: flex; }

        .board-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); flex-shrink: 0;}
        .board-header h1 { font-family: 'Outfit', sans-serif; font-size: 1.2rem; font-weight: 600; color: var(--text-main); }
        
        .board-filters { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; }
        .filter-btn { 
            background: #111; border: 1px solid var(--border); color: var(--text-muted); 
            font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; font-weight: 600; 
            cursor: pointer; display: flex; align-items: center; gap: 0.4rem; padding: 0.5rem 0.8rem; 
            border-radius: 6px; transition: all 0.2s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .filter-btn:hover:not(:disabled) { color: var(--text-main); border-color: #555; background: #1a1a1a; transform: translateY(-1px); }
        .filter-btn.active { background: var(--c-shop); color: #000; border-color: var(--c-shop); box-shadow: 0 0 12px rgba(96,165,250,0.3); }
        .filter-btn.bulk-active { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 12px rgba(74, 222, 128, 0.3); }
        .filter-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }

        /* ===== KANBAN ===== */
        .kanban-board { flex: 1; display: flex; gap: 1.2rem; overflow-x: auto; overflow-y: hidden; padding: 1.5rem 2rem; }
        .kanban-column { display: flex; flex-direction: column; height: 100%; min-width: 320px; flex: 1; transition: background 0.2s, box-shadow 0.2s; border-radius: var(--radius-lg); border: 2px solid transparent; position: relative;}
        
        .kanban-column.drag-over-column { background: rgba(255,255,255,0.02); border-color: var(--border-hover); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        
        .column-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.5rem 1rem 0.5rem; flex-shrink: 0; pointer-events: none; }
        .col-header-left { display: flex; align-items: center; gap: 0.6rem; font-size: 0.9rem; font-weight: 600; color: var(--text-main); font-family: 'Outfit', sans-serif;}
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; box-shadow: 0 0 8px currentColor; }
        .column-count { color: #666; font-size: 0.85rem; font-weight: 500; margin-left: 0.2rem;}
        
        .column-content { flex: 1; overflow-y: auto; padding: 0 0.5rem 1rem 0.5rem; scrollbar-width: none; }
        .column-content::-webkit-scrollbar { display: none; }

        .drop-indicator { height: 4px; background: var(--c-shop); border-radius: 2px; margin: 4px 0; box-shadow: 0 0 8px var(--c-shop); transition: all 0.1s; pointer-events: none; }

        /* ===== SLEEK VEHICLE CARDS & SUB TICKETS ===== */
        .vehicle-card { background: var(--bg-card); border: 1px solid transparent; border-left: 3px solid transparent; border-radius: var(--radius-md); padding: 1rem; margin-bottom: 0.8rem; display: flex; flex-direction: column; transition: all var(--transition); cursor: pointer; overflow: hidden; }
        .vehicle-card:hover { background: var(--bg-card-hover); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: #333;}
        .vehicle-card.dragging { opacity: 0.4; border: 1px dashed #666; transform: scale(0.95); }

        .prio-Urgent { border-left-color: var(--c-urgent); box-shadow: inset 16px 0 20px -16px rgba(239, 68, 68, 0.2); }
        .prio-High { border-left-color: var(--c-high); }
        .prio-Normal { border-left-color: var(--border); }
        .prio-Maint { border-left-color: var(--c-maint); }

        .vehicle-card.inspect-warn { border-color: rgba(251, 146, 60, 0.6); box-shadow: 0 4px 15px rgba(251, 146, 60, 0.15); }
        .vehicle-card.inspect-warn:hover { border-color: rgba(251, 146, 60, 1); box-shadow: 0 6px 20px rgba(251, 146, 60, 0.25); }
        .vehicle-card.inspect-crit { border-color: rgba(239, 68, 68, 0.8); box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3); }
        .vehicle-card.inspect-crit:hover { border-color: rgba(239, 68, 68, 1); box-shadow: 0 6px 25px rgba(239, 68, 68, 0.4); }

        /* Multi-Select Styles */
        .vehicle-card.selectable { cursor: crosshair; }
        .vehicle-card.selected { border-color: var(--c-shop); background: rgba(96,165,250,0.08); box-shadow: 0 0 0 2px var(--c-shop); transform: translateY(0); }

        .card-header-main { font-size: 1.15rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 0.5rem; pointer-events: none;}
        .card-req-by { font-size: .95rem; font-weight: 600; color:var(--text-main); display: flex; justify-content: space-between; align-items: center; flex: 1;}
        .card-avatar { width: 22px; height: 22px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: #ddd; font-weight: 700; border: 1px solid #444;}
        
        .collapse-indicator { display: flex; align-items: center; justify-content: center; opacity: 1; pointer-events: auto; padding: 0.2rem; border-radius: 4px; transition: background 0.2s;}
        .collapse-indicator:hover { background: rgba(255,255,255,0.08); }
        .collapse-indicator svg { width: 18px; height: 18px; color: var(--text-main); transition: transform var(--transition); transform: rotate(0deg); }
        .vehicle-card.collapsed .collapse-indicator svg { transform: rotate(-90deg); color: var(--text-muted); }

        .card-body-wrapper { display: grid; grid-template-rows: 1fr; transition: grid-template-rows var(--transition); pointer-events: none;}
        .vehicle-card.collapsed .card-body-wrapper { grid-template-rows: 0fr; }

        .card-body { overflow: hidden; display: flex; flex-direction: column; gap: 0.8rem; opacity: 1; padding-top: 0.8rem; transition: opacity 0.2s ease, padding-top var(--transition); pointer-events: auto;}
        .vehicle-card.collapsed .card-body { opacity: 0; padding-top: 0; pointer-events: none; }

        .card-title { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); line-height: 1.4; }
        .card-footer-row { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .card-meta-tag { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 4px; background: rgba(255,255,255,0.03); color: var(--text-muted); }
        
        .card-progress-container { display: flex; gap: 2px; height: 3px; width: 100%; margin-top: auto; opacity: 0.6; }
        .progress-seg { flex: 1; background: #333; border-radius: 2px; }
        .progress-seg.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .progress-seg.active-warn { background: var(--c-parts); }

        /* Sub Tickets */
        .sub-ticket { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.03); border-left: 3px solid var(--border); padding: 0.6rem; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; pointer-events: auto;}
        .sub-ticket:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .sub-ticket.st-urgent { border-left-color: var(--c-urgent); }
        .sub-ticket.st-high { border-left-color: var(--c-high); }
        .sub-ticket.st-maint { border-left-color: var(--c-maint); }
        .sub-ticket.selected { background: rgba(96,165,250,0.15); border-color: var(--c-shop); }

        /* ===== BULK ACTION BAR ===== */
        .bulk-action-bar { 
            position: absolute; bottom: -100px; left: 50%; transform: translateX(-50%); 
            background: #1a1a1a; border: 1px solid var(--border); padding: 1rem 2rem; 
            border-radius: 50px; display: flex; gap: 1rem; align-items: center; 
            z-index: 1000; transition: bottom 0.3s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 10px 40px rgba(0,0,0,0.8); 
        }
        .bulk-action-bar.visible { bottom: 2rem; }

        /* ===== ANALYTICS DASHBOARD ===== */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; padding: 1.5rem 2rem; overflow-y: auto; align-content: flex-start; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; position: relative; overflow: hidden;}
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: var(--accent); }
        .stat-card.sc-red::before { background: var(--c-urgent); }
        .stat-card.sc-orange::before { background: var(--c-high); }
        .stat-card.sc-blue::before { background: var(--c-shop); }
        .stat-val { font-size: 2.8rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; color: var(--text-main); line-height: 1;}
        .stat-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 600;}
        .chart-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; grid-column: 1 / -1; }
        .location-bar { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace;}
        .loc-bar-fill { height: 12px; background: var(--c-shop); border-radius: 6px; }

        /* ===== DATABASE / USERS TABLE ===== */
        .db-container { padding: 1.5rem 2rem; overflow-y: auto; flex: 1; }
        .db-table { width: 100%; border-collapse: collapse; text-align: left; }
        .db-table th { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; background: var(--bg-board); z-index: 10; }
        .db-table td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); font-size: 0.85rem; }
        .db-table tr { cursor: pointer; transition: background 0.2s; }
        .db-table tr:hover { background: rgba(255,255,255,0.02); }
        .db-badge { padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.05); }
        
        .role-select { background: #111; color: var(--text-main); border: 1px solid var(--border); padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.8rem; font-family: 'Inter', sans-serif;}
        .role-select:focus { outline: none; border-color: var(--c-shop); }

        /* ===== PREFERENCES CHECKBOXES ===== */
        .pref-section-title { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin: 1.5rem 0 0.8rem 0; border-bottom: 1px solid var(--border); padding-bottom: 0.4rem; }
        .pref-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .column-checkbox { display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem; background: #111; border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: background 0.2s; }
        .column-checkbox:hover { background: #1a1a1a; border-color: #444; }
        .column-checkbox input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--c-shop); cursor: pointer; }
        .column-checkbox label { margin: 0; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1; color: var(--text-main); font-weight: 500;}

        /* ===== MODALS & FORMS ===== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-sidebar); padding: 2rem; border-radius: var(--radius-lg); width: 90%; max-width: 550px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
        .modal-content.wide-modal { max-width: 700px; }
        .modal-content::-webkit-scrollbar { width: 6px; } .modal-content::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .modal-content h2 { font-family: 'Outfit', sans-serif; font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--text-main); }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;}
        .form-group { margin-bottom: 1rem; }
        label { display: block; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.4rem; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 0.8rem; background-color: #000; border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm); font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        input:focus, select:focus, textarea:focus { border-color: var(--c-shop); outline: none; }
        input::-webkit-calendar-picker-indicator { display: none !important; }
        input:disabled, select:disabled, textarea:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-primary { background: var(--text-main); color: #000; padding: 0.8rem 1.5rem; border: none; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; transition: transform 0.2s; white-space: nowrap;}
        .btn-primary:hover:not(:disabled) { background: #fff; transform: translateY(-1px); }
        .btn-outline { background: transparent; color: var(--text-main); padding: 0.8rem 1.5rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-weight: 500; cursor: pointer; transition: background 0.2s; white-space: nowrap;}
        .btn-outline:hover { background: rgba(255,255,255,0.05); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.8rem 1.5rem; border-radius: var(--radius-sm); cursor: pointer; transition: background 0.2s; }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

        .history-section { margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1.5rem; }
        .history-title { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; display: flex; justify-content: space-between; font-weight: 600; }
        .history-list { max-height: 120px; overflow-y: auto; background: #000; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.8rem; font-size: 0.8rem; }
        .history-item { display: flex; gap: 0.8rem; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .history-item:last-child { border-bottom: none; }

        /* Login & Toasts */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-container { background: var(--bg-card); border: 1px solid var(--border); padding: 3rem; border-radius: var(--radius-lg); width: 100%; max-width: 400px; text-align: center; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--text-main); color: #000; padding: 0.8rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.85rem; box-shadow: var(--shadow-lg); z-index: 200; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards; }
        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }

        /* ===== GRID VIEW CSS ===== */
        .grid-board { display: grid; grid-template-columns: repeat(var(--grid-cols, 3), 1fr); grid-auto-rows: 280px; gap: 1.2rem; padding: 1.5rem 2rem; overflow-y: auto; flex: 1; background: var(--bg-board); }

        .grid-board.cols-2 { --grid-cols: 2; }
        .grid-board.cols-3 { --grid-cols: 3; }
        .grid-board.cols-4 { --grid-cols: 4; }

        .vehicle-card.in-grid { grid-column: auto; grid-row: auto; height: 100%; width: 100%; }

        .grid-board.edit-mode .vehicle-card { border: 2px dashed var(--border); position: relative; }
        .grid-board.edit-mode .vehicle-card:hover { border-color: var(--text-muted); }

        .resize-handle { position: absolute; width: 16px; height: 16px; background: var(--accent); bottom: 0; right: 0; cursor: nwse-resize; opacity: 0; border-radius: 0 0 4px 0; }
        .grid-board.edit-mode .resize-handle { opacity: 0.7; }

        /* Responsive grid on smaller screens */
        @media (max-width: 1400px) { .grid-board.cols-4 { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .grid-board { grid-template-columns: repeat(2, 1fr); grid-auto-rows: 320px; } }
        @media (max-width: 600px) { .grid-board { grid-template-columns: 1fr; grid-auto-rows: 280px; } }

        /* ===== CARD LAYOUT EDITOR ===== */
        .card-layout-editor-wrap { display: grid; grid-template-columns: 220px 1fr; gap: 2rem; overflow: hidden; }

        /* Field palette ‚Äî the sidebar of available fields */
        .card-layout-palette {
            display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem;
            background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            border-radius: var(--radius-md); min-height: 180px;
            transition: background 0.2s;
        }
        .card-layout-palette.drag-over { background: rgba(74,222,128,0.08); border-color: var(--accent); }
        .palette-empty { font-size: 0.75rem; color: var(--text-muted); text-align: center; padding: 1rem; }

        /* Draggable field chips */
        .layout-field-chip {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.45rem 0.75rem; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-sm); cursor: grab; font-size: 0.8rem; color: var(--text-main);
            user-select: none; transition: all 0.15s; white-space: nowrap;
        }
        .layout-field-chip:hover { background: var(--bg-card-hover); border-color: #555; }
        .layout-field-chip.dragging { opacity: 0.4; cursor: grabbing; }
        .layout-field-chip .chip-icon { font-size: 1rem; flex-shrink: 0; }
        .layout-field-chip .chip-remove { margin-left: auto; opacity: 0; font-size: 0.9rem; cursor: pointer; color: var(--text-muted); transition: opacity 0.2s; }
        .layout-field-chip:hover .chip-remove { opacity: 0.7; }
        .layout-field-chip .chip-remove:hover { color: var(--c-urgent); opacity: 1; }

        /* The card preview with zones */
        .card-layout-preview {
            border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden;
            background: var(--bg-card); display: flex; flex-direction: column;
        }

        /* Individual drop zones */
        .card-zone-section { display: flex; gap: 0; border-bottom: 1px solid var(--border); }
        .card-zone-section:last-child { border-bottom: none; }

        .card-layout-zone {
            flex: 1; min-height: 52px; padding: 0.5rem 0.75rem;
            display: flex; flex-wrap: wrap; gap: 0.4rem; align-items: center;
            transition: background 0.2s, border-color 0.2s;
            position: relative;
        }
        .card-layout-zone.drag-over { background: rgba(74,222,128,0.08); }
        .card-layout-zone + .card-layout-zone { border-left: 1px solid var(--border); }

        .zone-label-strip {
            padding: 0.5rem 0.6rem; background: rgba(0,0,0,0.25);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: flex-start;
            justify-content: flex-start; min-width: 120px; flex-shrink: 0; gap: 0.4rem;
        }
        .zone-strip-name {
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: #555; white-space: nowrap;
        }
        .zone-flex-controls { display: flex; flex-direction: column; gap: 3px; width: 100%; }
        .zone-flex-row { display: flex; gap: 2px; flex-wrap: wrap; }
        .zone-ctrl {
            font-size: 0.68rem; padding: 2px 5px; background: transparent;
            border: 1px solid var(--border); border-radius: 3px; color: var(--text-muted);
            cursor: pointer; transition: all 0.1s; line-height: 1.3; font-family: 'JetBrains Mono', monospace;
        }
        .zone-ctrl:hover { color: var(--text-main); border-color: #555; background: rgba(255,255,255,0.05); }
        .zone-ctrl.active { background: var(--accent); color: #000 !important; border-color: var(--accent); font-weight: 700; }

        .zone-drop-hint {
            font-size: 0.7rem; color: #444; pointer-events: none;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            white-space: nowrap;
        }

        /* Chip in zone ‚Äî extended with font config row */
        .layout-field-chip.in-zone {
            flex-direction: column; align-items: stretch; padding: 0; gap: 0;
            white-space: normal; cursor: default;
        }
        .in-zone .chip-top {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.4rem 0.6rem; cursor: grab;
        }
        .in-zone .chip-top:active { cursor: grabbing; }
        .chip-cfg-row {
            display: flex; align-items: center; gap: 4px; padding: 0.3rem 0.6rem;
            background: rgba(0,0,0,0.2); border-top: 1px solid var(--border); flex-wrap: wrap;
        }
        .chip-cfg-group { display: flex; gap: 2px; }
        .chip-cfg-sep { width: 1px; height: 14px; background: var(--border); margin: 0 2px; flex-shrink: 0; }
        .chip-cfg-btn {
            font-size: 0.6rem; padding: 2px 5px; background: transparent;
            border: 1px solid var(--border); border-radius: 3px;
            color: var(--text-muted); cursor: pointer; transition: all 0.1s;
            font-family: 'JetBrains Mono', monospace; font-weight: 600; line-height: 1.3;
        }
        .chip-cfg-btn:hover { color: var(--text-main); border-color: #555; }
        .chip-cfg-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
    </style>
</head>
<body>

    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <h2 style="font-family:'Outfit'; margin-bottom:0.5rem;">REPAIR TERMINAL</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem; font-size:0.9rem;">Authorized Access Only</p>
            <div id="loginError" style="color:#f87171; font-size:0.8rem; margin-bottom:1rem;"></div>
            
            <div id="loginFormDiv" style="display:flex; flex-direction:column; gap:1rem;">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button class="btn-primary" onclick="handleLogin()">Enter Terminal</button>
                <button class="btn-outline" style="border:none; padding:0; font-size:0.8rem; color:var(--text-muted);" onclick="toggleLoginSignup()">Need an account? Request Access</button>
            </div>

            <div id="signupFormDiv" style="display:none; flex-direction:column; gap:1rem;">
                <input type="email" id="signupEmail" placeholder="Email address">
                <input type="password" id="signupPassword" placeholder="Create Password (min 6 chars)">
                <input type="password" id="signupPasswordConfirm" placeholder="Confirm Password">
                <button class="btn-primary" onclick="handleSignup()">Create Account</button>
                <button class="btn-outline" style="border:none; padding:0; font-size:0.8rem; color:var(--text-muted);" onclick="toggleLoginSignup()">Already have access? Sign In</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <!-- Offline Status Indicator -->
        <div id="offlineStatusBar" style="display:none; position:fixed; top:0; left:260px; right:0; background:rgba(239,68,68,0.95); border-bottom:2px solid var(--c-urgent); padding:0.75rem 2rem; color:#fff; font-weight:600; font-size:0.85rem; z-index:100; box-shadow:0 2px 8px rgba(0,0,0,0.3);">
            ‚ö†Ô∏è Offline Mode
        </div>

        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">RT</div>
                <h2>REPAIR TERMINAL</h2>
            </div>
            
            <div class="sidebar-search">
                <span style="opacity: 0.5;">üîç</span>
                <input type="text" id="searchInput" placeholder="Search..." onkeyup="renderCurrentView()">
            </div>

            <nav class="sidebar-nav">
                <a class="nav-item active" id="nav-workboard" onclick="switchView('workboard')">
                    <span class="icon">üìã</span> Workboard
                </a>
                <a class="nav-item" id="nav-analytics" onclick="switchView('analytics')">
                    <span class="icon">üìà</span> Analytics
                </a>
                <a class="nav-item" id="nav-database" onclick="switchView('database')">
                    <span class="icon">üóÑÔ∏è</span> Vehicle Database
                </a>
                <a class="nav-item" id="nav-add-unit" onclick="openModal('add')">
                    <span class="icon">‚ûï</span> Add Unit
                </a>

                <div class="nav-section">
                    <div class="submenu-label">HOME LOCATIONS</div>
                    <div id="locationSubmenu" class="nav-submenu"></div>
                </div>

                <div class="nav-section">
                    <div class="submenu-label">SYSTEM</div>
                    <a class="nav-item" id="nav-users" onclick="switchView('users')" style="display:none;">
                        <span class="icon">üë•</span> User Management
                    </a>
                    <a class="nav-item" onclick="handleLogout()"><span class="icon">üö™</span> Logout</a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <button class="user-profile">
                    <div class="avatar" id="userAvatar">U</div>
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span id="displayUserEmail" style="font-size:0.8rem; font-weight:600;">User</span>
                        <span id="displayUserRole" style="font-size:0.6rem; text-transform:uppercase; color:var(--accent);">Role</span>
                    </div>
                </button>
            </div>
        </aside>

        <main class="view-area active" id="view-workboard">
            <header class="board-header">
                <h1 id="boardTitle">Active Workboard</h1>
                <div class="board-filters">
                    <button class="filter-btn" id="btn-bulk" onclick="toggleBulkMode()" style="display:none;">‚òëÔ∏è Bulk Edit</button>
                    <div style="width: 1px; height: 20px; background: var(--border); margin: 0 0.2rem;" id="bulk-divider"></div>
                    <button class="filter-btn" id="btn-collapse-all" onclick="toggleGlobalCollapse()">‚äü Collapse All</button>
                    <button class="filter-btn" onclick="openPreferences()">üëÅ Display Prefs</button>
                    <button class="filter-btn" onclick="openCardLayoutEditor()" title="Customize what data appears on each card">üéõ Card Layout</button>
                    <div style="width: 1px; height: 20px; background: var(--border); margin: 0 0.2rem;"></div>
                    <button class="filter-btn" id="btn-sort-date" onclick="setSort('date')">üóì Date</button>
                    <button class="filter-btn active" id="btn-sort-priority" onclick="setSort('priority')">‚ö† Priority</button>
                    <button class="filter-btn" id="btn-sort-id" onclick="setSort('id')">üî¢ A-Z</button>
                    <button class="filter-btn" id="btn-sort-freeform" onclick="setSort('freeform')">ü§ö Freeform</button>
                </div>
            </header>

            <div class="kanban-board" id="kanbanBoard">
                <div class="kanban-column" id="col-wrapper-road">
                    <div class="column-header"><div class="col-header-left"><span class="status-dot" style="color: var(--c-road);"></span><span>On the Road</span><span class="column-count" id="count-road">0</span></div></div>
                    <div class="column-content" id="col-road" data-col="on_the_road"></div>
                </div>
                <div class="kanban-column" id="col-wrapper-complaints">
                    <div class="column-header"><div class="col-header-left"><span class="status-dot" style="color: var(--c-intake);"></span><span>Repair Complaints</span><span class="column-count" id="count-complaints">0</span></div></div>
                    <div class="column-content" id="col-complaints" data-col="complaints"></div>
                </div>
                <div class="kanban-column" id="col-wrapper-ready">
                    <div class="column-header"><div class="col-header-left"><span class="status-dot" style="color: var(--c-ready);"></span><span>Ready for Pickup</span><span class="column-count" id="count-ready">0</span></div></div>
                    <div class="column-content" id="col-ready" data-col="ready"></div>
                </div>
                <div class="kanban-column" id="col-wrapper-progress" style="min-width: 360px;">
                    <div class="column-header"><div class="col-header-left"><span class="status-dot" style="color: var(--c-shop);"></span><span>In Progress / Parts</span><span class="column-count" id="count-progress">0</span></div></div>
                    <div class="column-content" id="col-progress" data-col="progress"></div>
                </div>
            </div>

            <!-- Grid View Container -->
            <div class="grid-board cols-3" id="gridBoard" style="display:none;">
                <!-- Grid cards will be rendered here by JavaScript -->
            </div>

            <div id="bulkActionBar" class="bulk-action-bar">
                <span id="bulkCount" style="font-family: 'JetBrains Mono'; font-weight: bold; color: var(--c-shop); font-size: 0.9rem; min-width: 100px;">0 Selected</span>
                
                <select id="bulkStatus" class="role-select">
                    <option value="">-- Move Status To --</option>
                    <option value="On the road">On the Road</option>
                    <option value="Reported">Repair Complaints</option>
                    <option value="Ready for Pickup">Ready for Pickup</option>
                    <option value="Repair in Progress">In Progress</option>
                    <option value="Complete">Complete (Archive)</option>
                </select>

                <select id="bulkPriority" class="role-select">
                    <option value="">-- Set Priority --</option>
                    <option value="Urgent">üî¥ Urgent</option>
                    <option value="High">‚ö† High</option>
                    <option value="Oil Change / Bulb Replacement">üîß Maintenance</option>
                    <option value="Normal">Normal</option>
                </select>

                <input type="text" id="bulkLocation" class="role-select" placeholder="Assign Location..." style="width: 150px;">

                <button class="btn-primary" onclick="applyBulkActions()">Apply Action</button>
                <button class="btn-outline" onclick="toggleBulkMode()">Cancel</button>
            </div>
        </main>

        <main class="view-area" id="view-analytics">
            <header class="board-header">
                <h1>Analytics Dashboard</h1>
                <div class="board-filters">
                    <button class="filter-btn active">Live Metrics</button>
                </div>
            </header>
            <div class="analytics-grid" id="analyticsGrid">
                </div>
        </main>

        <main class="view-area" id="view-database">
            <header class="board-header">
                <h1>Fleet Database</h1>
                <div class="board-filters">
                    <button class="filter-btn active">All Vehicles</button>
                    <button class="filter-btn" id="fleetioSyncBtn" onclick="syncFleetioData()" style="color: var(--text-main); border-color: var(--c-shop);">
                        üîÑ Sync Fleetio
                    </button>
                </div>
            </header>
            <div class="db-container">
                <table class="db-table">
                    <thead>
                        <tr>
                            <th>Unit ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Mileage</th>
                            <th>Last Oil Change</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dbTableBody"></tbody>
                </table>
            </div>
        </main>

        <main class="view-area" id="view-users">
            <header class="board-header">
                <h1>User Management</h1>
                <div class="board-filters">
                    <button class="filter-btn" style="border-color: var(--accent); color: var(--text-main);" onclick="openUserModal()">+ Create New User</button>
                </div>
            </header>
            <div class="db-container">
                <table class="db-table">
                    <thead><tr><th>Email Address</th><th>User UID</th><th>Assigned Role</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="entryModal" class="modal-overlay" onclick="if(event.target===this)closeModal('entryModal')">
        <div class="modal-content">
            <h2 id="modalTitle">UNIT DETAILS</h2>
            <form id="vehicleForm" onsubmit="saveVehicle(event)">
                <input type="hidden" id="mode" value="add">
                <input type="hidden" id="targetDocId">
                <input type="hidden" id="vHistory">
                <input type="hidden" id="vStatusUpdatedAt">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Vehicle ID</label>
                        <input type="text" id="vID" list="syncedVehiclesList" autocomplete="off" required>
                        <datalist id="syncedVehiclesList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Vehicle Type</label>
                        <select id="vType">
                            <option value="">Select...</option><option value="Van">Van</option><option value="Prius">Prius</option><option value="Scion">Scion</option><option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="vPriority">
                            <option value="Urgent">üî¥ Urgent</option><option value="High">‚ö† High</option><option value="Oil Change / Bulb Replacement">üîß Maintenance</option><option value="Normal" selected>Normal</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Condition</label><select id="vStatus"><option value="Operational">Operational</option><option value="Warning">Warning</option><option value="Down">Down</option></select></div>
                </div>

                <div class="form-group"><label>Issue Description</label><input type="text" id="vIssue" required></div>
                <div class="form-group"><label>Notes / Updates</label><textarea id="vNotes" rows="3"></textarea></div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Shop Status</label>
                        <select id="vShopStatus" onchange="togglePartsFields()">
                            <option value="Reported">Reported</option><option value="Ready for Pickup">Ready for Pickup</option><option value="Received">Received</option><option value="Assessment">Assessment</option><option value="Awaiting part order">Awaiting part order</option><option value="Parts Received">Parts Received</option><option value="Repair in Progress">Repair in Progress</option><option value="Awaiting delivery">Awaiting delivery</option><option value="Complete">Complete (Remove from Board)</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Current Location</label><select id="vLocation"><option value="Dispatch Lot">Dispatch Lot</option><option value="On the road">On the road</option><option value="Pam (Ridesource, DMV)">Pam (Ridesource, DMV)</option><option value="Shop">Shop</option><option value="Paint">Paint</option><option value="Glass">Glass</option></select></div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer; color: var(--text-main);">
                        <input type="checkbox" id="vOnTheRoad" style="width: auto; margin: 0; accent-color: var(--text-main);">
                        <span>Flag as "On the Road"</span>
                    </label>
                </div>

                <div class="form-row">
                    <div class="form-group"><label>Home Location</label><input type="text" id="vHomeLocation" placeholder="e.g. Eugene"></div>
                    <div class="form-group"><label>Requested By</label><input type="text" id="vRequestedBy"></div>
                </div>
                
                <div id="partsSection" style="display: none; background: rgba(251,146,60,0.05); border: 1px dashed rgba(251,146,60,0.3); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.2rem;">
                    <div class="form-row">
                        <div class="form-group" style="margin:0;"><label>Parts Ordered</label><input type="date" id="vPartsOrdered"></div>
                        <div class="form-group" style="margin:0;"><label>ETA</label><input type="date" id="vPartsEta"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group"><label>Date In</label><input type="date" id="vDate" required></div>
                    <div class="form-group"><label>Inspection Date</label><input type="date" id="vInspectionDate"></div>
                </div>

                <div class="history-section" id="historySection">
                    <div class="history-title"><span>Activity Log</span> <span id="lastUpdatedBy" style="color:var(--text-main); font-weight: normal;"></span></div>
                    <div class="history-list" id="historyList"></div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                    <button type="button" class="btn-danger" id="deleteBtn" onclick="deleteCurrent()" style="margin-right:auto;">Delete</button>
                    <button type="button" class="btn-outline" onclick="closeModal('entryModal')">Cancel</button>
                    <button type="submit" class="btn-primary" id="saveBtn">Save Ticket</button>
                </div>
            </form>
        </div>
    </div>

    <div id="dbModal" class="modal-overlay" onclick="if(event.target===this)closeModal('dbModal')">
        <div class="modal-content">
            <h2>DATABASE RECORD</h2>
            <form onsubmit="saveDbRecord(event)">
                <input type="hidden" id="dbTargetDocId">
                <div class="form-row">
                    <div class="form-group"><label>Vehicle ID</label><input type="text" id="dbID" required></div>
                    <div class="form-group"><label>Current Mileage</label><input type="number" id="dbMileage" placeholder="e.g. 150000"></div>
                </div>
                <div class="form-group"><label>Last Oil Change (Date)</label><input type="date" id="dbOilChange"></div>
                <div class="form-group"><label>Accident History</label><textarea id="dbAccident" rows="3" placeholder="Log any major collisions or body damage..."></textarea></div>
                <div class="form-group"><label>Major Repair History</label><textarea id="dbRepairs" rows="4" placeholder="Engine replacements, transmission rebuilds, etc..."></textarea></div>

                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                    <button type="button" class="btn-outline" onclick="startRepairFromDb()" id="startRepairBtn" style="margin-right:auto; color: #60a5fa; border-color: rgba(96,165,250,0.4);">üìã Create Repair Ticket</button>
                    <button type="button" class="btn-outline" onclick="closeModal('dbModal')">Cancel</button>
                    <button type="submit" class="btn-primary" id="dbSaveBtn">Save Record</button>
                </div>
            </form>
        </div>
    </div>

    <div id="preferencesModal" class="modal-overlay" onclick="if(event.target===this)closeModal('preferencesModal')">
        <div class="modal-content wide-modal">
            <h2>DISPLAY PREFERENCES</h2>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 2rem;">Customize your terminal view. These settings are saved to your account.</p>
            
            <div class="pref-section-title">Display Mode</div>
            <div style="margin-bottom: 2rem; display:flex; gap:2rem;">
                <label style="display:flex; align-items:center; gap:0.6rem; cursor:pointer;">
                    <input type="radio" name="displayMode" value="kanban" checked> Kanban Board
                </label>
                <label style="display:flex; align-items:center; gap:0.6rem; cursor:pointer;">
                    <input type="radio" name="displayMode" value="grid"> Grid View
                </label>
            </div>

            <div id="gridDensitySection" style="display:none; margin-bottom:2rem;">
                <div class="pref-section-title">Grid Density (columns)</div>
                <select id="gridColumns" style="width:100%; padding:0.5rem; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main); border-radius:6px;">
                    <option value="2">2 Columns</option>
                    <option value="3" selected>3 Columns</option>
                    <option value="4">4 Columns</option>
                </select>
            </div>

            <div class="pref-section-title">Board Columns</div>
            <div class="pref-grid" style="margin-bottom: 2rem;">
                <div class="column-checkbox"><input type="checkbox" id="pref-col-road"><label for="pref-col-road"><span class="status-dot" style="color: var(--c-road);"></span> On the Road</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-col-complaints"><label for="pref-col-complaints"><span class="status-dot" style="color: var(--c-intake);"></span> Repair Complaints</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-col-ready"><label for="pref-col-ready"><span class="status-dot" style="color: var(--c-ready);"></span> Ready for Pickup</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-col-progress"><label for="pref-col-progress"><span class="status-dot" style="color: var(--c-shop);"></span> In Progress / Parts</label></div>
            </div>

            <div class="pref-section-title">Card Data Toggles</div>
            <div class="pref-grid" style="margin-bottom: 2.5rem;">
                <div class="column-checkbox"><input type="checkbox" id="pref-card-issue"><label for="pref-card-issue">Issue Description</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-card-location"><label for="pref-card-location">Home Location üè†</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-card-status"><label for="pref-card-status">Shop Status</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-card-mileage"><label for="pref-card-mileage">Mileage üõ£Ô∏è</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-card-age"><label for="pref-card-age">Time in Shop ‚è≥</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-card-inspection"><label for="pref-card-inspection">Inspection Date üîç</label></div>
                <div class="column-checkbox"><input type="checkbox" id="pref-card-progress"><label for="pref-card-progress">Visual Progress Bar</label></div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:1rem;">
                <button class="btn-outline" onclick="closeModal('preferencesModal')">Cancel</button>
                <button class="btn-primary" onclick="savePreferences()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- ===== CARD LAYOUT EDITOR MODAL ===== -->
    <div id="cardLayoutModal" class="modal-overlay" onclick="if(event.target===this)closeModal('cardLayoutModal')">
        <div class="modal-content" style="max-width:960px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1.5rem; flex-shrink:0;">
                <div>
                    <h2>CARD LAYOUT EDITOR</h2>
                    <p style="color:var(--text-muted); font-size:0.8rem; margin-top:0.5rem;">
                        Drag fields from the palette into any zone on the card. Remove them by clicking ‚úï. Changes apply to all cards.
                    </p>
                </div>
                <button class="btn-outline" style="flex-shrink:0; margin-left:2rem;" onclick="resetCardLayout()">‚Ü∫ Reset Defaults</button>
            </div>

            <div class="card-layout-editor-wrap" style="flex:1; overflow:hidden; min-height:0;">

                <!-- LEFT: Field Palette -->
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <div class="pref-section-title" style="margin-top:0;">Available Fields</div>
                    <p style="font-size:0.72rem; color:var(--text-muted); margin-bottom:0.75rem;">Drag onto the card ‚Üí</p>
                    <div id="cardFieldPalette" class="card-layout-palette"
                         ondragover="cleDragOver(event,this)" ondragleave="cleDragLeave(event,this)" ondrop="cleDropToPalette(event)">
                        <span class="palette-empty">All fields are placed on the card</span>
                    </div>
                </div>

                <!-- RIGHT: Card Preview with drop zones -->
                <div style="display:flex; flex-direction:column; overflow:hidden; min-height:0;">
                    <div class="pref-section-title" style="margin-top:0;">Card Preview ‚Äî Drop Fields Here</div>
                    <div class="card-layout-preview" style="flex:1; overflow-y:auto;">

                        <!-- HEADER ROW: splits into left + right -->
                        <div class="card-zone-section">
                            <div class="zone-label-strip" id="cls-header-left">Header Left</div>
                            <div class="card-layout-zone" id="clz-header-left" data-zone="header-left"
                                 ondragover="cleDragOver(event,this)" ondragleave="cleDragLeave(event,this)" ondrop="cleDropToZone(event,'header-left')">
                                <span class="zone-drop-hint">vehicle #, type‚Ä¶</span>
                            </div>
                            <div class="zone-label-strip" id="cls-header-right" style="border-left:1px solid var(--border); border-right:none;">Header Right</div>
                            <div class="card-layout-zone" id="clz-header-right" data-zone="header-right"
                                 ondragover="cleDragOver(event,this)" ondragleave="cleDragLeave(event,this)" ondrop="cleDropToZone(event,'header-right')">
                                <span class="zone-drop-hint">avatar, badge‚Ä¶</span>
                            </div>
                        </div>

                        <!-- ROW 1 -->
                        <div class="card-zone-section">
                            <div class="zone-label-strip" id="cls-row-1">Row 1</div>
                            <div class="card-layout-zone" id="clz-row-1" data-zone="row-1"
                                 ondragover="cleDragOver(event,this)" ondragleave="cleDragLeave(event,this)" ondrop="cleDropToZone(event,'row-1')">
                                <span class="zone-drop-hint">location, mileage‚Ä¶</span>
                            </div>
                        </div>

                        <!-- ROW 2 -->
                        <div class="card-zone-section">
                            <div class="zone-label-strip" id="cls-row-2">Row 2</div>
                            <div class="card-layout-zone" id="clz-row-2" data-zone="row-2"
                                 ondragover="cleDragOver(event,this)" ondragleave="cleDragLeave(event,this)" ondrop="cleDropToZone(event,'row-2')">
                                <span class="zone-drop-hint">inspection, status‚Ä¶</span>
                            </div>
                        </div>

                        <!-- TICKETS ZONE -->
                        <div class="card-zone-section">
                            <div class="zone-label-strip" id="cls-tickets">Tickets</div>
                            <div class="card-layout-zone" id="clz-tickets" data-zone="tickets"
                                 style="min-height:64px;"
                                 ondragover="cleDragOver(event,this)" ondragleave="cleDragLeave(event,this)" ondrop="cleDropToZone(event,'tickets')">
                                <span class="zone-drop-hint">issue, days, status‚Ä¶</span>
                            </div>
                        </div>

                        <!-- FOOTER -->
                        <div class="card-zone-section" style="border-bottom:none;">
                            <div class="zone-label-strip" id="cls-footer">Footer</div>
                            <div class="card-layout-zone" id="clz-footer" data-zone="footer"
                                 ondragover="cleDragOver(event,this)" ondragleave="cleDragLeave(event,this)" ondrop="cleDropToZone(event,'footer')">
                                <span class="zone-drop-hint">progress bar‚Ä¶</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:1.5rem; flex-shrink:0;">
                <button class="btn-outline" onclick="closeModal('cardLayoutModal')">Cancel</button>
                <button class="btn-primary" onclick="saveCardLayout()">Save Layout</button>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal-overlay" onclick="if(event.target===this)closeModal('userModal')">
        <div class="modal-content" style="max-width: 400px;">
            <h2>CREATE NEW USER</h2>
            <form onsubmit="createNewUser(event)">
                <div class="form-group"><label>Email Address</label><input type="email" id="newAccEmail" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="newAccPassword" required minlength="6"></div>
                <div class="form-group">
                    <label>Assign Role</label>
                    <select id="newAccRole">
                        <option value="viewer">Viewer (Read-Only)</option>
                        <option value="standard">Standard (Edit, No Delete)</option>
                        <option value="admin">Admin (Full Access)</option>
                    </select>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                    <button type="button" class="btn-outline" onclick="closeModal('userModal')">Cancel</button>
                    <button type="submit" class="btn-primary" id="createUserBtn">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <div id="syncLogModal" class="modal-overlay" onclick="if(event.target===this)closeModal('syncLogModal')">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="color: var(--c-shop);">FLEETIO SYNC LOGBOOK</h2>
            <div id="syncLogStats" style="display:flex; flex-wrap:wrap; gap:1.5rem; margin-bottom: 1rem; padding: 1rem; background: #000; border-radius: var(--radius-sm); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; border: 1px solid var(--border);"></div>
            <div id="syncLogDetails" style="max-height: 400px; overflow-y: auto; background: #111; padding: 1rem; border-radius: var(--radius-sm); border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; white-space: pre-wrap; color: #ccc; line-height: 1.6;"></div>
            <div style="display:flex; justify-content:flex-end; margin-top:1.5rem;">
                <button type="button" class="btn-primary" onclick="closeModal('syncLogModal')">Close Logbook</button>
            </div>
        </div>
    </div>

    <script>
        const FLEETIO_API_KEY = 'fa387224226d63ffa24676b5576793283d70fef4';
        const FLEETIO_ACCOUNT_TOKEN = '82be379dc8';

        const firebaseConfig = {
            apiKey: "AIzaSyCnH_ILuDyJB1mC0iBlrfYIAFVumD74yo4",
            authDomain: "dlx-dmt-tracker.firebaseapp.com",
            projectId: "dlx-dmt-tracker",
            storageBucket: "dlx-dmt-tracker.firebasestorage.app",
            messagingSenderId: "958627003202",
            appId: "1:958627003202:web:07ea8476831ef49e4ea6db"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");

        // ===== SERVICE LAYER CLASSES =====

        // StorageService: Wrapper around localStorage with validation
        class StorageService {
            setItem(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Storage error:', e);
                    return false;
                }
            }
            getItem(key) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    console.error('Storage error:', e);
                    return null;
                }
            }
            removeItem(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('Storage error:', e);
                    return false;
                }
            }
        }

        // UtilityService: Common utility functions
        class UtilityService {
            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: '2-digit' });
            }

            createLogEntry(action, description) {
                const timestamp = new Date().toISOString();
                return { action, description, timestamp, user: currentUserId };
            }

            parseHistory(json) {
                try {
                    return JSON.parse(json);
                } catch (e) {
                    return [];
                }
            }

            getUsername() {
                const user = auth.currentUser;
                return user ? user.email.split('@')[0] : 'Unknown';
            }

            getAgeTags(vehicle) {
                if (!vehicle.intakeDate) return [];
                const now = new Date();
                const intake = new Date(vehicle.intakeDate);
                const daysDiff = Math.floor((now - intake) / (1000 * 60 * 60 * 24));

                const tags = [];
                if (daysDiff >= 14) tags.push('‚ö†Ô∏è 14d+');
                else if (daysDiff >= 7) tags.push('‚ö° 7d+');
                return tags;
            }

            calculateDaysSince(dateString) {
                if (!dateString) return 0;
                const now = new Date();
                const date = new Date(dateString);
                return Math.floor((now - date) / (1000 * 60 * 60 * 24));
            }

            formatMileage(mileage) {
                if (!mileage) return '-';
                return mileage.toLocaleString();
            }

            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        }

        // GridLayoutService: Manage grid layouts and persistence
        class GridLayoutService {
            constructor(userId) {
                this.userId = userId;
                this.currentLayout = null;
                this.layoutCache = new Map();
            }

            async loadUserLayouts() {
                try {
                    const snap = await db.collection('users').doc(this.userId)
                        .collection('gridLayouts').get();

                    this.layoutCache.clear();
                    snap.forEach(doc => {
                        this.layoutCache.set(doc.id, doc.data());
                    });
                    return Array.from(this.layoutCache.values());
                } catch (e) {
                    console.error('Error loading layouts:', e);
                    return [];
                }
            }

            async saveLayout(name, gridColumns, componentPositions) {
                try {
                    const layoutId = this.utils?.generateUUID?.() || Date.now().toString();
                    const layoutData = {
                        name,
                        gridColumns,
                        componentPositions: componentPositions || {},
                        appliedCount: 0,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    await db.collection('users').doc(this.userId)
                        .collection('gridLayouts').doc(layoutId).set(layoutData);

                    this.layoutCache.set(layoutId, layoutData);
                    return layoutId;
                } catch (e) {
                    console.error('Error saving layout:', e);
                    return null;
                }
            }

            async loadLayout(layoutId) {
                try {
                    if (this.layoutCache.has(layoutId)) {
                        return this.layoutCache.get(layoutId);
                    }

                    const doc = await db.collection('users').doc(this.userId)
                        .collection('gridLayouts').doc(layoutId).get();

                    if (doc.exists) {
                        const data = doc.data();
                        this.layoutCache.set(layoutId, data);
                        this.currentLayout = data;
                        return data;
                    }
                    return null;
                } catch (e) {
                    console.error('Error loading layout:', e);
                    return null;
                }
            }

            async deleteLayout(layoutId) {
                try {
                    await db.collection('users').doc(this.userId)
                        .collection('gridLayouts').doc(layoutId).delete();

                    this.layoutCache.delete(layoutId);
                    return true;
                } catch (e) {
                    console.error('Error deleting layout:', e);
                    return false;
                }
            }
        }

        // OfflineQueueService: Manage offline write queue
        class OfflineQueueService {
            constructor(userId) {
                this.userId = userId;
                this.queue = [];
                this.isOnline = navigator.onLine;
                this.syncInProgress = false;
                this.utils = new UtilityService();
                this.storage = new StorageService();

                this.setupNetworkListener();
                this.loadQueue();
            }

            setupNetworkListener() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('‚úì Back online');
                    this.flushQueue();
                    this.updateOfflineIndicator();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('‚úó Offline mode');
                    this.updateOfflineIndicator();
                });
            }

            loadQueue() {
                const key = `dlx_offlineQueue_${this.userId}`;
                const saved = this.storage.getItem(key) || [];
                this.queue = saved;
                this.updateOfflineIndicator();
            }

            saveQueue() {
                const key = `dlx_offlineQueue_${this.userId}`;
                this.storage.setItem(key, this.queue);
            }

            queueWrite(collection, docId, data, operation = 'update') {
                const operation_item = {
                    id: this.utils.generateUUID(),
                    collection,
                    docId,
                    data,
                    operation,
                    timestamp: Date.now(),
                    status: 'pending',
                    retryCount: 0,
                    versionTag: `v_${Date.now()}`
                };

                this.queue.push(operation_item);

                // Limit queue to 50 items
                if (this.queue.length > 50) {
                    const removed = this.queue.shift();
                    console.log('Queue limit exceeded, removed:', removed.id);
                }

                this.saveQueue();
                this.updateOfflineIndicator();
            }

            async flushQueue() {
                if (this.syncInProgress || this.queue.length === 0 || !this.isOnline) {
                    return;
                }

                this.syncInProgress = true;
                let synced = 0;
                let failed = 0;

                for (let i = 0; i < this.queue.length; i++) {
                    const item = this.queue[i];
                    if (item.status === 'synced') continue;

                    try {
                        const ref = db.collection(item.collection).doc(item.docId);

                        if (item.operation === 'update') {
                            await ref.update(item.data);
                        } else if (item.operation === 'set') {
                            await ref.set(item.data);
                        } else if (item.operation === 'delete') {
                            await ref.delete();
                        }

                        item.status = 'synced';
                        synced++;
                    } catch (error) {
                        item.retryCount++;
                        item.error = error.message;

                        if (item.retryCount > 3) {
                            item.status = 'failed';
                            failed++;
                        }
                    }
                }

                // Remove synced items and keep failed/pending for retry
                this.queue = this.queue.filter(item => item.status !== 'synced');
                this.saveQueue();

                this.syncInProgress = false;
                this.updateOfflineIndicator();

                if (synced > 0) {
                    showToast(`‚úì Synced ${synced} ${synced === 1 ? 'change' : 'changes'}`);
                }
                if (failed > 0) {
                    showToast(`‚ö†Ô∏è ${failed} ${failed === 1 ? 'change' : 'changes'} failed to sync`);
                }
            }

            getPendingCount() {
                return this.queue.filter(item => item.status === 'pending').length;
            }

            updateOfflineIndicator() {
                const indicator = document.getElementById('offlineStatusBar');
                const pendingCount = this.getPendingCount();

                if (!this.isOnline) {
                    if (indicator) {
                        indicator.style.display = 'block';
                        indicator.textContent = `‚ö†Ô∏è Offline Mode - ${pendingCount} pending changes`;
                    }
                } else if (pendingCount > 0) {
                    if (indicator) {
                        indicator.style.display = 'block';
                        indicator.textContent = `üì° Syncing... ${pendingCount} pending`;
                    }
                } else {
                    if (indicator) {
                        indicator.style.display = 'none';
                    }
                }
            }
        }

        // ===== END SERVICE LAYER =====

        // ===== CARD LAYOUT EDITOR =====

        // Render a field chip element (draggable tag shown in palette or zones)
        // Get current field config (fontSize key, fontWeight key)
        function cleGetFieldCfg(fieldId) {
            const layout = userPrefs.cardLayout || {};
            const saved = (layout.fieldConfig || {})[fieldId];
            const dflt  = DEFAULT_FIELD_CONFIG[fieldId] || { fontSize: 'md', fontWeight: 'normal' };
            return Object.assign({}, dflt, saved);
        }

        // Get current zone flex config
        function cleGetZoneCfg(zoneId) {
            const layout = userPrefs.cardLayout || {};
            const saved  = (layout.zoneConfig || {})[zoneId];
            const dflt   = DEFAULT_ZONE_CONFIG[zoneId] || { flexDir: 'row', justify: 'flex-start', align: 'center', wrap: 'wrap' };
            return Object.assign({}, dflt, saved);
        }

        // Build a chip ‚Äî palette chips are simple; zone chips include the font-config row
        function cleCreateChip(fieldId, inZone = false) {
            const field = CARD_FIELD_REGISTRY[fieldId];
            if (!field) return null;

            const chip = document.createElement('div');
            chip.className = 'layout-field-chip' + (inZone ? ' in-zone' : '');
            chip.draggable = true;
            chip.dataset.fieldId = fieldId;

            if (inZone) {
                const cfg = cleGetFieldCfg(fieldId);
                const sizes = ['xs','sm','md','lg','xl'];
                const weights = ['normal','semibold','bold'];
                const szBtns = sizes.map(s =>
                    `<button class="chip-cfg-btn${cfg.fontSize===s?' active':''}" onclick="cleSetFieldProp(event,'${fieldId}','fontSize','${s}')">${s.toUpperCase()}</button>`
                ).join('');
                const wtBtns = weights.map(w =>
                    `<button class="chip-cfg-btn${cfg.fontWeight===w?' active':''}" onclick="cleSetFieldProp(event,'${fieldId}','fontWeight','${w}')">${w==='normal'?'N':w==='semibold'?'SB':'B'}</button>`
                ).join('');

                chip.innerHTML = `
                    <div class="chip-top">
                        <span class="chip-icon">${field.icon}</span>
                        <span style="flex:1; font-size:0.8rem;">${field.label}</span>
                        <span class="chip-remove" title="Remove to palette" onclick="cleRemoveChip(event,'${fieldId}')">‚úï</span>
                    </div>
                    <div class="chip-cfg-row">
                        <div class="chip-cfg-group">${szBtns}</div>
                        <div class="chip-cfg-sep"></div>
                        <div class="chip-cfg-group">${wtBtns}</div>
                    </div>`;

                // Only the chip-top row initiates drag
                chip.querySelector('.chip-top').ondragstart = (e) => {
                    e.stopPropagation();
                    e.dataTransfer.setData('cle-fieldId', fieldId);
                    const zone = chip.closest('.card-layout-zone');
                    e.dataTransfer.setData('cle-source', zone ? zone.dataset.zone : 'palette');
                    setTimeout(() => chip.classList.add('dragging'), 0);
                };
                chip.draggable = false; // disable on wrapper; enable only on chip-top
                chip.querySelector('.chip-top').draggable = true;
            } else {
                chip.innerHTML = `<span class="chip-icon">${field.icon}</span><span style="font-size:0.8rem;">${field.label}</span><span class="chip-remove" title="Remove" onclick="cleRemoveChip(event,'${fieldId}')">‚úï</span>`;
                chip.ondragstart = (e) => {
                    e.dataTransfer.setData('cle-fieldId', fieldId);
                    e.dataTransfer.setData('cle-source', 'palette');
                    setTimeout(() => chip.classList.add('dragging'), 0);
                };
            }

            chip.ondragend = () => chip.classList.remove('dragging');
            return chip;
        }

        // Update a field's fontSize or fontWeight, refresh chip buttons
        function cleSetFieldProp(event, fieldId, prop, val) {
            event.stopPropagation();
            if (!userPrefs.cardLayout) userPrefs.cardLayout = JSON.parse(JSON.stringify(DEFAULT_CARD_LAYOUT));
            if (!userPrefs.cardLayout.fieldConfig) userPrefs.cardLayout.fieldConfig = {};
            if (!userPrefs.cardLayout.fieldConfig[fieldId]) userPrefs.cardLayout.fieldConfig[fieldId] = cleGetFieldCfg(fieldId);
            userPrefs.cardLayout.fieldConfig[fieldId][prop] = val;

            // Refresh only the buttons in this chip
            const chip = event.target.closest('.layout-field-chip');
            if (!chip) return;
            chip.querySelectorAll('.chip-cfg-btn').forEach(btn => {
                const btnProp = btn.closest('.chip-cfg-group') === btn.closest('.chip-cfg-row').querySelector('.chip-cfg-group:first-child') ? 'fontSize' : 'fontWeight';
                const btnVal  = btn.textContent === 'N' ? 'normal' : btn.textContent === 'SB' ? 'semibold' : btn.textContent === 'B' ? 'bold' : btn.textContent.toLowerCase();
                btn.classList.toggle('active', btnProp === prop ? btnVal === val : btnVal === cleGetFieldCfg(fieldId)[btnProp]);
            });
        }

        // Update a zone's flex prop (flexDir, justify, align, wrap), refresh its zone-strip buttons
        function cleSetZoneProp(event, zoneId, prop, val) {
            event.stopPropagation();
            if (!userPrefs.cardLayout) userPrefs.cardLayout = JSON.parse(JSON.stringify(DEFAULT_CARD_LAYOUT));
            if (!userPrefs.cardLayout.zoneConfig) userPrefs.cardLayout.zoneConfig = {};
            if (!userPrefs.cardLayout.zoneConfig[zoneId]) userPrefs.cardLayout.zoneConfig[zoneId] = cleGetZoneCfg(zoneId);
            userPrefs.cardLayout.zoneConfig[zoneId][prop] = val;
            cleRefreshZoneStrip(zoneId);
        }

        // Rebuild zone-label-strip contents for one zone (name + flex control buttons with active states)
        function cleRefreshZoneStrip(zoneId) {
            const strip = document.getElementById(`cls-${zoneId}`);
            if (!strip) return;
            const cfg = cleGetZoneCfg(zoneId);
            const zoneName = { 'header-left':'Header Left','header-right':'Header Right','row-1':'Row 1','row-2':'Row 2','tickets':'Tickets','footer':'Footer' }[zoneId] || zoneId;

            const dir = [
                `<button class="zone-ctrl${cfg.flexDir==='row'?' active':''}" onclick="cleSetZoneProp(event,'${zoneId}','flexDir','row')" title="Row (‚Üí)">‚áÑ</button>`,
                `<button class="zone-ctrl${cfg.flexDir==='column'?' active':''}" onclick="cleSetZoneProp(event,'${zoneId}','flexDir','column')" title="Column (‚Üì)">‚áÖ</button>`
            ].join('');

            const just = [
                {v:'flex-start', l:'‚ä£', t:'Start'},{v:'center', l:'‚ä°', t:'Center'},
                {v:'flex-end', l:'‚ä¢', t:'End'},{v:'space-between', l:'‚ü∫', t:'Spread'}
            ].map(o => `<button class="zone-ctrl${cfg.justify===o.v?' active':''}" onclick="cleSetZoneProp(event,'${zoneId}','justify','${o.v}')" title="${o.t}">${o.l}</button>`).join('');

            const aln = [
                {v:'flex-start', l:'‚åÖ', t:'Align start'},{v:'center', l:'‚äï', t:'Align center'},
                {v:'flex-end', l:'‚åÜ', t:'Align end'},{v:'stretch', l:'‚ü∑', t:'Stretch'}
            ].map(o => `<button class="zone-ctrl${cfg.align===o.v?' active':''}" onclick="cleSetZoneProp(event,'${zoneId}','align','${o.v}')" title="${o.t}">${o.l}</button>`).join('');

            const wrp = `<button class="zone-ctrl${cfg.wrap==='wrap'?' active':''}" onclick="cleSetZoneProp(event,'${zoneId}','wrap','wrap')" title="Wrap">‚Üµ</button>` +
                        `<button class="zone-ctrl${cfg.wrap==='nowrap'?' active':''}" onclick="cleSetZoneProp(event,'${zoneId}','wrap','nowrap')" title="No wrap">‚Äî</button>`;

            strip.innerHTML = `
                <span class="zone-strip-name">${zoneName}</span>
                <div class="zone-flex-controls">
                    <div class="zone-flex-row">${dir}</div>
                    <div class="zone-flex-row">${just}</div>
                    <div class="zone-flex-row">${aln}</div>
                    <div class="zone-flex-row">${wrp}</div>
                </div>`;
        }

        // Remove a chip from a zone (sends it back to palette)
        function cleRemoveChip(event, fieldId) {
            event.stopPropagation();
            const chip = event.target.closest('.layout-field-chip');
            if (chip) chip.remove();
            // Re-add to palette if not already there
            const palette = document.getElementById('cardFieldPalette');
            if (!palette.querySelector(`[data-field-id="${fieldId}"]`)) {
                palette.appendChild(cleCreateChip(fieldId));
            }
            cleRefreshPaletteHint();
        }

        // Drag-over visual feedback
        function cleDragOver(e, el) {
            e.preventDefault();
            el.classList.add('drag-over');
        }
        function cleDragLeave(e, el) {
            if (!el.contains(e.relatedTarget)) el.classList.remove('drag-over');
        }

        // Drop onto a card zone
        function cleDropToZone(e, targetZone) {
            e.preventDefault();
            const zoneEl = document.getElementById(`clz-${targetZone}`);
            if (zoneEl) zoneEl.classList.remove('drag-over');

            const fieldId = e.dataTransfer.getData('cle-fieldId');
            const sourceZone = e.dataTransfer.getData('cle-source');
            if (!fieldId) return;

            // If field is already in this zone, do nothing
            const existing = zoneEl && zoneEl.querySelector(`[data-field-id="${fieldId}"]`);
            if (existing) return;

            // Remove from source
            if (sourceZone === 'palette') {
                const old = document.querySelector(`#cardFieldPalette [data-field-id="${fieldId}"]`);
                if (old) old.remove();
            } else {
                const srcEl = document.getElementById(`clz-${sourceZone}`);
                if (srcEl) { const old = srcEl.querySelector(`[data-field-id="${fieldId}"]`); if (old) old.remove(); }
            }

            // Add new chip to target zone (with in-zone config row)
            if (zoneEl) zoneEl.appendChild(cleCreateChip(fieldId, true));
            cleRefreshPaletteHint();
        }

        // Drop back to palette (palette chips are simple ‚Äî no config row)
        function cleDropToPalette(e) {
            e.preventDefault();
            const palette = document.getElementById('cardFieldPalette');
            palette.classList.remove('drag-over');

            const fieldId = e.dataTransfer.getData('cle-fieldId');
            const sourceZone = e.dataTransfer.getData('cle-source');
            if (!fieldId || sourceZone === 'palette') return;

            const srcEl = document.getElementById(`clz-${sourceZone}`);
            if (srcEl) { const old = srcEl.querySelector(`[data-field-id="${fieldId}"]`); if (old) old.remove(); }

            if (!palette.querySelector(`[data-field-id="${fieldId}"]`)) {
                palette.appendChild(cleCreateChip(fieldId, false));
            }
            cleRefreshPaletteHint();
        }

        // Show/hide the "all fields placed" hint in palette
        function cleRefreshPaletteHint() {
            const palette = document.getElementById('cardFieldPalette');
            if (!palette) return;
            const chips = palette.querySelectorAll('.layout-field-chip');
            let hint = palette.querySelector('.palette-empty');
            if (chips.length === 0) {
                if (!hint) { hint = document.createElement('span'); hint.className = 'palette-empty'; hint.textContent = 'All fields placed on card'; palette.appendChild(hint); }
            } else if (hint) { hint.remove(); }
        }

        const CLE_ZONES = ['header-left', 'header-right', 'row-1', 'row-2', 'tickets', 'footer'];

        function openCardLayoutEditor() {
            // Ensure userPrefs.cardLayout exists
            if (!userPrefs.cardLayout) userPrefs.cardLayout = JSON.parse(JSON.stringify(DEFAULT_CARD_LAYOUT));
            const layout = userPrefs.cardLayout;

            // Inject zone flex controls into each label strip and clear zones
            CLE_ZONES.forEach(z => {
                cleRefreshZoneStrip(z);
                const el = document.getElementById(`clz-${z}`);
                if (el) el.innerHTML = '';
            });

            // Populate zones with in-zone chips (with config rows)
            const placed = new Set();
            CLE_ZONES.forEach(z => {
                const el = document.getElementById(`clz-${z}`);
                const fieldIds = (layout.zones && layout.zones[z]) || [];
                fieldIds.forEach(fId => {
                    if (CARD_FIELD_REGISTRY[fId] && el) {
                        el.appendChild(cleCreateChip(fId, true));
                        placed.add(fId);
                    }
                });
            });

            // Populate palette with unplaced fields (simple chips)
            const palette = document.getElementById('cardFieldPalette');
            palette.innerHTML = '';
            Object.keys(CARD_FIELD_REGISTRY).forEach(fId => {
                if (!placed.has(fId)) palette.appendChild(cleCreateChip(fId, false));
            });
            cleRefreshPaletteHint();

            document.getElementById('cardLayoutModal').style.display = 'flex';
        }

        function resetCardLayout() {
            userPrefs.cardLayout = JSON.parse(JSON.stringify(DEFAULT_CARD_LAYOUT));
            userPrefs.cardLayout.fieldConfig = JSON.parse(JSON.stringify(DEFAULT_FIELD_CONFIG));
            userPrefs.cardLayout.zoneConfig  = JSON.parse(JSON.stringify(DEFAULT_ZONE_CONFIG));
            openCardLayoutEditor();
            showToast('‚Ü∫ Layout reset to defaults');
        }

        function saveCardLayout() {
            if (!userPrefs.cardLayout) userPrefs.cardLayout = {};

            // Collect zone field order
            const zones = {};
            CLE_ZONES.forEach(z => {
                const el = document.getElementById(`clz-${z}`);
                if (el) zones[z] = Array.from(el.querySelectorAll('.layout-field-chip')).map(c => c.dataset.fieldId);
            });
            userPrefs.cardLayout.zones = zones;

            // fieldConfig and zoneConfig are already live in userPrefs.cardLayout
            // (updated immediately by cleSetFieldProp / cleSetZoneProp)
            if (currentUserId) localStorage.setItem(`dlx_prefs_${currentUserId}`, JSON.stringify(userPrefs));
            closeModal('cardLayoutModal');
            renderCurrentView();
            showToast('‚úì Card Layout Saved');
        }

        // Render a single card's HTML using the user's custom zone layout, font sizes, and flex config
        function renderCardFromLayout(groupData, colId) {
            const layout    = userPrefs.cardLayout || DEFAULT_CARD_LAYOUT;
            const zones     = layout.zones      || DEFAULT_CARD_LAYOUT.zones;
            const fieldCfgs = layout.fieldConfig || {};
            const zoneCfgs  = layout.zoneConfig  || {};

            const g = Object.assign({}, groupData, { _colId: colId });

            // Render one field, wrapping it in a span with its font size and weight applied
            const renderField = (fId) => {
                const field = CARD_FIELD_REGISTRY[fId];
                if (!field) return '';
                let html;
                try { html = field.render(g) || ''; } catch(e) { html = ''; }
                if (!html) return '';

                const dflt = DEFAULT_FIELD_CONFIG[fId] || { fontSize: 'md', fontWeight: 'normal' };
                const cfg  = Object.assign({}, dflt, fieldCfgs[fId] || {});
                const fs   = CLE_FONT_SIZES[cfg.fontSize]   || CLE_FONT_SIZES.md;
                const fw   = CLE_FONT_WEIGHTS[cfg.fontWeight] || '400';
                return `<span style="font-size:${fs}; font-weight:${fw}; display:contents;">${html}</span>`;
            };

            // Build inline flex style for a zone from its config
            const zoneStyle = (zoneId, extra = '') => {
                const dflt = DEFAULT_ZONE_CONFIG[zoneId] || {};
                const cfg  = Object.assign({}, dflt, zoneCfgs[zoneId] || {});
                return `display:flex; flex-direction:${cfg.flexDir||'row'}; justify-content:${cfg.justify||'flex-start'}; align-items:${cfg.align||'center'}; flex-wrap:${cfg.wrap||'wrap'}; gap:0.5rem; ${extra}`;
            };

            // Render all fields in a zone
            const renderZone = (zoneId) => (zones[zoneId] || []).map(renderField).join('');

            const CHEV = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;flex-shrink:0;"><polyline points="6 9 12 15 18 9"></polyline></svg>`;

            const hl = renderZone('header-left');
            const hr = renderZone('header-right');
            const r1 = renderZone('row-1');
            const r2 = renderZone('row-2');
            const tk = renderZone('tickets');
            const ft = renderZone('footer');

            return `
                <div class="card-header-main">
                    <div style="${zoneStyle('header-left','min-width:0; flex:1;')}">${hl || `<span style="color:var(--text-muted);font-size:0.75rem;">‚Äî</span>`}</div>
                    <div style="display:flex; align-items:center; gap:0.4rem; flex-shrink:0;">${hr}<div class="collapse-indicator">${CHEV}</div></div>
                </div>
                <div class="card-body-wrapper">
                    <div class="card-body">
                        ${r1 ? `<div style="${zoneStyle('row-1')}">${r1}</div>` : ''}
                        ${r2 ? `<div style="${zoneStyle('row-2','margin-top:-0.2rem;')}">${r2}</div>` : ''}
                        ${tk ? `<div style="${zoneStyle('tickets','margin:0.4rem 0;')}">${tk}</div>` : ''}
                        ${ft ? `<div style="${zoneStyle('footer','padding:0.4rem 0 0.2rem;')}">${ft}</div>` : ''}
                    </div>
                </div>`;
        }

        // ===== END CARD LAYOUT EDITOR =====

        let fleetData = [];
        let systemUsers = [];
        let locationFilter = null;
        let activeSort = 'priority'; 
        let currentView = 'workboard';
        let collapsedCards = new Set(); 
        let allCollapsed = false;
        let currentUserRole = 'viewer';
        let currentUserId = null;
        
        let userPrefs = {
            displayMode: 'kanban',
            gridColumns: 3,
            columns: { road: true, complaints: true, ready: true, progress: true },
            cards: { issue: true, location: true, status: true, mileage: true, age: true, inspection: true, progress: true }
        };

        let isMultiSelectMode = false;
        let selectedCards = new Set();

        const STATUS_MAP = {
            "Reported": "complaints", "Ready for Pickup": "ready",
            "Received": "progress", "Assessment": "progress", "Awaiting part order": "progress",
            "Parts Received": "progress", "Repair in Progress": "progress", "Awaiting delivery": "progress",
            "Parts Received - Waiting for Technician": "progress"
        };

        const PROGRESS_LEVELS = {
            "Reported": 1, "Ready for Pickup": 2, "Received": 3, "Assessment": 3, "Awaiting part order": 3,
            "Parts Received": 4, "Repair in Progress": 4, "Awaiting delivery": 4, "Complete": 5
        };

        // ===== CARD FIELD REGISTRY =====
        // Each field has: label, icon, and a render(groupData) function returning HTML string
        const CARD_FIELD_REGISTRY = {
            vehicleId: {
                label: 'Vehicle #', icon: 'üî¢',
                render: (g) => `<strong style="font-size:0.95rem; font-family:'JetBrains Mono',monospace; letter-spacing:-0.5px;">${g.vid}</strong>`
            },
            vehicleType: {
                label: 'Vehicle Type', icon: 'üöó',
                render: (g) => g.vehicleType ? `<span class="card-meta-tag" style="margin:0;">${g.vehicleType}</span>` : ''
            },
            assignedUser: {
                label: 'Requester / Tech', icon: 'üë§',
                render: (g) => `<div class="card-avatar" title="${g.requestedBy || ''}">${String(g.requestedBy||'U').charAt(0).toUpperCase()}</div>`
            },
            homeLocation: {
                label: 'Home Location', icon: 'üè†',
                render: (g) => g.homeLocation ? `<span class="card-meta-tag">üè† ${g.homeLocation}</span>` : ''
            },
            shopStatus: {
                label: 'Shop Status', icon: 'üîß',
                render: (g) => `<span class="card-meta-tag" style="font-family:'JetBrains Mono',monospace; font-size:0.68rem;">${g.shopStatus || 'Reported'}</span>`
            },
            mileage: {
                label: 'Mileage', icon: 'üõ£Ô∏è',
                render: (g) => g.mileage ? `<span class="card-meta-tag">üõ£Ô∏è ${Number(g.mileage).toLocaleString()} mi</span>` : ''
            },
            issueDescription: {
                label: 'Issue Description', icon: 'üìù',
                render: (g) => g.displayTickets.map(t => {
                    const pClass = t.priority === 'Urgent' ? 'st-urgent' : t.priority === 'High' ? 'st-high' : t.priority === 'Oil Change / Bulb Replacement' ? 'st-maint' : '';
                    const selClass = t._isSelected ? 'selected' : '';
                    return `<div class="sub-ticket ${pClass} ${selClass}" data-doc-id="${t.docId}"><div style="font-size:0.85rem;font-weight:600;color:var(--text-main);">${t.issue || 'No issue provided'}</div></div>`;
                }).join('')
            },
            daysInShop: {
                label: 'Days in Shop', icon: '‚è≥',
                render: (g) => g.displayTickets.map(t => getAgeTags(t)).filter(Boolean).join('')
            },
            inspectionDate: {
                label: 'Inspection Date', icon: 'üîç',
                render: (g) => {
                    if (!g.inspectionDate) return '';
                    const diffDays = Math.ceil((new Date(g.inspectionDate).getTime() - new Date().setHours(0,0,0,0)) / 864e5);
                    if (diffDays <= 7) return `<span class="card-meta-tag tag-danger">üîç Insp: ${formatDate(g.inspectionDate)} (${diffDays < 0 ? Math.abs(diffDays)+'d past due' : diffDays+'d left'})</span>`;
                    if (diffDays <= 30) return `<span class="card-meta-tag tag-warn">üîç Insp: ${formatDate(g.inspectionDate)} (${diffDays}d left)</span>`;
                    return `<span class="card-meta-tag">üîç Insp: ${formatDate(g.inspectionDate)}</span>`;
                }
            },
            progressBar: {
                label: 'Progress Bar', icon: 'üìä',
                render: (g) => {
                    let maxP = 1;
                    g.displayTickets.forEach(t => { const p = PROGRESS_LEVELS[t.shopStatus]||1; if(p>maxP) maxP=p; });
                    let segs = '';
                    for (let i=1; i<=5; i++) {
                        const cls = i <= maxP ? (g.highestPrio === 'Urgent' ? 'active-warn' : 'active') : '';
                        segs += `<div class="progress-seg ${cls}"></div>`;
                    }
                    return `<div class="card-progress-container">${segs}</div>`;
                }
            },
            priorityBadge: {
                label: 'Priority Badge', icon: '‚ö†Ô∏è',
                render: (g) => {
                    const map = {'Urgent':'üî¥ Urgent','High':'‚ö†Ô∏è High','Oil Change / Bulb Replacement':'üîß Maint','Normal':'Normal'};
                    const color = g.highestPrio === 'Urgent' ? 'var(--c-urgent)' : g.highestPrio === 'High' ? 'var(--c-high)' : g.highestPrio === 'Oil Change / Bulb Replacement' ? 'var(--c-maint)' : 'var(--text-muted)';
                    return `<span class="card-meta-tag" style="color:${color};">${map[g.highestPrio]||'Normal'}</span>`;
                }
            },
            lastUpdated: {
                label: 'Last Updated', icon: 'üïê',
                render: (g) => g.latestDate ? `<span class="card-meta-tag">üïê ${new Date(g.latestDate).toLocaleDateString()}</span>` : ''
            }
        };

        // Default layout ‚Äî what shows in each zone before customization
        const DEFAULT_CARD_LAYOUT = {
            zones: {
                'header-left':  ['vehicleId', 'vehicleType'],
                'header-right': ['assignedUser'],
                'row-1':        ['homeLocation', 'mileage'],
                'row-2':        ['inspectionDate'],
                'tickets':      ['issueDescription', 'daysInShop', 'shopStatus'],
                'footer':       ['progressBar']
            }
        };

        // Font size and weight lookup maps
        const CLE_FONT_SIZES   = { xs: '0.65rem', sm: '0.75rem', md: '0.85rem', lg: '1rem', xl: '1.2rem' };
        const CLE_FONT_WEIGHTS = { normal: '400', semibold: '600', bold: '800' };

        // Default per-field config (fontSize key, fontWeight key)
        const DEFAULT_FIELD_CONFIG = {
            vehicleId:        { fontSize: 'lg',  fontWeight: 'bold'    },
            vehicleType:      { fontSize: 'sm',  fontWeight: 'normal'  },
            assignedUser:     { fontSize: 'md',  fontWeight: 'normal'  },
            homeLocation:     { fontSize: 'sm',  fontWeight: 'normal'  },
            shopStatus:       { fontSize: 'xs',  fontWeight: 'normal'  },
            mileage:          { fontSize: 'sm',  fontWeight: 'normal'  },
            issueDescription: { fontSize: 'sm',  fontWeight: 'semibold'},
            daysInShop:       { fontSize: 'xs',  fontWeight: 'normal'  },
            inspectionDate:   { fontSize: 'sm',  fontWeight: 'normal'  },
            progressBar:      { fontSize: 'sm',  fontWeight: 'normal'  },
            priorityBadge:    { fontSize: 'sm',  fontWeight: 'semibold'},
            lastUpdated:      { fontSize: 'xs',  fontWeight: 'normal'  }
        };

        // Default per-zone flex config
        const DEFAULT_ZONE_CONFIG = {
            'header-left':  { flexDir: 'row',    justify: 'flex-start',   align: 'center',  wrap: 'wrap'   },
            'header-right': { flexDir: 'row',    justify: 'flex-end',     align: 'center',  wrap: 'nowrap' },
            'row-1':        { flexDir: 'row',    justify: 'flex-start',   align: 'center',  wrap: 'wrap'   },
            'row-2':        { flexDir: 'row',    justify: 'flex-start',   align: 'center',  wrap: 'wrap'   },
            'tickets':      { flexDir: 'column', justify: 'flex-start',   align: 'stretch', wrap: 'nowrap' },
            'footer':       { flexDir: 'row',    justify: 'flex-start',   align: 'center',  wrap: 'wrap'   }
        };

        // --- PREFERENCES ---
        function loadPreferences() {
            if(!currentUserId) return;
            const saved = localStorage.getItem(`dlx_prefs_${currentUserId}`);
            if (saved) { 
                try { 
                    const parsed = JSON.parse(saved); 
                    userPrefs = { ...userPrefs, ...parsed };
                    if(parsed.columns) userPrefs.columns = { ...userPrefs.columns, ...parsed.columns };
                    if(parsed.cards) userPrefs.cards = { ...userPrefs.cards, ...parsed.cards };
                } catch(e){} 
            }
            applyColumnVisibility();
        }

        function openPreferences() {
            // Display mode
            const displayMode = userPrefs.displayMode || 'kanban';
            document.querySelectorAll('input[name="displayMode"]').forEach(r => r.checked = r.value === displayMode);

            // Grid density
            const gridCols = userPrefs.gridColumns || 3;
            document.getElementById('gridColumns').value = gridCols;
            document.getElementById('gridDensitySection').style.display = displayMode === 'grid' ? 'block' : 'none';

            // Board columns
            document.getElementById('pref-col-road').checked = userPrefs.columns.road;
            document.getElementById('pref-col-complaints').checked = userPrefs.columns.complaints;
            document.getElementById('pref-col-ready').checked = userPrefs.columns.ready;
            document.getElementById('pref-col-progress').checked = userPrefs.columns.progress;

            // Card data toggles
            document.getElementById('pref-card-issue').checked = userPrefs.cards.issue;
            document.getElementById('pref-card-location').checked = userPrefs.cards.location;
            document.getElementById('pref-card-status').checked = userPrefs.cards.status;
            document.getElementById('pref-card-mileage').checked = userPrefs.cards.mileage;
            document.getElementById('pref-card-age').checked = userPrefs.cards.age;
            document.getElementById('pref-card-inspection').checked = userPrefs.cards.inspection;
            document.getElementById('pref-card-progress').checked = userPrefs.cards.progress;

            // Add listener to display mode toggle
            document.querySelectorAll('input[name="displayMode"]').forEach(r => {
                r.onchange = () => {
                    document.getElementById('gridDensitySection').style.display = r.value === 'grid' ? 'block' : 'none';
                };
            });

            document.getElementById('preferencesModal').style.display = 'flex';
        }

        function savePreferences() {
            // Display mode
            const displayModeRadio = document.querySelector('input[name="displayMode"]:checked');
            if (displayModeRadio) {
                userPrefs.displayMode = displayModeRadio.value;
            }

            // Grid columns
            userPrefs.gridColumns = parseInt(document.getElementById('gridColumns').value) || 3;

            // Board columns
            userPrefs.columns = {
                road: document.getElementById('pref-col-road').checked,
                complaints: document.getElementById('pref-col-complaints').checked,
                ready: document.getElementById('pref-col-ready').checked,
                progress: document.getElementById('pref-col-progress').checked
            };

            // Card data toggles
            userPrefs.cards = {
                issue: document.getElementById('pref-card-issue').checked,
                location: document.getElementById('pref-card-location').checked,
                status: document.getElementById('pref-card-status').checked,
                mileage: document.getElementById('pref-card-mileage').checked,
                age: document.getElementById('pref-card-age').checked,
                inspection: document.getElementById('pref-card-inspection').checked,
                progress: document.getElementById('pref-card-progress').checked
            };

            if(currentUserId) localStorage.setItem(`dlx_prefs_${currentUserId}`, JSON.stringify(userPrefs));

            applyColumnVisibility();
            renderCurrentView();
            closeModal('preferencesModal');
            showToast('‚úì Preferences Saved');
        }

        function applyColumnVisibility() {
            const map = {
                'col-wrapper-road': userPrefs.columns.road,
                'col-wrapper-complaints': userPrefs.columns.complaints,
                'col-wrapper-ready': userPrefs.columns.ready,
                'col-wrapper-progress': userPrefs.columns.progress
            };
            for (const [id, vis] of Object.entries(map)) {
                const el = document.getElementById(id);
                if (el) el.style.display = vis ? 'flex' : 'none';
            }
        }

        // --- AUTH ---
        function toggleLoginSignup() {
            const login = document.getElementById('loginFormDiv'), signup = document.getElementById('signupFormDiv');
            login.style.display = login.style.display === 'none' ? 'flex' : 'none';
            signup.style.display = signup.style.display === 'none' ? 'flex' : 'none';
            document.getElementById('loginError').innerText = '';
        }

        function handleLogin() {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(e, p).catch(e => document.getElementById('loginError').innerText = e.message);
        }

        function handleSignup() {
            const e = document.getElementById('signupEmail').value, p = document.getElementById('signupPassword').value, c = document.getElementById('signupPasswordConfirm').value;
            if (!e || !p || !c) return document.getElementById('loginError').innerText = 'All fields required';
            if (p !== c) return document.getElementById('loginError').innerText = 'Passwords do not match';
            
            auth.createUserWithEmailAndPassword(e, p).then(async cred => {
                const userSnap = await db.collection('users').limit(1).get();
                const assignedRole = userSnap.empty ? 'admin' : 'viewer';
                await db.collection('users').doc(cred.user.uid).set({ email: e, role: assignedRole });
            }).catch(err => document.getElementById('loginError').innerText = err.message);
        }

        function handleLogout() { auth.signOut().then(() => location.reload()); }

        auth.onAuthStateChanged(async user => {
            if(user) {
                currentUserId = user.uid;

                // Initialize services
                const storageService = new StorageService();
                const utilityService = new UtilityService();
                const gridLayoutService = new GridLayoutService(user.uid);
                offlineQueue = new OfflineQueueService(user.uid);

                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').classList.add('active');
                document.getElementById('displayUserEmail').innerText = user.email.split('@')[0];
                document.getElementById('userAvatar').innerText = user.email.charAt(0).toUpperCase();

                const roleDoc = await db.collection('users').doc(user.uid).get();
                if(roleDoc.exists) currentUserRole = roleDoc.data().role || 'viewer';
                document.getElementById('displayUserRole').innerText = currentUserRole;

                applyRoleRestrictions();
                loadPreferences();
                loadData();
                offlineQueue.flushQueue(); // Try to sync pending changes
                setTimeout(setupDragAndDrop, 500); 
            } else { 
                document.getElementById('loginOverlay').style.display = 'flex'; 
            } 
        });

        function applyRoleRestrictions() {
            if (currentUserRole === 'viewer') {
                document.getElementById('nav-add-unit').style.display = 'none';
                document.getElementById('fleetioSyncBtn').style.display = 'none';
                document.getElementById('btn-bulk').style.display = 'none';
                document.getElementById('bulk-divider').style.display = 'none';
            } else {
                document.getElementById('nav-add-unit').style.display = 'flex';
                document.getElementById('fleetioSyncBtn').style.display = 'flex';
                document.getElementById('btn-bulk').style.display = 'flex';
                document.getElementById('bulk-divider').style.display = 'block';
            }
            if (currentUserRole === 'admin') {
                document.getElementById('nav-users').style.display = 'flex';
                loadUsersData(); 
            } else {
                document.getElementById('nav-users').style.display = 'none';
            }
        }

        // --- DATA ---
        function loadData() {
            db.collection('vehicles').onSnapshot(snap => {
                try {
                    fleetData = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
                    renderSidebarLocations();
                    updateDatalist();
                    renderCurrentView();
                } catch (e) {
                    console.error("Board rendering paused: waiting for data sync.");
                }
            });
        }

        function updateDatalist() {
            const dl = document.getElementById('syncedVehiclesList');
            dl.innerHTML = '';
            const ids = [...new Set(fleetData.map(v => String(v.id || '')))].sort();
            ids.forEach(id => { const opt = document.createElement('option'); opt.value = id; dl.appendChild(opt); });
        }

        document.getElementById('vID').addEventListener('input', function(e) {
            if(document.getElementById('mode').value === 'add') {
                const existing = fleetData.find(v => String(v.id||'').toLowerCase() === String(e.target.value).toLowerCase() && !v.isTicket);
                if(existing) {
                    if(existing.vehicleType) document.getElementById('vType').value = existing.vehicleType;
                    if(existing.homeLocation) document.getElementById('vHomeLocation').value = existing.homeLocation;
                }
            }
        });

        // --- BULK ACTIONS ---
        function toggleBulkMode() {
            if (currentUserRole === 'viewer') return;
            isMultiSelectMode = !isMultiSelectMode;
            selectedCards.clear();
            const btn = document.getElementById('btn-bulk');
            
            if (isMultiSelectMode) {
                btn.classList.add('bulk-active');
                btn.innerText = "Cancel Bulk";
                document.getElementById('bulkActionBar').classList.add('visible');
            } else {
                btn.classList.remove('bulk-active');
                btn.innerText = "‚òëÔ∏è Bulk Edit";
                document.getElementById('bulkActionBar').classList.remove('visible');
            }
            updateBulkCount();
            renderBoard(); 
        }

        function updateBulkCount() {
            document.getElementById('bulkCount').innerText = `${selectedCards.size} Selected`;
        }

        function applyBulkActions() {
            if (selectedCards.size === 0) return showToast("No vehicles selected");
            
            const newStatus = document.getElementById('bulkStatus').value;
            const newPriority = document.getElementById('bulkPriority').value;
            const newLocation = document.getElementById('bulkLocation').value.trim();
            
            if (!newStatus && !newPriority && !newLocation) return showToast("Select an action to apply");

            let updatePromises = [];
            const user = getUsername();

            selectedCards.forEach(docId => {
                const v = fleetData.find(v => v.docId === docId);
                if (!v) return;

                let changes = {};
                let histArr = parseHistory(v.history);

                if (newStatus) {
                    if (newStatus === "On the road") {
                        changes.onTheRoad = true;
                    } else {
                        changes.onTheRoad = false;
                        changes.shopStatus = newStatus;
                        changes.statusUpdatedAt = new Date().toISOString();
                    }
                    histArr.push(createLogEntry('Status', `Moved to ${newStatus} (Bulk)`));
                }
                
                if (newPriority) {
                    changes.priority = newPriority;
                    histArr.push(createLogEntry('Priority', `Changed to ${newPriority} (Bulk)`));
                }

                if (newLocation) {
                    changes.homeLocation = newLocation;
                    histArr.push(createLogEntry('Location', `Changed to ${newLocation} (Bulk)`));
                }

                changes.history = JSON.stringify(histArr);
                changes.lastUpdated = new Date().toISOString();

                updatePromises.push(db.collection('vehicles').doc(docId).update(changes));
            });

            Promise.all(updatePromises).then(() => {
                showToast(`‚úì Updated ${selectedCards.size} tickets`);
                document.getElementById('bulkStatus').value = '';
                document.getElementById('bulkPriority').value = '';
                document.getElementById('bulkLocation').value = '';
                toggleBulkMode(); 
            }).catch(() => showToast("‚ùå Error applying bulk updates"));
        }

        // --- USER MANAGEMENT ---
        function loadUsersData() {
            if(currentUserRole !== 'admin') return;
            db.collection('users').onSnapshot(snap => {
                systemUsers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
                if(currentView === 'users') renderUsersTable();
            });
        }
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            if(!tbody) return;
            tbody.innerHTML = systemUsers.map(u => `
                <tr><td>${u.email}</td><td style="font-family:'JetBrains Mono'; font-size:0.7rem; color:#666;">${u.uid}</td>
                <td><select class="role-select" onchange="updateUserRole('${u.uid}', this.value)" ${u.uid === currentUserId ? 'disabled' : ''}>
                <option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>Viewer</option><option value="standard" ${u.role === 'standard' ? 'selected' : ''}>Standard</option><option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option></select></td></tr>`).join('');
        }
        function updateUserRole(uid, newRole) { db.collection('users').doc(uid).update({ role: newRole }).then(() => showToast("‚úì User role updated")).catch(() => showToast("‚ùå Failed to update role")); }
        function openUserModal() { document.getElementById('newAccEmail').value = ''; document.getElementById('newAccPassword').value = ''; document.getElementById('newAccRole').value = 'viewer'; document.getElementById('userModal').style.display = 'flex'; }
        function createNewUser(e) {
            e.preventDefault();
            const email = document.getElementById('newAccEmail').value, pass = document.getElementById('newAccPassword').value, role = document.getElementById('newAccRole').value, btn = document.getElementById('createUserBtn');
            btn.innerText = "Creating..."; btn.disabled = true;
            secondaryApp.auth().createUserWithEmailAndPassword(email, pass).then(cred => {
                db.collection('users').doc(cred.user.uid).set({ email, role }).then(() => { btn.innerText = "Create User"; btn.disabled = false; closeModal('userModal'); showToast("‚úì Account Created"); secondaryApp.auth().signOut(); });
            }).catch(err => { btn.innerText = "Create User"; btn.disabled = false; alert(err.message); });
        }

        // --- FLEETIO SYNC ---
        async function syncFleetioData() {
            if (!FLEETIO_API_KEY || FLEETIO_API_KEY === 'YOUR_FLEETIO_API_KEY_HERE') return alert("Please add your Fleetio API Key.");
            const btn = document.getElementById('fleetioSyncBtn');
            btn.innerHTML = "‚è≥ Syncing Vehicles..."; btn.disabled = true;
            let logbook = [];
            let updateCount = 0, skipCount = 0, createdCount = 0, noMeterCount = 0, updatePromises = [];

            try {
                const vehResponse = await fetch('https://secure.fleetio.com/api/v1/vehicles?per_page=100', {
                    method: 'GET', headers: { 'Authorization': `Token token="${FLEETIO_API_KEY}"`, 'Account-Token': FLEETIO_ACCOUNT_TOKEN, 'Content-Type': 'application/json', 'Accept': 'application/json' }
                });
                if (!vehResponse.ok) throw new Error(`Fleetio Vehicle API Error: ${vehResponse.status}`);
                
                const fleetioResponse = await vehResponse.json();
                let fleetioVehicles = Array.isArray(fleetioResponse) ? fleetioResponse : (fleetioResponse.records || fleetioResponse.data || []);

                logbook.push(`üì° Fetched ${fleetioVehicles.length} vehicles from Fleetio API.`);

                fleetioVehicles.forEach(fVehicle => {
                    const cleanFleetioName = String(fVehicle.name || '').replace(/[^0-9]/g, '');
                    const finalDocId = cleanFleetioName !== '' ? cleanFleetioName : String(fVehicle.name).trim();
                    
                    const localVehicle = fleetData.find(v => {
                        const cleanLocalId = String(v.id || '').replace(/[^0-9]/g, '');
                        return (cleanLocalId === cleanFleetioName && cleanLocalId !== '') || v.docId === finalDocId;
                    });

                    if (localVehicle) {
                        if (fVehicle.primary_meter_value) {
                            const updatedMileage = Math.round(parseFloat(fVehicle.primary_meter_value));
                            if ((parseInt(localVehicle.mileage) || 0) !== updatedMileage) {
                                updateCount++; logbook.push(`‚úÖ UPDATED VEHICLE: ${localVehicle.id} | ${localVehicle.mileage || 0} -> ${updatedMileage}`);
                                updatePromises.push(db.collection('vehicles').doc(localVehicle.docId).update({ mileage: updatedMileage }));
                            } else { skipCount++; }
                        } else { noMeterCount++; }
                    } else {
                        const newMileage = fVehicle.primary_meter_value ? Math.round(parseFloat(fVehicle.primary_meter_value)) : 0;
                        createdCount++; logbook.push(`‚ú® CREATED VEHICLE: ${fVehicle.name} added as Doc ID "${finalDocId}" (Mileage: ${newMileage})`);
                        updatePromises.push(db.collection('vehicles').doc(finalDocId).set({ 
                            id: finalDocId || '', mileage: newMileage || 0, shopStatus: 'Database Only', onTheRoad: false, priority: 'Normal', status: 'Operational', homeLocation: '', vehicleType: '', date: new Date().toISOString().split('T')[0], lastUpdated: new Date().toISOString(), history: JSON.stringify([createLogEntry('System', 'Imported from Fleetio')]), sortOrder: Date.now(), isTicket: false, isBaseVehicle: true 
                        }));
                    }
                });
                
                btn.innerHTML = "‚è≥ Syncing Issues...";
                const issueResponse = await fetch('https://secure.fleetio.com/api/v1/issues?per_page=100', {
                    method: 'GET', headers: { 'Authorization': `Token token="${FLEETIO_API_KEY}"`, 'Account-Token': FLEETIO_ACCOUNT_TOKEN, 'Content-Type': 'application/json', 'Accept': 'application/json' }
                });
                if (!issueResponse.ok) throw new Error(`Fleetio Issue API Error: ${issueResponse.status}`);
                
                const fleetioIssueRes = await issueResponse.json();
                let fleetioIssues = Array.isArray(fleetioIssueRes) ? fleetioIssueRes : (fleetioIssueRes.records || fleetioIssueRes.data || []);
                
                fleetioIssues = fleetioIssues.filter(i => String(i.state).toLowerCase() === 'open' || !i.resolved_at);
                logbook.push(`\nüì° Fetched ${fleetioIssues.length} open issues from Fleetio API.`);

                fleetioIssues.forEach(fIssue => {
                    const existingTicket = fleetData.find(v => v.fleetioIssueId == fIssue.id);
                    const vehicleName = String(fIssue.vehicle_name || '').replace(/[^0-9]/g, '') || String(fIssue.vehicle_name || '');
                    const issueText = String(fIssue.title || '') + (fIssue.description ? ` - ${fIssue.description}` : '');
                    
                    let prio = "Normal";
                    if(fIssue.priority) {
                        const fp = String(fIssue.priority).toLowerCase();
                        if(fp === 'critical') prio = 'Urgent';
                        if(fp === 'high') prio = 'High';
                        if(fp === 'low') prio = 'Normal'; 
                    }

                    if (existingTicket) {
                        if (existingTicket.issue !== issueText || existingTicket.priority !== prio) {
                            updateCount++;
                            logbook.push(`‚úÖ UPDATED ISSUE: ${vehicleName} | ${fIssue.title}`);
                            let histArr = parseHistory(existingTicket.history);
                            histArr.push(createLogEntry('System', 'Issue updated from Fleetio'));
                            updatePromises.push(db.collection('vehicles').doc(existingTicket.docId).update({
                                issue: issueText || '', priority: prio || 'Normal', history: JSON.stringify(histArr), lastUpdated: new Date().toISOString()
                            }));
                        } else { skipCount++; }
                    } else {
                        const baseVeh = fleetData.find(v => String(v.id).toLowerCase() === String(vehicleName).toLowerCase() && !v.isTicket);
                        const vType = baseVeh?.vehicleType || '';
                        const hLoc = baseVeh?.homeLocation || '';

                        createdCount++;
                        logbook.push(`‚ú® NEW TICKET: ${vehicleName} | ${fIssue.title}`);
                        updatePromises.push(db.collection('vehicles').add({
                            id: vehicleName || '', baseVehicleId: vehicleName || '', vehicleType: vType || '', issue: issueText || '', fleetioIssueId: fIssue.id || '', isTicket: true, shopStatus: 'Reported', onTheRoad: false, priority: prio || 'Normal', status: 'Operational', homeLocation: hLoc || '', date: new Date().toISOString().split('T')[0], statusUpdatedAt: new Date().toISOString(), lastUpdated: new Date().toISOString(), history: JSON.stringify([createLogEntry('System', 'Issue imported from Fleetio')]), sortOrder: Date.now()
                        }));
                    }
                });

                await Promise.all(updatePromises);
                showSyncLogbook(updateCount, skipCount, createdCount, noMeterCount, logbook);
                showToast(`‚úì Synced successfully`);
            } catch (error) { 
                console.error(error);
                showToast("‚ùå Failed to sync."); 
            } finally { 
                btn.innerHTML = "üîÑ Sync Fleetio"; btn.disabled = false; 
            }
        }

        function showSyncLogbook(updated, skipped, created, noMeter, logLines) {
            document.getElementById('syncLogStats').innerHTML = `<div style="color: var(--accent);">‚úÖ Updated: ${updated}</div><div style="color: #60a5fa;">‚ú® Created: ${created}</div><div style="color: var(--text-muted);">‚è≠Ô∏è Skipped: ${skipped}</div><div style="color: var(--c-parts);">‚ö†Ô∏è No Meter: ${noMeter}</div>`;
            document.getElementById('syncLogDetails').innerHTML = logLines.join('\n');
            document.getElementById('syncLogModal').style.display = 'flex';
        }

        // --- VIEWS & RENDER ---
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-area').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            document.getElementById(`nav-${view}`).classList.add('active');
            
            if(view === 'users') renderUsersTable();
            else if(view === 'analytics') renderAnalytics();
            else renderCurrentView();
        }

        function renderCurrentView() {
            if (currentView === 'workboard') {
                const displayMode = userPrefs.displayMode || 'kanban';
                if (displayMode === 'grid') {
                    renderGridBoard();
                } else {
                    renderBoard();
                }
            }
            else if (currentView === 'database') renderDatabase();
            else if (currentView === 'analytics') renderAnalytics();
        }

        function setFilter(loc) { locationFilter = loc; document.getElementById('boardTitle').innerText = loc ? `${loc} Units` : "Active Workboard"; renderSidebarLocations(); renderCurrentView(); }
        
        function setSort(type) { 
            activeSort = type; 
            document.querySelectorAll('.filter-btn[id^="btn-sort-"]').forEach(btn => btn.classList.remove('active'));
            const targetBtn = document.getElementById('btn-sort-' + type);
            if(targetBtn) targetBtn.classList.add('active');
            renderCurrentView(); 
        }

        function renderSidebarLocations() {
            const locs = [...new Set(fleetData.map(v => String(v.homeLocation || '')))].sort();
            const container = document.getElementById('locationSubmenu');
            container.innerHTML = locs.filter(l=>l).map(l => `<a class="submenu-item ${locationFilter === l ? 'active' : ''}" onclick="setFilter('${l}')">${l}</a>`).join('');
            if(locationFilter) container.innerHTML = `<a class="submenu-item" onclick="setFilter(null)">‚Üê All Locations</a>` + container.innerHTML;
        }

        // --- OFFLINE WRITE WRAPPER ---
        let offlineQueue = null;

        async function safeFirebaseWrite(collection, docId, data, operation = 'update') {
            if (!offlineQueue) return console.error('Offline queue not initialized');

            try {
                if (!navigator.onLine) {
                    offlineQueue.queueWrite(collection, docId, data, operation);
                    showToast('üì° No connection - saved for later');
                    return;
                }

                const ref = db.collection(collection).doc(docId);

                if (operation === 'update') {
                    await ref.update(data);
                } else if (operation === 'set') {
                    await ref.set(data, { merge: true });
                } else if (operation === 'delete') {
                    await ref.delete();
                }

                showToast('‚úì Synced');
            } catch (error) {
                console.error('Write error:', error);
                offlineQueue.queueWrite(collection, docId, data, operation);
                showToast('‚ùå Failed - queued for sync');
            }
        }

        function formatDate(s) { if (!s) return ''; const p = String(s).split('-'); return p.length===3 ? `${p[1]}/${p[2]}/${p[0]}` : s; }

        function toggleCard(vid, btn) {
            const card = btn.closest('.vehicle-card');
            if (collapsedCards.has(vid)) { collapsedCards.delete(vid); card.classList.remove('collapsed'); } 
            else { collapsedCards.add(vid); card.classList.add('collapsed'); }
        }

        function toggleGlobalCollapse() {
            allCollapsed = !allCollapsed;
            document.getElementById('btn-collapse-all').innerHTML = allCollapsed ? '‚äû Expand All' : '‚äü Collapse All';
            document.querySelectorAll('.vehicle-card').forEach(card => {
                const vid = card.dataset.vid;
                if (!vid) return;
                if (allCollapsed) { collapsedCards.add(vid); card.classList.add('collapsed'); } 
                else { collapsedCards.delete(vid); card.classList.remove('collapsed'); }
            });
        }

        function getClosestCard(container, y) {
            const draggableElements = [...container.querySelectorAll('.vehicle-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function getAgeTags(v) {
            let tags = [];
            const today = new Date();
            today.setHours(0,0,0,0);
            
            if (v.date && !v.onTheRoad && v.shopStatus !== 'Database Only' && v.shopStatus !== 'Complete') {
                const inDate = new Date(v.date).getTime();
                if(!isNaN(inDate)) {
                    const totalDays = Math.max(0, Math.floor((today.getTime() - inDate) / 864e5));
                    const statusDateRaw = new Date(v.statusUpdatedAt || v.lastUpdated || v.date || Date.now()).getTime();
                    const statusDate = isNaN(statusDateRaw) ? inDate : statusDateRaw;
                    const colDays = Math.max(0, Math.floor((today.getTime() - statusDate) / 864e5));
                    tags.push(`‚è≥ ${totalDays}d total ‚Ä¢ ${colDays}d here`);
                }
            }
            return tags.length ? `<span class="card-meta-tag">${tags.join('')}</span>` : '';
        }

        function renderBoard() {
            // Ensure grid is hidden and kanban is shown
            const gridBoard = document.getElementById('gridBoard');
            const kanbanBoard = document.getElementById('kanbanBoard');
            if (gridBoard) gridBoard.style.display = 'none';
            if (kanbanBoard) kanbanBoard.style.display = 'flex';

            ['road', 'complaints', 'ready', 'progress'].forEach(c => { const el = document.getElementById(`col-${c}`); if(el) el.innerHTML = ''; const countEl = document.getElementById(`count-${c}`); if(countEl) countEl.innerText = '0'; });
            const search = String(document.getElementById('searchInput').value).toLowerCase();
            
            const columnsRaw = { road: {}, complaints: {}, ready: {}, progress: {} };
            
            fleetData.forEach(v => {
                if (locationFilter && v.homeLocation !== locationFilter) return;
                if (search && !JSON.stringify(v).toLowerCase().includes(search)) return;

                let colId = null;
                if (v.onTheRoad) colId = 'road';
                else if (v.shopStatus === 'Database Only' || v.shopStatus === 'Complete') colId = null; 
                else if (STATUS_MAP[v.shopStatus]) colId = STATUS_MAP[v.shopStatus];
                else if (!v.shopStatus) colId = 'complaints';
                
                if (colId) {
                    if (v.isTicket !== false) {
                        const vid = String(v.baseVehicleId || v.id || 'Unknown').toUpperCase();
                        if (!columnsRaw[colId][vid]) columnsRaw[colId][vid] = [];
                        columnsRaw[colId][vid].push(v);
                    } else if (v.isTicket === false && v.shopStatus !== 'Database Only') {
                        const vid = String(v.id || 'Unknown').toUpperCase();
                        if (!columnsRaw[colId][vid]) columnsRaw[colId][vid] = [];
                        columnsRaw[colId][vid].push(v);
                    }
                }
            });

            const columns = { road: [], complaints: [], ready: [], progress: [] };
            
            Object.keys(columnsRaw).forEach(colId => {
                Object.keys(columnsRaw[colId]).forEach(vid => {
                    const tickets = columnsRaw[colId][vid];
                    
                    let highestPrio = 'Normal';
                    let latestDate = 0;
                    let minInsp = 9999999999999;
                    let maxOrder = 0;

                    tickets.forEach(t => {
                        const pLevels = { 'Urgent': 4, 'High': 3, 'Oil Change / Bulb Replacement': 2, 'Normal': 1 };
                        if ((pLevels[t.priority] || 1) > (pLevels[highestPrio] || 1)) highestPrio = t.priority;
                        const tDate = new Date(t.lastUpdated || 0).getTime();
                        if (!isNaN(tDate) && tDate > latestDate) latestDate = tDate;
                        if (t.inspectionDate) {
                            const insD = new Date(t.inspectionDate).getTime();
                            if (!isNaN(insD) && insD < minInsp) minInsp = insD;
                        }
                        const order = parseFloat(t.sortOrder) || 0;
                        if (order > maxOrder) maxOrder = order;
                    });

                    columns[colId].push({
                        vid, displayTickets: tickets, highestPrio, latestDate, minInsp, maxOrder,
                        vehicleType: tickets[0].vehicleType || '', homeLocation: tickets[0].homeLocation || '',
                        mileage: tickets[0].mileage || '', shopStatus: tickets[0].shopStatus || 'Reported', requestedBy: tickets[0].requestedBy || 'U',
                        inspectionDate: minInsp !== 9999999999999 ? new Date(minInsp).toISOString() : null
                    });
                });
            });

            Object.keys(columns).forEach(colId => {
                columns[colId].sort((a, b) => {
                    if (colId === 'road' && activeSort !== 'freeform') return a.minInsp - b.minInsp;
                    else {
                        if (activeSort === 'id') return String(a.vid).localeCompare(String(b.vid), undefined, {numeric: true, sensitivity: 'base'});
                        if (activeSort === 'freeform') return a.maxOrder - b.maxOrder;
                        if (activeSort === 'priority') {
                            const pL = { 'Urgent': 4, 'High': 3, 'Oil Change / Bulb Replacement': 2, 'Normal': 1 };
                            const diff = (pL[b.highestPrio]||1) - (pL[a.highestPrio]||1);
                            if (diff !== 0) return diff;
                        }
                        return b.latestDate - a.latestDate;
                    }
                });
            });

            const CHEV_ICON = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;

            Object.keys(columns).forEach(colId => {
                columns[colId].forEach(g => {
                    const { vid, displayTickets, highestPrio, minInsp, vehicleType, homeLocation, mileage, shopStatus, requestedBy, inspectionDate } = g;
                    
                    const isCollapsed = collapsedCards.has(vid) ? 'collapsed' : '';
                    const allSelected = displayTickets.length > 0 && displayTickets.every(t => selectedCards.has(t.docId));
                    const isSelected = allSelected ? 'selected' : '';
                    const isSelectable = isMultiSelectMode ? 'selectable' : '';
                    const prioClass = highestPrio === 'Urgent' ? 'prio-Urgent' : highestPrio === 'High' ? 'prio-High' : highestPrio === 'Oil Change / Bulb Replacement' ? 'prio-Maint' : 'prio-Normal';
                    
                    let inspectClass = '', inspectTag = '';
                    if (colId === 'road' && inspectionDate) {
                        const diffDays = Math.ceil((new Date(inspectionDate).getTime() - new Date().setHours(0,0,0,0)) / 864e5);
                        if (diffDays <= 7) { inspectClass = 'inspect-crit'; inspectTag = `<span class="card-meta-tag tag-danger">üîç Insp: ${formatDate(inspectionDate)} (${diffDays < 0 ? Math.abs(diffDays) + 'd past due' : diffDays + 'd left'})</span>`; } 
                        else if (diffDays <= 30) { inspectClass = 'inspect-warn'; inspectTag = `<span class="card-meta-tag tag-warn">üîç Insp: ${formatDate(inspectionDate)} (${diffDays}d left)</span>`; } 
                        else { inspectTag = `<span class="card-meta-tag">üîç Insp: ${formatDate(inspectionDate)}</span>`; }
                    } else if (inspectionDate) {
                        inspectTag = `<span class="card-meta-tag">üîç Insp: ${formatDate(inspectionDate)}</span>`;
                    }

                    const card = document.createElement('div');
                    card.className = `vehicle-card ${prioClass} ${inspectClass} ${isCollapsed} ${isSelected} ${isSelectable}`;
                    card.draggable = !isMultiSelectMode && currentUserRole !== 'viewer';
                    card.dataset.vid = vid; 
                    card.dataset.order = g.maxOrder;
                    
                    let isDragging = false;
                    card.ondragstart = (e) => { 
                        if(isMultiSelectMode) { e.preventDefault(); return; }
                        isDragging = true; e.dataTransfer.effectAllowed = 'move'; 
                        e.dataTransfer.setData('text/plain', JSON.stringify(displayTickets.map(t=>t.docId))); 
                        setTimeout(() => card.classList.add('dragging'), 0); 
                    };
                    card.ondragend = () => { card.classList.remove('dragging'); clearDragIndicator(); setTimeout(() => isDragging = false, 50); };

                    card.onclick = (e) => {
                        if(isDragging) return;
                        const subTicketEl = e.target.closest('.sub-ticket');

                        if(isMultiSelectMode) {
                            if(subTicketEl) {
                                const tid = subTicketEl.dataset.docId;
                                if(selectedCards.has(tid)) selectedCards.delete(tid);
                                else selectedCards.add(tid);
                            } else {
                                if(allSelected) displayTickets.forEach(t => selectedCards.delete(t.docId));
                                else displayTickets.forEach(t => selectedCards.add(t.docId));
                            }
                            updateBulkCount();
                            renderBoard();
                            return;
                        }

                        if(e.target.closest('.collapse-indicator')) toggleCard(vid, e.target.closest('.collapse-indicator'));
                        else if(subTicketEl) openModal('edit', subTicketEl.dataset.docId);
                        else openModal('edit', displayTickets[0].docId);
                    };

                    // Mark sub-tickets that are selected (for multi-select highlight)
                    displayTickets.forEach(t => {
                        if (selectedCards.has(t.docId)) t._isSelected = true;
                        else delete t._isSelected;
                    });

                    // Use the user's custom card layout to render content
                    card.innerHTML = renderCardFromLayout(g, colId);
                    const targetCol = document.getElementById(`col-${colId}`);
                    if(targetCol) targetCol.appendChild(card);
                });
                if (document.getElementById(`count-${colId}`)) document.getElementById(`count-${colId}`).innerText = columns[colId].length;
            });
        }

        function renderGridBoard() {
            const gridBoard = document.getElementById('gridBoard');
            const kanbanBoard = document.getElementById('kanbanBoard');

            // Hide kanban, show grid
            kanbanBoard.style.display = 'none';
            gridBoard.style.display = 'grid';

            // Get display preferences
            const gridCols = userPrefs.gridColumns || 3;
            gridBoard.className = `grid-board cols-${gridCols}`;

            // Clear grid
            gridBoard.innerHTML = '';

            const search = String(document.getElementById('searchInput').value).toLowerCase();
            const columnsRaw = { road: {}, complaints: {}, ready: {}, progress: {} };
            let visibleCount = 0;

            // Apply same filtering logic as kanban
            fleetData.forEach(v => {
                if (locationFilter && v.homeLocation !== locationFilter) return;
                if (search && !JSON.stringify(v).toLowerCase().includes(search)) return;

                let colId = null;
                if (v.onTheRoad) colId = 'road';
                else if (v.shopStatus === 'Database Only' || v.shopStatus === 'Complete') colId = null;
                else if (STATUS_MAP[v.shopStatus]) colId = STATUS_MAP[v.shopStatus];
                else if (!v.shopStatus) colId = 'complaints';

                if (colId && v.isTicket !== false) {
                    const vid = String(v.baseVehicleId || v.id || 'Unknown').toUpperCase();
                    if (!columnsRaw[colId][vid]) columnsRaw[colId][vid] = [];
                    columnsRaw[colId][vid].push(v);
                }
            });

            // Create grid cards using the shared custom layout renderer
            Object.keys(columnsRaw).forEach(colId => {
                Object.keys(columnsRaw[colId]).forEach(vid => {
                    const displayTickets = columnsRaw[colId][vid];
                    if (displayTickets.length === 0) return;

                    visibleCount++;

                    let highestPrio = 'Normal', latestDate = 0, minInsp = 9999999999999;
                    displayTickets.forEach(t => {
                        const pLevels = { 'Urgent': 4, 'High': 3, 'Oil Change / Bulb Replacement': 2, 'Normal': 1 };
                        if ((pLevels[t.priority] || 1) > (pLevels[highestPrio] || 1)) highestPrio = t.priority;
                        const tDate = new Date(t.lastUpdated || 0).getTime();
                        if (!isNaN(tDate) && tDate > latestDate) latestDate = tDate;
                        if (t.inspectionDate) { const d = new Date(t.inspectionDate).getTime(); if (!isNaN(d) && d < minInsp) minInsp = d; }
                    });

                    const groupData = {
                        vid, displayTickets, highestPrio, latestDate,
                        inspectionDate: minInsp !== 9999999999999 ? new Date(minInsp).toISOString() : null,
                        vehicleType: displayTickets[0].vehicleType || '',
                        homeLocation: displayTickets[0].homeLocation || '',
                        mileage: displayTickets[0].mileage || '',
                        shopStatus: displayTickets[0].shopStatus || 'Reported',
                        requestedBy: displayTickets[0].requestedBy || 'U'
                    };

                    const prioClass = highestPrio === 'Urgent' ? 'prio-Urgent' : highestPrio === 'High' ? 'prio-High' : highestPrio === 'Oil Change / Bulb Replacement' ? 'prio-Maint' : 'prio-Normal';
                    const card = document.createElement('div');
                    card.className = `vehicle-card ${prioClass} in-grid`;
                    card.style.cursor = 'pointer';
                    card.innerHTML = renderCardFromLayout(groupData, colId);
                    card.onclick = (e) => {
                        const sub = e.target.closest('.sub-ticket');
                        openModal('edit', sub ? sub.dataset.docId : displayTickets[0].docId);
                    };
                    gridBoard.appendChild(card);
                });
            });

            if (visibleCount === 0) {
                gridBoard.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 3rem;">No vehicles to display</div>';
            }
        }

        // --- SECURE DRAG ENGINE ---
        let currentIndicator = null;
        function clearDragIndicator() {
            if(currentIndicator) { currentIndicator.remove(); currentIndicator = null; }
            document.querySelectorAll('.drag-over-column').forEach(el => el.classList.remove('drag-over-column'));
        }

        function setupDragAndDrop() {
            document.querySelectorAll('.kanban-column').forEach(col => {
                const content = col.querySelector('.column-content');
                if(!content) return;
                
                col.addEventListener('dragenter', e => e.preventDefault());
                
                col.addEventListener('dragover', e => {
                    e.preventDefault(); 
                    if (currentUserRole !== 'viewer' && !isMultiSelectMode) {
                        e.dataTransfer.dropEffect = 'move';
                        
                        if (activeSort === 'freeform') {
                            const closest = getClosestCard(content, e.clientY);
                            if (!currentIndicator) {
                                currentIndicator = document.createElement('div');
                                currentIndicator.className = 'drop-indicator';
                            }
                            if (closest) {
                                if (closest.previousElementSibling !== currentIndicator) {
                                    content.insertBefore(currentIndicator, closest);
                                }
                            } else {
                                if (content.lastElementChild !== currentIndicator) {
                                    content.appendChild(currentIndicator);
                                }
                            }
                        } else {
                            col.classList.add('drag-over-column');
                        }
                    }
                });
                
                col.addEventListener('dragleave', e => {
                    if (!col.contains(e.relatedTarget)) clearDragIndicator();
                });
                
                col.addEventListener('drop', e => {
                    e.preventDefault();
                    col.classList.remove('drag-over-column');
                    if (currentUserRole === 'viewer' || isMultiSelectMode) {
                        clearDragIndicator();
                        return;
                    }
                    
                    const payload = e.dataTransfer.getData('text/plain');
                    if (!payload) {
                        clearDragIndicator();
                        return;
                    }

                    let docIds = [];
                    try { docIds = JSON.parse(payload); } 
                    catch(err) { docIds = [payload]; }
                    
                    const colType = content.getAttribute('data-col');
                    let changes = { statusUpdatedAt: new Date().toISOString() };
                    
                    if (colType === 'on_the_road') changes.onTheRoad = true;
                    else if (colType === 'complaints') { changes.onTheRoad = false; changes.shopStatus = "Reported"; }
                    else if (colType === 'ready') { changes.onTheRoad = false; changes.shopStatus = "Ready for Pickup"; }
                    else if (colType === 'progress') { changes.onTheRoad = false; changes.shopStatus = "Repair in Progress"; }
                    
                    if (activeSort === 'freeform') {
                        const closest = getClosestCard(content, e.clientY);
                        let prevOrder = null, nextOrder = null;
                        
                        if (closest) {
                            nextOrder = parseFloat(closest.dataset.order);
                            let prev = closest.previousElementSibling;
                            while (prev && (prev.classList.contains('dragging') || prev.classList.contains('drop-indicator'))) {
                                prev = prev.previousElementSibling;
                            }
                            if (prev && prev.classList.contains('vehicle-card')) {
                                prevOrder = parseFloat(prev.dataset.order);
                            }
                        } else {
                            const cards = Array.from(content.querySelectorAll('.vehicle-card:not(.dragging)'));
                            if (cards.length > 0) {
                                prevOrder = parseFloat(cards[cards.length - 1].dataset.order);
                            }
                        }
                        
                        let newOrder = Date.now();
                        if (prevOrder !== null && nextOrder !== null) {
                            newOrder = (prevOrder + nextOrder) / 2.0;
                        } else if (prevOrder !== null) {
                            newOrder = prevOrder + 10000;
                        } else if (nextOrder !== null) {
                            newOrder = nextOrder - 10000;
                        }
                        
                        changes.sortOrder = newOrder;
                    }

                    clearDragIndicator();
                    docIds.forEach(docId => {
                        db.collection('vehicles').doc(docId).update(changes).catch(() => showToast("‚ùå Failed to move unit"));
                    });
                });
            });
        }

        // --- ANALYTICS DASHBOARD ---
        function renderAnalytics() {
            const grid = document.getElementById('analyticsGrid');
            if(!grid) return;

            const today = new Date();
            today.setHours(0,0,0,0);

            let unitsDown = 0, urgentCount = 0, totalRepairDays = 0, activeRepairsCount = 0, inspectionsNearing = 0;
            let locCounts = {};

            fleetData.forEach(v => {
                if (!v.isTicket && v.status === 'Down') unitsDown++;
                
                if(v.shopStatus === 'Database Only' || v.shopStatus === 'Complete') return;

                if(v.isTicket && v.status === 'Down') unitsDown++;
                if(v.priority === 'Urgent') urgentCount++;
                
                if(v.date && !v.onTheRoad) {
                    const inDate = new Date(v.date).getTime();
                    if(!isNaN(inDate)) {
                        const days = Math.floor((today.getTime() - inDate) / 864e5);
                        if(days >= 0) { totalRepairDays += days; activeRepairsCount++; }
                    }
                }

                if(v.inspectionDate) {
                    const diffDays = Math.ceil((new Date(v.inspectionDate).getTime() - today.getTime()) / 864e5);
                    if (diffDays >= 0 && diffDays <= 30) inspectionsNearing++;
                }

                const loc = v.location || 'Unknown Shop';
                locCounts[loc] = (locCounts[loc] || 0) + 1;
            });

            const avgRepairTime = activeRepairsCount > 0 ? Math.round(totalRepairDays / activeRepairsCount) : 0;
            
            let locationHtml = '';
            const maxLoc = Math.max(...Object.values(locCounts), 1);
            for (const [loc, count] of Object.entries(locCounts).sort((a,b)=>b[1]-a[1])) {
                const width = (count / maxLoc) * 100;
                locationHtml += `<div class="location-bar"><div style="width: 120px; flex-shrink: 0; color: var(--text-muted);">${loc}</div><div style="flex: 1; background: #111; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);"><div class="loc-bar-fill" style="width: ${width}%;"></div></div><div style="width: 30px; text-align: right;">${count}</div></div>`;
            }

            grid.innerHTML = `
                <div class="stat-card sc-red"><div class="stat-label">Units Down Today</div><div class="stat-val">${unitsDown}</div></div>
                <div class="stat-card sc-orange"><div class="stat-label">Urgent Repairs</div><div class="stat-val">${urgentCount}</div></div>
                <div class="stat-card sc-blue"><div class="stat-label">Avg Repair Time (Active)</div><div class="stat-val">${avgRepairTime} <span style="font-size:1rem; color:var(--text-muted)">Days</span></div></div>
                <div class="stat-card"><div class="stat-label">Inspections Nearing (30d)</div><div class="stat-val" style="color: var(--c-ready);">${inspectionsNearing}</div></div>
                <div class="chart-container"><div class="stat-label" style="margin-bottom: 1.5rem;">Active Repairs by Current Location</div>${locationHtml || '<div style="color:var(--text-muted); font-size:0.8rem;">No active units with location data.</div>'}</div>
            `;
        }

        // --- DATABASE VIEW ---
        function renderDatabase() {
            const tbody = document.getElementById('dbTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const vehicleMap = {};
            
            fleetData.forEach(v => {
                const vid = String(v.baseVehicleId || v.id || '').toUpperCase();
                if (!vid) return;
                
                if (!vehicleMap[vid]) {
                    vehicleMap[vid] = { ...v, activeTickets: 0 }; 
                }
                
                if (v.isTicket === false || v.isBaseVehicle === true) {
                    vehicleMap[vid].mileage = v.mileage || vehicleMap[vid].mileage;
                    vehicleMap[vid].lastOilChange = v.lastOilChange || vehicleMap[vid].lastOilChange;
                    vehicleMap[vid].accidentHistory = v.accidentHistory || vehicleMap[vid].accidentHistory;
                    vehicleMap[vid].longTermRepairs = v.longTermRepairs || vehicleMap[vid].longTermRepairs;
                    vehicleMap[vid].docId = v.docId; 
                    vehicleMap[vid].isTicket = false;
                }
                
                if (v.isTicket && v.shopStatus !== 'Complete' && v.shopStatus !== 'Database Only') {
                    vehicleMap[vid].shopStatus = v.shopStatus; 
                    vehicleMap[vid].onTheRoad = v.onTheRoad;
                    vehicleMap[vid].activeTickets = (vehicleMap[vid].activeTickets || 0) + 1;
                }
            });

            const sortedDB = Object.values(vehicleMap).sort((a,b) => String(a.id || '').localeCompare(String(b.id || ''), undefined, {numeric: true, sensitivity: 'base'}));

            sortedDB.forEach(v => {
                if (locationFilter && v.homeLocation !== locationFilter) return;
                if (search && !JSON.stringify(v).toLowerCase().includes(search)) return;

                const tr = document.createElement('tr');
                tr.onclick = () => openDbModal(v.docId);
                
                let dispStatus = v.onTheRoad ? 'On the road' : (v.shopStatus === 'Database Only' ? 'Inactive / Synced' : v.shopStatus);
                
                if (v.activeTickets > 1) {
                    dispStatus += ` <span style="background:var(--accent); color:#000; padding: 2px 6px; border-radius:10px; font-size:0.6rem; font-weight:bold; margin-left:5px;">${v.activeTickets} TICKETS</span>`;
                }

                tr.innerHTML = `<td><strong>${v.id || 'N/A'}</strong></td><td><span class="db-badge">${v.vehicleType || 'Unknown'}</span></td><td>${v.homeLocation || '‚Äî'}</td><td style="font-family: 'JetBrains Mono';">${v.mileage ? v.mileage.toLocaleString() : '‚Äî'}</td><td>${formatDate(v.lastOilChange) || '‚Äî'}</td><td><span style="color:var(--text-muted);">${dispStatus || '‚Äî'}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        // --- MODALS ---
        function togglePartsFields() { document.getElementById('partsSection').style.display = (document.getElementById('vShopStatus').value === "Awaiting part order") ? "block" : "none"; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function getUsername() { return auth.currentUser ? auth.currentUser.email.split('@')[0] : "System"; }
        function createLogEntry(action, desc) { return { ts: Date.now(), user: getUsername(), action, desc }; }
        function parseHistory(j) { try { return j ? JSON.parse(j) : []; } catch(e) { return []; } }
        function renderHistoryLog(arr) {
            const list = document.getElementById('historyList');
            if(!arr || !arr.length) return list.innerHTML = '<div style="color:#555;text-align:center;">No history</div>';
            list.innerHTML = [...arr].sort((a,b)=>b.ts-a.ts).map(h => `<div class="history-item"><div class="h-time">${new Date(h.ts).toLocaleDateString()} ${new Date(h.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="h-user">${h.user}:</div><div>${h.desc}</div></div>`).join('');
        }

        function applyModalLocks(isViewer) {
            const form = document.getElementById('vehicleForm');
            form.querySelectorAll('input, select, textarea').forEach(el => el.disabled = isViewer);
            document.getElementById('saveBtn').style.display = isViewer ? 'none' : 'block';
            document.getElementById('deleteBtn').style.display = (currentUserRole === 'admin') ? 'block' : 'none';
        }

        function openModal(mode, id) {
            if (mode === 'add' && currentUserRole === 'viewer') return;
            document.getElementById('entryModal').style.display = 'flex';
            document.getElementById('mode').value = mode;
            
            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = "ADD NEW UNIT";
                document.getElementById('vehicleForm').reset();
                document.getElementById('vID').readOnly = false;
                document.getElementById('vDate').valueAsDate = new Date();
                document.getElementById('vPriority').value = 'Normal';
                document.getElementById('vStatus').value = 'Operational';
                document.getElementById('vShopStatus').value = 'Reported';
                document.getElementById('vLocation').value = 'Dispatch Lot';
                document.getElementById('historyList').innerHTML = '<div style="color:#555;text-align:center;">New ticket - no history</div>';
                document.getElementById('lastUpdatedBy').textContent = '';
                applyModalLocks(false);
                document.getElementById('deleteBtn').style.display = 'none'; 
                togglePartsFields();
            } else {
                document.getElementById('modalTitle').innerText = currentUserRole === 'viewer' ? "VIEW UNIT" : "EDIT UNIT";
                const v = fleetData.find(v => v.docId === id);
                if (v) {
                    document.getElementById('targetDocId').value = id;
                    document.getElementById('vID').value = v.baseVehicleId || v.id || '';
                    document.getElementById('vType').value = v.vehicleType || '';
                    document.getElementById('vPriority').value = v.priority || 'Normal';
                    document.getElementById('vStatus').value = v.status || 'Operational';
                    document.getElementById('vIssue').value = v.issue || '';
                    document.getElementById('vShopStatus').value = v.shopStatus || 'Reported';
                    document.getElementById('vLocation').value = v.location || 'Dispatch Lot';
                    document.getElementById('vOnTheRoad').checked = v.onTheRoad === true;
                    document.getElementById('vHomeLocation').value = v.homeLocation || '';
                    document.getElementById('vRequestedBy').value = v.requestedBy || '';
                    document.getElementById('vNotes').value = v.notes || '';
                    document.getElementById('vPartsOrdered').value = v.partsOrdered || '';
                    document.getElementById('vPartsEta').value = v.partsEta || '';
                    document.getElementById('vDate').value = v.date || '';
                    document.getElementById('vInspectionDate').value = v.inspectionDate || '';
                    document.getElementById('vHistory').value = v.history || '';
                    document.getElementById('vStatusUpdatedAt').value = v.statusUpdatedAt || '';

                    const hist = parseHistory(v.history);
                    renderHistoryLog(hist);
                    document.getElementById('lastUpdatedBy').textContent = hist.length ? `(Last: ${hist[hist.length-1].user})` : '';
                    
                    applyModalLocks(currentUserRole === 'viewer');
                    togglePartsFields();
                }
            }
        }

        function saveVehicle(e) {
            e.preventDefault();
            if(currentUserRole === 'viewer') return;
            const mode = document.getElementById('mode').value, docId = document.getElementById('targetDocId').value, btn = document.getElementById('saveBtn');
            const data = {
                id: document.getElementById('vID').value.trim(), vehicleType: document.getElementById('vType').value,
                priority: document.getElementById('vPriority').value, status: document.getElementById('vStatus').value,
                issue: document.getElementById('vIssue').value, shopStatus: document.getElementById('vShopStatus').value,
                location: document.getElementById('vLocation').value, onTheRoad: document.getElementById('vOnTheRoad').checked,
                homeLocation: document.getElementById('vHomeLocation').value, requestedBy: document.getElementById('vRequestedBy').value,
                notes: document.getElementById('vNotes').value, partsOrdered: document.getElementById('vPartsOrdered').value,
                partsEta: document.getElementById('vPartsEta').value, date: document.getElementById('vDate').value,
                inspectionDate: document.getElementById('vInspectionDate').value, lastUpdated: new Date().toISOString()
            };

            const oldTime = document.getElementById('vStatusUpdatedAt').value;
            const oldData = fleetData.find(v => v.docId === docId);
            if(mode === 'add' || (oldData && oldData.shopStatus !== data.shopStatus)) data.statusUpdatedAt = new Date().toISOString();
            else data.statusUpdatedAt = oldTime || new Date().toISOString();

            let histArr = parseHistory(document.getElementById('vHistory').value);
            let request;

            if (mode === 'add') {
                const existing = fleetData.find(v => String(v.id||'').toLowerCase() === String(data.id).toLowerCase() || v.docId === data.id);
                if (existing) {
                    histArr = parseHistory(existing.history);
                    histArr.push(createLogEntry('Ticket Created', 'Moved vehicle to active workboard'));
                    data.history = JSON.stringify(histArr);
                    data.sortOrder = Date.now(); 
                    request = db.collection('vehicles').doc(existing.docId).update(data);
                } else {
                    histArr.push(createLogEntry('Created', 'Ticket generated'));
                    data.history = JSON.stringify(histArr);
                    data.sortOrder = Date.now();
                    request = db.collection('vehicles').doc(data.id).set(data);
                }
            } else {
                if(oldData) {
                    if(oldData.shopStatus !== data.shopStatus) histArr.push(createLogEntry('Status', `Moved to ${data.shopStatus}`));
                    if(oldData.priority !== data.priority) histArr.push(createLogEntry('Priority', `Changed to ${data.priority}`));
                    if(oldData.notes !== data.notes && String(data.notes).length > String(oldData.notes||'').length) histArr.push(createLogEntry('Note', 'Note added/updated'));
                }
                
                if (oldData && oldData.isTicket === false && data.id !== docId) {
                    histArr.push(createLogEntry('ID Changed', `Changed ID from ${docId} to ${data.id}`));
                    data.history = JSON.stringify(histArr);
                    const newData = { ...(oldData || {}), ...data };
                    delete newData.docId;
                    request = db.collection('vehicles').doc(data.id).set(newData).then(() => db.collection('vehicles').doc(docId).delete());
                } else {
                    data.history = JSON.stringify(histArr);
                    if(data.isTicket) data.baseVehicleId = data.id;
                    request = db.collection('vehicles').doc(docId).update(data);
                }
            }

            btn.innerText = "Saving‚Ä¶"; btn.disabled = true; 
            request.then(() => { btn.innerText = "Save Ticket"; btn.disabled = false; closeModal('entryModal'); showToast("‚úì Saved successfully"); })
                   .catch(() => { btn.innerText = "Save Ticket"; btn.disabled = false; showToast("‚ùå Error saving"); });
        }

        function deleteCurrent() { 
            if(currentUserRole !== 'admin') return;
            if(confirm('Delete this unit?')) { db.collection('vehicles').doc(document.getElementById('targetDocId').value).delete(); closeModal('entryModal'); } 
        }

        function openDbModal(id) {
            document.getElementById('dbModal').style.display = 'flex';
            const v = fleetData.find(v => v.docId === id);
            const isViewer = currentUserRole === 'viewer';
            const form = document.querySelector('#dbModal form');
            form.querySelectorAll('input, textarea').forEach(el => el.disabled = isViewer);
            document.getElementById('dbSaveBtn').style.display = isViewer ? 'none' : 'block';
            document.getElementById('startRepairBtn').style.display = isViewer ? 'none' : 'block';

            if(v) {
                document.getElementById('dbTargetDocId').value = id;
                document.getElementById('dbID').value = v.id || '';
                document.getElementById('dbMileage').value = v.mileage || '';
                document.getElementById('dbOilChange').value = v.lastOilChange || '';
                document.getElementById('dbAccident').value = v.accidentHistory || '';
                document.getElementById('dbRepairs').value = v.longTermRepairs || '';
            }
        }

        function startRepairFromDb() {
            const docId = document.getElementById('dbTargetDocId').value;
            closeModal('dbModal');
            openModal('add'); 
            const statusSelect = document.getElementById('vShopStatus');
            if (statusSelect.value === 'Database Only' || statusSelect.value === 'Complete') statusSelect.value = 'Reported';
            document.getElementById('vIssue').value = '';
            document.getElementById('vNotes').value = '';
            document.getElementById('vDate').valueAsDate = new Date();
            document.getElementById('vPartsOrdered').value = '';
            document.getElementById('vPartsEta').value = '';
            showToast("Ready to create ticket. Fill in the issue and save.");
            setTimeout(() => document.getElementById('vIssue').focus(), 100);
        }

        function saveDbRecord(e) {
            e.preventDefault();
            if (currentUserRole === 'viewer') return;
            const docId = document.getElementById('dbTargetDocId').value, btn = document.getElementById('dbSaveBtn'), newId = document.getElementById('dbID').value.trim();
            const data = { id: newId, mileage: document.getElementById('dbMileage').value, lastOilChange: document.getElementById('dbOilChange').value, accidentHistory: document.getElementById('dbAccident').value, longTermRepairs: document.getElementById('dbRepairs').value };
            btn.innerText = "Saving..."; btn.disabled = true;
            let request = (newId !== docId) ? db.collection('vehicles').doc(newId).set({ ...(fleetData.find(v => v.docId === docId) || {}), ...data }).then(() => db.collection('vehicles').doc(docId).delete()) : db.collection('vehicles').doc(docId).update(data);
            request.then(() => { btn.innerText = "Save Record"; btn.disabled = false; closeModal('dbModal'); showToast("‚úì Database Record Updated"); })
                   .catch(() => { btn.innerText = "Save Record"; btn.disabled = false; showToast("‚ùå Error updating record"); });
        }

        function showToast(msg) { 
            document.querySelectorAll('.toast').forEach(e => e.remove()); 
            const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; 
            document.body.appendChild(t); setTimeout(() => t.remove(), 3000); 
        }
        
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal('entryModal'); closeModal('dbModal'); closeModal('syncLogModal'); closeModal('userModal'); closeModal('preferencesModal');} });
    </script>
</body>
</html>
